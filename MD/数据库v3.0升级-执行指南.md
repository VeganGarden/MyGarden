# æ•°æ®åº“ v3.0 å‡çº§ - æ‰§è¡ŒæŒ‡å—

> **å¼€å§‹æ‰§è¡Œæ—¶é—´**: 2025-10-15  
> **é¢„è®¡å®Œæˆæ—¶é—´**: 2-3 å°æ—¶  
> **æ‰§è¡Œäººå‘˜**: å¼€å‘å›¢é˜Ÿ

---

## ğŸ“‹ å‡çº§å‰æ£€æŸ¥æ¸…å•

### 1. ç¡®è®¤å½“å‰çŠ¶æ€

```bash
# æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬
tcb fn invoke database --params '{"action":"get-status"}'
```

**é¢„æœŸç»“æœ**: åº”è¯¥æ˜¾ç¤º `version: "v2.0"`

### 2. å¤‡ä»½ç°æœ‰æ•°æ®

```bash
# å¯¼å‡ºæ‰€æœ‰é›†åˆæ•°æ® (é‡è¦!)
tcb database:export users --envId your-env-id
tcb database:export orders --envId your-env-id
tcb database:export ingredients --envId your-env-id
tcb database:export recipes --envId your-env-id
# ... å¯¼å‡ºå…¶ä»–å…³é”®é›†åˆ
```

### 3. å‡†å¤‡äº‘å‡½æ•°

ç¡®è®¤ä»¥ä¸‹æ–‡ä»¶å·²åˆ›å»º:

- âœ… `cloudfunctions/database/init-collections-v3.js`
- âœ… `cloudfunctions/database/migrate-collections-v3.js`
- âœ… `cloudfunctions/database/index.js` (å·²æ›´æ–°)

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### Phase 1: éƒ¨ç½²æ›´æ–°çš„äº‘å‡½æ•° (5 åˆ†é’Ÿ)

```bash
cd /Users/zhangshichao/WeChatProjects/MyGarden

# éƒ¨ç½² database äº‘å‡½æ•°
tcb fn deploy database --dir ./cloudfunctions/database --force
```

**ç­‰å¾…éƒ¨ç½²å®Œæˆ** (é€šå¸¸éœ€è¦ 1-2 åˆ†é’Ÿ)

---

### Phase 2: åˆ›å»ºæ–°é›†åˆ (10 åˆ†é’Ÿ)

#### Step 1: é¢„è§ˆå‡çº§è®¡åˆ’

```bash
# æŸ¥çœ‹å½“å‰çŠ¶æ€
tcb fn invoke database --params '{"action":"get-status"}'
```

#### Step 2: åˆ›å»º v3.0 æ–°é›†åˆ

```bash
# åˆ›å»ºç”µå•†åŸŸ + è¿è¥åŸŸé›†åˆ (9ä¸ªæ–°é›†åˆ)
tcb fn invoke database --params '{"action":"init-v3"}'
```

**é¢„æœŸè¾“å‡º**:

```json
{
  "code": 0,
  "message": "æˆåŠŸåˆ›å»º 9 ä¸ªæ–°é›†åˆ",
  "summary": {
    "total": 9,
    "ecommerceDomain": 7,
    "operationDomain": 2
  }
}
```

**åˆ›å»ºçš„é›†åˆ**:

1. products - å•†å“ä¸»è¡¨
2. shopping_cart - è´­ç‰©è½¦
3. product_reviews - å•†å“è¯„ä»·
4. inventory - åº“å­˜ç®¡ç†
5. promotions - è¥é”€æ´»åŠ¨
6. coupons - ä¼˜æƒ åˆ¸
7. user_coupons - ç”¨æˆ·ä¼˜æƒ åˆ¸
8. data_dashboard - ç»Ÿä¸€æ•°æ®çœ‹æ¿
9. business_rules - ä¸šåŠ¡è§„åˆ™é…ç½®

#### Step 3: éªŒè¯é›†åˆåˆ›å»º

```bash
# å†æ¬¡æŸ¥çœ‹çŠ¶æ€
tcb fn invoke database --params '{"action":"get-status"}'
```

**é¢„æœŸç»“æœ**: åº”è¯¥çœ‹åˆ° v3.0 é›†åˆéƒ½æ˜¾ç¤º `exists: true`

---

### Phase 3: è¿ç§»ç°æœ‰é›†åˆ (20 åˆ†é’Ÿ)

#### Step 1: é¢„è§ˆè¿ç§»è®¡åˆ’

```bash
# æŸ¥çœ‹å°†è¦è¿›è¡Œçš„ä¿®æ”¹
tcb fn invoke database --params '{"action":"migrate-v3","params":{"action":"preview"}}'
```

**æŸ¥çœ‹è¾“å‡º**: ç¡®è®¤å°†è¦ä¿®æ”¹çš„é›†åˆå’Œå­—æ®µ

#### Step 2: æ‰§è¡Œè¿ç§»

```bash
# å¼€å§‹è¿ç§» (ä¸ºæ‰€æœ‰ç°æœ‰é›†åˆæ·»åŠ  v3.0 å­—æ®µ)
tcb fn invoke database --params '{"action":"migrate-v3","params":{"action":"migrate"}}'
```

**è¿™å°†æ‰©å±•ä»¥ä¸‹é›†åˆ**:

1. users - æ·»åŠ å•†åŸå…³è”ã€ç§¯åˆ†äº’é€šã€ä¹æ‚¦å­—æ®µ
2. user_profiles_extended - æ·»åŠ ä¹æ‚¦å®¢æˆ·ç”»åƒ
3. ingredients - æ·»åŠ ç”µå•†é“¾æ¥
4. recipes - æ·»åŠ ä¸€é”®è´­ä¹°åŠŸèƒ½
5. practitioners - æ·»åŠ å•†ä¸šåŒ–èƒ½åŠ›
6. daily_stats - æ·»åŠ è´­ç‰©æ•°æ®
7. orders - æ·»åŠ èŠ±å›­é›†æˆã€æ¨èã€åé¦ˆ

**é¢„æœŸè¾“å‡º**:

```json
{
  "code": 0,
  "message": "v3.0 è¿ç§»æˆåŠŸå®Œæˆ",
  "results": [
    { "collection": "users", "status": "success" },
    { "collection": "user_profiles_extended", "status": "success" },
    ...
  ]
}
```

#### Step 3: éªŒè¯è¿ç§»ç»“æœ

```bash
# æŸ¥çœ‹æœ€ç»ˆçŠ¶æ€
tcb fn invoke database --params '{"action":"get-status"}'
```

**é¢„æœŸç»“æœ**: version åº”è¯¥æ˜¾ç¤º `"v3.0"`

---

### Phase 4: é…ç½®ç´¢å¼• (30-60 åˆ†é’Ÿ)

#### æ–¹å¼ 1: äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»º (æ¨è)

1. ç™»å½•è…¾è®¯äº‘å¼€å‘æ§åˆ¶å°
2. è¿›å…¥"æ•°æ®åº“" â†’ é€‰æ‹©é›†åˆ â†’ "ç´¢å¼•ç®¡ç†"
3. æŒ‰ç…§ä¸‹è¡¨åˆ›å»ºç´¢å¼•

#### æ–°å¢ç´¢å¼•åˆ—è¡¨ (å…± 25 ä¸ª)

**products é›†åˆ** (10 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| productId | å‡åº | unique: true |
| category, status | å¤åˆå‡åº | - |
| linkedData.ingredientId | å‡åº | - |
| linkedData.certifiedByPractitioners.practitionerId | å‡åº | - |
| recommendTags.bodyTypes | å‡åº | - |
| recommendTags.solarTerms | å‡åº | - |
| salesData.totalSales | é™åº | - |
| salesData.rating | é™åº | - |
| status | å‡åº | - |
| name | æ–‡æœ¬ç´¢å¼• | - |

**shopping_cart é›†åˆ** (1 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| userId | å‡åº | unique: true |

**product_reviews é›†åˆ** (3 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| productId, rating | å¤åˆ | - |
| userId | å‡åº | - |
| isPractitioner, rating | å¤åˆ | - |

**inventory é›†åˆ** (3 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| productId, specId | å¤åˆå‡åº | unique: true |
| alert.isLowStock | å‡åº | - |
| alert.isOutOfStock | å‡åº | - |

**promotions é›†åˆ** (3 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| promotionId | å‡åº | unique: true |
| status, startTime | å¤åˆå‡åº | - |
| gardenTargeting.targetBodyTypes | å‡åº | - |

**coupons é›†åˆ** (2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| couponId | å‡åº | unique: true |
| status, endTime | å¤åˆå‡åº | - |

**user_coupons é›†åˆ** (2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| userId, status | å¤åˆå‡åº | - |
| code | å‡åº | unique: true |

**data_dashboard é›†åˆ** (2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| date, type | å¤åˆ(date é™åº, type å‡åº) | - |
| insights.priority | å‡åº | - |

**business_rules é›†åˆ** (2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| ruleId | å‡åº | unique: true |
| status, priority | å¤åˆ(status å‡åº, priority é™åº) | - |

**users é›†åˆ** (æ–°å¢ 3 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| ecommerce.customerLevel | å‡åº | - |
| ecommerce.rfm.monetary | é™åº | - |
| jiuyue.referralInfo.referralCode | å‡åº | - |

**ingredients é›†åˆ** (æ–°å¢ 1 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| ecommerceLink.availableProducts.productId | å‡åº | - |

**recipes é›†åˆ** (æ–°å¢ 2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| shoppingFeature.oneClickBuy.totalCost | å‡åº | - |
| monetization.isSponsored | å‡åº | - |

**practitioners é›†åˆ** (æ–°å¢ 1 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| commercialization.influence.trustScore | é™åº | - |

**orders é›†åˆ** (æ–°å¢ 2 ä¸ª):
| å­—æ®µ | ç±»å‹ | é€‰é¡¹ |
|------|------|------|
| gardenIntegration.syncedToGarden | å‡åº | - |
| recommendation.practitionerReferralId | å‡åº | - |

---

### Phase 5: æµ‹è¯•éªŒè¯ (15 åˆ†é’Ÿ)

#### Test 1: æŸ¥è¯¢æ–°é›†åˆ

```bash
# åœ¨äº‘å¼€å‘æ§åˆ¶å° æˆ– ä½¿ç”¨ tcb CLI
# æµ‹è¯• products é›†åˆ
db.collection('products').limit(1).get()

# æµ‹è¯• shopping_cart é›†åˆ
db.collection('shopping_cart').limit(1).get()
```

#### Test 2: éªŒè¯å­—æ®µæ‰©å±•

```bash
# æŸ¥è¯¢ä¸€ä¸ªç”¨æˆ·,ç¡®è®¤æ–°å­—æ®µå­˜åœ¨
db.collection('users').limit(1).get()
# åº”è¯¥çœ‹åˆ°: ecommerce, pointsSystem, jiuyue å­—æ®µ

# æŸ¥è¯¢ä¸€ä¸ªè®¢å•,ç¡®è®¤æ–°å­—æ®µå­˜åœ¨
db.collection('orders').limit(1).get()
# åº”è¯¥çœ‹åˆ°: gardenIntegration, recommendation, userFeedback å­—æ®µ
```

#### Test 3: æœ€ç»ˆçŠ¶æ€æ£€æŸ¥

```bash
# ç¡®è®¤æœ€ç»ˆç‰ˆæœ¬
tcb fn invoke database --params '{"action":"get-status"}'
```

**æˆåŠŸæ ‡å‡†**:

```json
{
  "version": "v3.0",
  "summary": {
    "v1": { "total": 14, "complete": true },
    "v2": { "total": 7, "complete": true },
    "v3": { "total": 9, "complete": true }
  }
}
```

---

## âš ï¸ æ•…éšœæ’é™¤

### é—®é¢˜ 1: äº‘å‡½æ•°éƒ¨ç½²å¤±è´¥

**ç—‡çŠ¶**: `tcb fn deploy` æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:

```bash
# é‡æ–°ç™»å½•
tcb login

# ç¡®è®¤ç¯å¢ƒIDæ­£ç¡®
tcb env:list

# é‡è¯•éƒ¨ç½²
tcb fn deploy database --dir ./cloudfunctions/database --force
```

### é—®é¢˜ 2: é›†åˆåˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**: `init-v3` è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥äº‘å¼€å‘ç¯å¢ƒé…é¢æ˜¯å¦è¶³å¤Ÿ
2. æ‰‹åŠ¨åœ¨æ§åˆ¶å°åˆ›å»ºé›†åˆ
3. é‡è¯•æ‰§è¡Œ

### é—®é¢˜ 3: è¿ç§»å¤±è´¥

**ç—‡çŠ¶**: `migrate-v3` è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:

```bash
# å›æ»šåˆ°è¿ç§»å‰çŠ¶æ€
tcb fn invoke database --params '{"action":"migrate-v3","params":{"action":"rollback"}}'

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
# ç„¶åé‡è¯•è¿ç§»
```

### é—®é¢˜ 4: ç´¢å¼•åˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**: æ§åˆ¶å°åˆ›å»ºç´¢å¼•æŠ¥é”™

**è§£å†³æ–¹æ¡ˆ**:

1. ç¡®ä¿é›†åˆæœ‰æ•°æ®(å¯ä»¥å…ˆæ·»åŠ ä¸€æ¡æµ‹è¯•æ•°æ®)
2. æ£€æŸ¥ç´¢å¼•å­—æ®µåæ˜¯å¦æ­£ç¡®
3. å”¯ä¸€ç´¢å¼•éœ€è¦ç¡®ä¿æ•°æ®æ— é‡å¤

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡çº§å‡ºç°ä¸¥é‡é—®é¢˜,å¯ä»¥å›æ»š:

### å›æ»šæ­¥éª¤

```bash
# 1. å›æ»šå­—æ®µæ‰©å±•
tcb fn invoke database --params '{"action":"migrate-v3","params":{"action":"rollback"}}'

# 2. åˆ é™¤æ–°åˆ›å»ºçš„é›†åˆ (å¯é€‰,å¦‚æœéœ€è¦å®Œå…¨å›æ»š)
# æ‰‹åŠ¨åœ¨æ§åˆ¶å°åˆ é™¤ v3.0 æ–°å»ºçš„ 9 ä¸ªé›†åˆ

# 3. æ¢å¤å¤‡ä»½æ•°æ® (å¦‚æœæœ‰æ•°æ®æŸå)
tcb database:import users --envId your-env-id --file users_backup.json
```

---

## âœ… å‡çº§å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ
- [ ] 9 ä¸ªæ–°é›†åˆåˆ›å»ºæˆåŠŸ
- [ ] 7 ä¸ªç°æœ‰é›†åˆæ‰©å±•æˆåŠŸ
- [ ] 25 ä¸ªæ–°ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [ ] æ•°æ®åº“çŠ¶æ€æ˜¾ç¤º v3.0
- [ ] æµ‹è¯•æŸ¥è¯¢æ­£å¸¸
- [ ] å¤‡ä»½æ•°æ®å·²ä¿å­˜

---

## ğŸ“ å‡çº§è®°å½•

| æ—¶é—´       | æ“ä½œ         | æ‰§è¡Œäºº | ç»“æœ | å¤‡æ³¨ |
| ---------- | ------------ | ------ | ---- | ---- |
| 2025-10-15 | äº‘å‡½æ•°éƒ¨ç½²   | -      | -    | -    |
| 2025-10-15 | åˆ›å»ºæ–°é›†åˆ   | -      | -    | -    |
| 2025-10-15 | è¿ç§»ç°æœ‰é›†åˆ | -      | -    | -    |
| 2025-10-15 | é…ç½®ç´¢å¼•     | -      | -    | -    |
| 2025-10-15 | æµ‹è¯•éªŒè¯     | -      | -    | -    |

---

## ğŸ‰ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å‡çº§å®Œæˆå,è¯·å‚è€ƒ:

1. **ä¸šåŠ¡å¯¹æ¥**: `Docs/æ•°æ®åº“æ¶æ„å‡çº§æ–¹æ¡ˆv3.0-ä¹æ‚¦èåˆç‰ˆ.md`
2. **äº‘å‡½æ•°å¼€å‘**: å¼€å‘å•†åŸç›¸å…³äº‘å‡½æ•° (product-recommend, order-sync ç­‰)
3. **å‰ç«¯é€‚é…**: å°ç¨‹åºå‰ç«¯å¯¹æ¥æ–°çš„æ•°æ®ç»“æ„
4. **æ•°æ®å¯¼å…¥**: å¯¼å…¥ä¹æ‚¦ç°æœ‰å•†å“å’Œè®¢å•æ•°æ®

---

**å‡çº§æ‰§è¡Œè´Ÿè´£äºº**: ****\_\_****  
**æ—¥æœŸ**: 2025-10-15  
**ç­¾å­—**: ****\_\_****
