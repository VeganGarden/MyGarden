# æ•°æ®åº“ v4.0 å‡çº§ - æ‰§è¡ŒæŒ‡å—

> **ğŸš€ ä»"ç”Ÿæ€é—­ç¯"åˆ°"ç¤¾ä¼šå¹³å°"**  
> **ğŸ“… æ‰§è¡Œæ—¥æœŸ**: 2025-10-15  
> **â± é¢„è®¡æ—¶é•¿**: çº¦ 30 åˆ†é’Ÿ  
> **âœ¨ å‡çº§å†…å®¹**: æ–°å¢ 15 ä¸ªé›†åˆ, èå…¥æ°”å€™é¤å…ä¸ç¢³æ™®æƒ 

---

## ğŸ“‹ å‡çº§æ£€æŸ¥æ¸…å•

### å‰ç½®æ¡ä»¶

- [x] v3.0 å‡çº§å·²å®Œæˆ (30 ä¸ªé›†åˆå…¨éƒ¨å­˜åœ¨)
- [x] database äº‘å‡½æ•°å·²éƒ¨ç½²
- [x] ç¯å¢ƒ ID: my-garden-app-env-4e0h762923be2f
- [x] å·²å®‰è£… @cloudbase/cli

### ç¯å¢ƒå‡†å¤‡

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export CLOUDBASE_ENVID=my-garden-app-env-4e0h762923be2f

# éªŒè¯å½“å‰æ•°æ®åº“ç‰ˆæœ¬
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"get-status"}'
# åº”è¿”å›: "version":"v3.0"
```

---

## ğŸ”§ æ‰§è¡Œæ­¥éª¤

### Step 1: éƒ¨ç½²æ›´æ–°åçš„ database äº‘å‡½æ•°

```bash
# ç¡®ä¿åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /Users/zhangshichao/WeChatProjects/MyGarden

# éƒ¨ç½² database äº‘å‡½æ•°
tcb fn deploy database --dir ./cloudfunctions/database -e $CLOUDBASE_ENVID --force
```

**é¢„æœŸç»“æœ**: âœ” [database] äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸï¼

---

### Step 2: åˆ›å»º v4.0 æ–°é›†åˆ (15 ä¸ª)

```bash
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"init-v4"}'
```

**æ‰§è¡Œå†…å®¹**:

- âœ… é¤å…åŸŸ 8 ä¸ªé›†åˆ
- âœ… ç¢³æ™®æƒ åŸŸ 4 ä¸ªé›†åˆ
- âœ… æ”¿åºœåˆä½œåŸŸ 3 ä¸ªé›†åˆ

**é¢„æœŸç»“æœ**:

```json
{
  "code": 0,
  "message": "v4.0 æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ - åˆ›å»º 15 ä¸ªæ–°é›†åˆ",
  "summary": {
    "total": 15,
    "restaurantDomain": 8,
    "carbonInclusiveDomain": 4,
    "governmentDomain": 3
  }
}
```

**æ–°å¢é›†åˆ**:

**é¤å…åŸŸ**:

1. `restaurants` - é¤å…ä¸»è¡¨
2. `restaurant_menus` - é¤å…èœå•
3. `restaurant_menu_items` - èœå“æ˜ç»†
4. `restaurant_orders` - é¤å…è®¢å•
5. `restaurant_reservations` - é¤å…é¢„è®¢
6. `restaurant_members` - é¤å…ä¼šå‘˜
7. `restaurant_campaigns` - é¤å…è¥é”€
8. `restaurant_reviews` - é¤å…è¯„ä»·

**ç¢³æ™®æƒ åŸŸ**: 9. `carbon_credits` - ç¢³ç§¯åˆ†è´¦æˆ· 10. `carbon_transactions` - ç¢³ç§¯åˆ†äº¤æ˜“ 11. `carbon_exchange_records` - ç¢³äº¤æ˜“æ‰€å¯¹æ¥ 12. `carbon_milestones` - ç¢³å‡æ’é‡Œç¨‹ç¢‘

**æ”¿åºœåˆä½œåŸŸ**: 13. `government_programs` - æ”¿åºœæ¿€åŠ±é¡¹ç›® 14. `public_participation` - å…¬ä¼—å‚ä¸è®°å½• 15. `esg_reports` - ESG å½±å“åŠ›æŠ¥å‘Š

---

### Step 3: æ‰©å±•ç°æœ‰é›†åˆå­—æ®µ

```bash
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"migrate-v4"}'
```

**æ‰©å±•é›†åˆ**:

- âœ… `users` - æ–°å¢é¤å…åå¥½ã€ç¢³å‡æ’ç”»åƒ
- âœ… `daily_stats` - æ–°å¢é¤å…å°±é¤ç»Ÿè®¡
- âœ… `data_dashboard` - æ–°å¢é¤å…å’Œç¢³æ™®æƒ æŒ‡æ ‡
- âœ… `practitioners` - æ–°å¢é¤å…æ¨èèƒ½åŠ›

**é¢„æœŸç»“æœ**: æˆåŠŸæ‰©å±• 4 ä¸ªé›†åˆ

---

### Step 4: å¯¼å…¥ v4.0 ç¤ºä¾‹æ•°æ®

```bash
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"seed-v4-data"}'
```

**å¯¼å…¥å†…å®¹**:

- âœ… 3 å®¶æ°”å€™é¤å… (é‡‘ç‰Œ/é“¶ç‰Œ/é“œç‰Œ)
- âœ… 3 ä¸ªä½ç¢³èœå“
- âœ… 3 ä¸ªç¢³å‡æ’é‡Œç¨‹ç¢‘
- âœ… 1 ä¸ªæ”¿åºœé¡¹ç›®
- âœ… 1 æ¡é¤å…è®¢å•
- âœ… 1 ä¸ªç¢³ç§¯åˆ†è´¦æˆ·

**æ€»è®¡**: 12 æ¡ç¤ºä¾‹æ•°æ®

**é¢„æœŸç»“æœ**: v4.0 ç¤ºä¾‹æ•°æ®å¯¼å…¥æˆåŠŸ - å…± 12 æ¡

---

### Step 5: éªŒè¯å‡çº§ç»“æœ

```bash
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"get-status"}'
```

**é¢„æœŸç»“æœ**:

```json
{
  "version": "v4.0",
  "summary": {
    "v1": { "total": 14, "complete": true },
    "v2": { "total": 7, "complete": true },
    "v3": { "total": 9, "complete": true },
    "v4": { "total": 15, "complete": true }
  }
}
```

**å…³é”®æ•°æ®é‡æ£€æŸ¥**:

- restaurants: 3 æ¡ âœ…
- restaurant_menu_items: 3 æ¡ âœ…
- restaurant_orders: 1 æ¡ âœ…
- carbon_credits: 1 æ¡ âœ…
- carbon_milestones: 3 æ¡ âœ…
- government_programs: 1 æ¡ âœ…

---

## ğŸ“Š æ•°æ®éªŒè¯

### éªŒè¯ 1: æŸ¥çœ‹æ°”å€™é¤å…

åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰§è¡Œ:

```javascript
db.collection("restaurants")
  .where({ "climateCertification.isCertified": true })
  .get();
```

**é¢„æœŸ**: è¿”å› 3 å®¶é¤å…

### éªŒè¯ 2: æŸ¥çœ‹ä½ç¢³èœå“

```javascript
db.collection("restaurant_menu_items")
  .where({ "carbonData.carbonLabel": db.command.in(["ultra_low", "low"]) })
  .get();
```

**é¢„æœŸ**: è¿”å› 3 ä¸ªèœå“

### éªŒè¯ 3: æŸ¥çœ‹ç¢³ç§¯åˆ†è´¦æˆ·

```javascript
db.collection("carbon_credits").get();
```

**é¢„æœŸ**: è¿”å› 1 ä¸ªè´¦æˆ·, æ€»ç§¯åˆ† 1520

### éªŒè¯ 4: æŸ¥çœ‹æ”¿åºœé¡¹ç›®

```javascript
db.collection("government_programs").where({ status: "active" }).get();
```

**é¢„æœŸ**: è¿”å›æ­å·å¸‚ç¢³æ™®æƒ è¯•ç‚¹é¡¹ç›®

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç´¢å¼•é…ç½®

**æ‰€æœ‰ç´¢å¼•éœ€è¦åœ¨äº‘å¼€å‘æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºï¼**

**æ–°å¢ç´¢å¼•**: çº¦ 50 ä¸ª

**ä¼˜å…ˆçº§**:

- ğŸ”´ P0 (15 ä¸ª) - ä»Šå¤©å¿…åš - å”¯ä¸€ç´¢å¼•
- ğŸŸ¡ P1 (30 ä¸ª) - æœ¬å‘¨å®Œæˆ - å¸¸ç”¨ç´¢å¼•
- ğŸŸ¢ P2 (5 ä¸ª) - æœ¬æœˆå®Œæˆ - ä¼˜åŒ–ç´¢å¼•

**é…ç½®æ–‡æ¡£**: `Docs/æ•°æ®åº“ç´¢å¼•é…ç½®v4.0.md`

**å¿«é€Ÿé…ç½®**: `Docs/ç´¢å¼•åˆ›å»º-å¤åˆ¶ç²˜è´´ç‰ˆv4.0.md`

### äº‘å‡½æ•°éƒ¨ç½² (å¯é€‰)

v4.0 æ–°å¢äº† 2 ä¸ªäº‘å‡½æ•°:

```bash
# é¤å…è®¢å•åŒæ­¥
tcb fn deploy restaurant-order-sync --dir ./cloudfunctions/restaurant-order-sync -e $CLOUDBASE_ENVID --force

# é¤å…æ¨èå¼•æ“
tcb fn deploy restaurant-recommend --dir ./cloudfunctions/restaurant-recommend -e $CLOUDBASE_ENVID --force
```

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

**æ•°æ®åº“å‡çº§**:

- [x] 45 ä¸ªé›†åˆå…¨éƒ¨å­˜åœ¨
- [x] æ•°æ®åº“ç‰ˆæœ¬æ˜¾ç¤º v4.0
- [x] 12 æ¡ç¤ºä¾‹æ•°æ®å¯¼å…¥æˆåŠŸ

**åŠŸèƒ½éªŒè¯**:

- [ ] å¯ä»¥æŸ¥è¯¢æ°”å€™é¤å…
- [ ] å¯ä»¥æŸ¥è¯¢ä½ç¢³èœå“
- [ ] ç¢³ç§¯åˆ†è´¦æˆ·æ­£å¸¸å·¥ä½œ
- [ ] æ”¿åºœé¡¹ç›®æ•°æ®å®Œæ•´

**è¿ç»´å‡†å¤‡**:

- [ ] ç´¢å¼•é…ç½®å®Œæˆ (50 ä¸ª)
- [ ] äº‘å‡½æ•°éƒ¨ç½²å®Œæˆ (2 ä¸ª)
- [ ] æ–‡æ¡£ä½“ç³»å®Œå–„

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é›†åˆåˆ›å»ºå¤±è´¥

**ç°è±¡**: init-v4 è¿”å›é”™è¯¯

**åŸå› **:

- äº‘å‡½æ•°è¶…æ—¶
- æƒé™ä¸è¶³
- é›†åˆåç§°å†²çª

**è§£å†³**:

- æ£€æŸ¥äº‘å‡½æ•°æ—¥å¿—
- æ‰‹åŠ¨åœ¨æ§åˆ¶å°åˆ›å»ºé›†åˆ
- æ£€æŸ¥é›†åˆæ˜¯å¦å·²å­˜åœ¨

### é—®é¢˜ 2: ç¤ºä¾‹æ•°æ®å¯¼å…¥å¤±è´¥

**ç°è±¡**: seed-v4-data è¿”å›é”™è¯¯

**åŸå› **:

- ç¼ºå°‘å…³è”æ•°æ®
- å­—æ®µæ ¼å¼é”™è¯¯
- æ•°æ®é‡å¤

**è§£å†³**:

- æ£€æŸ¥æ˜¯å¦å…ˆæ‰§è¡Œäº† init-v4
- æ£€æŸ¥æ—¥å¿—ä¸­çš„å…·ä½“é”™è¯¯
- å¯ä»¥é‡å¤æ‰§è¡Œ (è„šæœ¬å…·æœ‰å¹‚ç­‰æ€§)

### é—®é¢˜ 3: ç‰ˆæœ¬æ˜¾ç¤ºä¸æ˜¯ v4.0

**ç°è±¡**: get-status è¿”å› v3.0

**åŸå› **:

- æŸäº› v4.0 é›†åˆæœªåˆ›å»ºæˆåŠŸ
- é›†åˆåç§°é”™è¯¯

**è§£å†³**:

```bash
# å†æ¬¡æ‰§è¡Œåˆå§‹åŒ–
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"init-v4"}'

# æ£€æŸ¥å…·ä½“å“ªä¸ªé›†åˆç¼ºå¤±
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"get-status"}' | grep "false"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£                                  | ç”¨é€”     | ä¼˜å…ˆçº§     |
| ------------------------------------- | -------- | ---------- |
| æ•°æ®åº“æ¶æ„å‡çº§æ–¹æ¡ˆ v4.0-æ°”å€™é¤å…ç‰ˆ.md | å®Œæ•´æ–¹æ¡ˆ | â­â­â­â­â­ |
| æ•°æ®åº“ v4.0 å‡çº§-æ‰§è¡ŒæŒ‡å—.md (æœ¬æ–‡æ¡£) | æ“ä½œæ‰‹å†Œ | â­â­â­â­â­ |
| æ•°æ®åº“ç´¢å¼•é…ç½® v4.0.md                | ç´¢å¼•é…ç½® | â­â­â­â­   |
| v4.0 ç¤ºä¾‹æ•°æ®è¯´æ˜.md                  | æ•°æ®è¯¦è§£ | â­â­â­â­   |

---

## ğŸŠ å®Œæˆ

**å‡çº§å®Œæˆå**, æ‚¨çš„æ•°æ®åº“å°†æ‹¥æœ‰:

- âœ… **45 ä¸ªé›†åˆ** (v1: 14 + v2: 7 + v3: 9 + v4: 15)
- âœ… **11 ä¸ªæ•°æ®åŸŸ** (ç”¨æˆ·/ç¢³è¶³è¿¹/èŠ±å›­/ç”µå•†/åŸºç¡€æ•°æ®/æ™ºæ…§/è¿è¥/ç¤¾äº¤/åŒæ­¥/é¤å…/ç¢³æ™®æƒ +æ”¿åºœ)
- âœ… **440+ æ¡æ•°æ®** (åŒ…æ‹¬ 12 æ¡ v4.0 ç¤ºä¾‹æ•°æ®)
- âœ… **4 å¤§ä¸šæ€** (èŠ±å›­ + å•†åŸ + é¤å… + ç¢³æ™®æƒ )

**ä¸‹ä¸€æ­¥**:

1. é…ç½® 50+ ä¸ªç´¢å¼• â†’ `Docs/ç´¢å¼•åˆ›å»º-å¤åˆ¶ç²˜è´´ç‰ˆv4.0.md`
2. éƒ¨ç½²æ–°äº‘å‡½æ•° â†’ `restaurant-order-sync`, `restaurant-recommend`
3. å¼€å‘é¤å…å°ç¨‹åºé¡µé¢
4. å¯¹æ¥æ”¿åºœç¢³æ™®æƒ é¡¹ç›®

---

**ğŸŒ± è®©æ¯ä¸€é¤éƒ½æˆä¸ºæ”¹å˜ä¸–ç•Œçš„åŠ›é‡ï¼**

---

**æœ€åæ›´æ–°**: 2025-10-15  
**çŠ¶æ€**: âœ… å¯æ‰§è¡Œ
