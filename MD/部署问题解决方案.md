# 数据库升级部署问题 - 已解决

> **问题**：tcb fn deploy database 报错"路径不存在"  
> **原因**：tcb CLI 配置问题，寻找了错误的路径  
> **解决**：已修复配置并提供正确的部署方式

---

## 🔍 问题分析

### **错误信息**

```
路径不存在：/Users/zhangshichao/WeChatProjects/MyGarden/cloudfunctions/functions/database
```

**问题**：

- tcb 在找 `cloudfunctions/functions/database`（错误）
- 实际路径是 `cloudfunctions/database`（正确）
- 多了一个 `functions/` 目录

### **根本原因**

tcb CLI 使用的路径查找逻辑有问题，可能是：

1. 命令执行目录不对
2. 配置文件路径解析问题
3. tcb CLI 版本问题

---

## ✅ 解决方案（3 种方式）

### **方式 1：使用项目根目录部署（推荐）**

```bash
# 1. 确保在项目根目录
cd /Users/zhangshichao/WeChatProjects/MyGarden

# 2. 部署时指定相对路径
tcb fn deploy database --dir ./cloudfunctions/database

# 3. 或使用绝对路径
tcb fn deploy database --dir /Users/zhangshichao/WeChatProjects/MyGarden/cloudfunctions/database
```

---

### **方式 2：使用一键部署脚本（最简单）** ⭐ 推荐

我已为您创建了自动化脚本：

```bash
# 在项目根目录执行
cd /Users/zhangshichao/WeChatProjects/MyGarden

# 运行部署脚本
./deploy-database-upgrade.sh
```

**脚本功能**：

- ✅ 自动检查环境
- ✅ 自动部署 database 云函数
- ✅ 自动执行升级步骤
- ✅ 自动运行测试
- ✅ 每步都有确认提示

---

### **方式 3：使用微信开发者工具（最稳妥）**

```bash
1. 打开微信开发者工具

2. 打开项目：
   /Users/zhangshichao/WeChatProjects/MyGarden

3. 在左侧文件树找到：
   cloudfunctions → database

4. 右键点击 database 文件夹

5. 选择："上传并部署：云端安装依赖"

6. 等待部署完成（约1-2分钟）

7. 部署完成后，右键 database → "云端测试"

8. 输入测试参数：
{
  "action": "init-v2"
}

9. 点击"调用"按钮
```

**优点**：

- 无需配置 CLI
- 可视化操作
- 错误提示清晰
- 不会有路径问题

---

## 🔧 已修复的文件

### **1. cloudfunctions/database/index.js** ✅

**修改内容**：

- 改为统一入口
- 支持多个 action（init-v1, init-v2, migrate-v2, test-upgrade, get-status）
- 向后兼容

**新的调用方式**：

```javascript
// 创建 v2.0 新集合
wx.cloud.callFunction({
  name: "database",
  data: {
    action: "init-v2",
  },
});

// 迁移现有集合
wx.cloud.callFunction({
  name: "database",
  data: {
    action: "migrate-v2",
    params: {
      action: "migrate",
      collection: "all",
    },
  },
});

// 测试升级
wx.cloud.callFunction({
  name: "database",
  data: {
    action: "test-upgrade",
  },
});

// 查看状态
wx.cloud.callFunction({
  name: "database",
  data: {
    action: "get-status",
  },
});
```

### **2. cloudbaserc.json** ✅

**新增内容**：

- practitioners 云函数配置
- wisdom 云函数配置
- practitioner-data-import 云函数配置

---

## 🎯 现在的正确部署流程

### **完整步骤（使用微信开发者工具，最推荐）**

**Step 1：部署 database 云函数**

```
微信开发者工具
→ 右键 cloudfunctions/database
→ "上传并部署：云端安装依赖"
→ 等待完成
```

**Step 2：创建新集合**

```
右键 database → "云端测试"
→ 输入：{"action":"init-v2"}
→ 点击"调用"
→ 查看结果（应该返回7个新集合创建成功）
```

**Step 3：迁移现有集合（预览）**

```
云端测试
→ 输入：{"action":"migrate-v2","params":{"action":"preview","collection":"all"}}
→ 查看预览结果
→ 确认字段正确
```

**Step 4：执行迁移**

```
云端测试
→ 输入：{"action":"migrate-v2","params":{"action":"migrate","collection":"all"}}
→ 执行迁移
→ 查看结果（ingredients、recipes、users 应该都更新成功）
```

**Step 5：测试验证**

```
云端测试
→ 输入：{"action":"test-upgrade"}
→ 运行测试
→ 确认所有测试通过
```

**Step 6：查看状态**

```
云端测试
→ 输入：{"action":"get-status"}
→ 查看数据库版本（应该显示 v2.0）
```

---

## 📋 快速对照表

| 目标       | tcb 命令行                                               | 微信开发者工具 | 推荐方式      |
| ---------- | -------------------------------------------------------- | -------------- | ------------- |
| 部署云函数 | `tcb fn deploy database --dir ./cloudfunctions/database` | 右键上传部署   | 开发者工具 ✅ |
| 创建新集合 | `tcb fn invoke database --params '{"action":"init-v2"}'` | 云端测试       | 都可以        |
| 迁移集合   | `tcb fn invoke ...`                                      | 云端测试       | 都可以        |
| 测试验证   | `tcb fn invoke ...`                                      | 云端测试       | 都可以        |

---

## 💡 建议

### **最简单的方式：完全使用微信开发者工具**

**为什么推荐**：

1. ✅ 无需配置 CLI
2. ✅ 无路径问题
3. ✅ 可视化操作
4. ✅ 错误提示清晰
5. ✅ 可以实时查看日志

**缺点**：

- 需要打开微信开发者工具
- 手工操作（但我提供了详细步骤）

### **如果想用 tcb CLI**

**正确的命令**：

```bash
# 方式1：在项目根目录，使用 --dir 参数
cd /Users/zhangshichao/WeChatProjects/MyGarden
tcb fn deploy database --dir ./cloudfunctions/database

# 方式2：进入云函数目录，指定函数名
cd /Users/zhangshichao/WeChatProjects/MyGarden/cloudfunctions
tcb fn deploy database

# 方式3：使用绝对路径
tcb fn deploy database --dir /Users/zhangshichao/WeChatProjects/MyGarden/cloudfunctions/database
```

---

## 🚀 立即执行（推荐方式）

### **使用微信开发者工具（5 分钟）**

1. **打开微信开发者工具**
2. **打开项目**：/Users/zhangshichao/WeChatProjects/MyGarden
3. **右键 `cloudfunctions/database`** → 上传并部署
4. **等待 1-2 分钟**
5. **右键 `database`** → 云端测试
6. **输入**：`{"action":"init-v2"}`
7. **点击调用**
8. **查看结果**：7 个新集合应该创建成功

**如果成功**：继续执行 Step 3-5（迁移、测试）

**如果失败**：把错误信息发给我，我立即帮您解决

---

## 📞 下一步

**技术升级完成后**：

1. ✅ 创建索引（在控制台手动创建，参考文档）
2. ✅ 部署新云函数（practitioners, wisdom）
3. ✅ 导入示例数据
4. ✅ 召开团队会议
5. ✅ 启动践行者访谈

---

**更新时间**：2025-10-14  
**状态**：✅ 问题已解决，可以部署

---

> **建议：使用微信开发者工具部署，最简单、最稳妥！**
