# 数据库 v4.0 - 快速参考

> **🎉 v4.0 升级完成！社会化减碳行动平台**  
> **📅 升级时间**: 2025-10-15  
> **✅ 状态**: 集合已就绪, 索引待配置

---

## 📋 一分钟了解 v4.0

### 版本演进

```
v1.0 → v2.0 → v3.0 → v4.0
14集合 → 21集合 → 30集合 → 45集合
工具 → 智慧 → 闭环 → 社会平台
```

### 核心升级

**v4.0 = 花园 + 商城 + 气候餐厅 + 碳普惠**

```
知识学习 + 精准购物 + 外出就餐 + 社会激励 = 完整社会化减碳平台
```

---

## 🚀 快速命令

### 查看数据库状态

```bash
export CLOUDBASE_ENVID=my-garden-app-env-4e0h762923be2f
tcb fn invoke database -e $CLOUDBASE_ENVID --params '{"action":"get-status"}'
```

**预期结果**: `"version": "v4.0"`

### 餐厅推荐 (需先配置索引)

```bash
tcb fn invoke restaurant-recommend -e $CLOUDBASE_ENVID --params '{"scene":"nearby","latitude":30.27,"longitude":120.15"}'
```

### 餐厅订单同步

```bash
tcb fn invoke restaurant-order-sync -e $CLOUDBASE_ENVID --params '{"orderId":"RO-20251015001"}'
```

---

## 📂 数据库结构

### v4.0 完整集合 (45 个)

#### 🆕 餐厅域 (8 个)

```
restaurants ✨              - 气候餐厅 (3家)
restaurant_menus ✨         - 餐厅菜单
restaurant_menu_items ✨    - 低碳菜品 (3个)
restaurant_orders ✨        - 餐厅订单 (1条)
restaurant_reservations ✨  - 餐厅预订
restaurant_members ✨       - 餐厅会员
restaurant_campaigns ✨     - 餐厅营销
restaurant_reviews ✨       - 餐厅评价
```

#### 🆕 碳普惠域 (4 个)

```
carbon_credits ✨           - 碳积分账户 (1个)
carbon_transactions ✨      - 碳积分交易
carbon_exchange_records ✨  - 碳交易所对接
carbon_milestones ✨        - 碳减排里程碑 (3个)
```

#### 🆕 政府合作域 (3 个)

```
government_programs ✨      - 政府项目 (1个)
public_participation ✨     - 公众参与
esg_reports ✨              - ESG 报告
```

#### v3.0 已有 (30 个)

**用户域** (3 个), **碳足迹域** (2 个), **花园域** (2 个),  
**电商域** (7 个), **基础数据域** (3 个), **智慧域** (6 个),  
**运营域** (2 个), **社交域** (2 个), **同步域** (2 个), **商城域** (1 个)

✨ = v4.0 新增

---

## 🔥 核心功能

### 功能 1: 气候餐厅认证

**四级认证体系**:

- 🥉 铜牌 (低碳菜品 >30%)
- 🥈 银牌 (低碳菜品 >50%)
- 🥇 金牌 (低碳菜品 >70%)
- 💎 钻石 (低碳菜品 >90%)

**云函数**: restaurant-recommend

### 功能 2: 低碳菜单推荐

**多维度推荐**:

- ✅ 体质匹配
- ✅ 24 节气
- ✅ 碳标识 (超低碳/低碳/中碳)
- ✅ 践行者认证

### 功能 3: 餐厅订单 → 花园同步

**数据流动**:

```
用户就餐 → 餐厅订单 → 计算碳减排 →
发放碳积分 → 同步到花园 → 浇灌植物
```

**云函数**: restaurant-order-sync

### 功能 4: 碳积分统一账户

**三源合一**:

- 花园积分 (在家烹饪)
- 商城积分 (九悦购物)
- 餐厅积分 (外出就餐)

**数据表**: carbon_credits

### 功能 5: 政府碳普惠

**社会化激励**:

```
碳减排 → 碳积分 → 碳交易所 → 政府核证 →
用户奖励 + 餐厅补贴 + 公共权益
```

**数据表**: government_programs

---

## ⏳ 待完成工作

### 🔴 P0 - 今天必做 (45 分钟)

**配置 15 个核心唯一索引**

| 集合                    | 索引字段            |
| ----------------------- | ------------------- |
| restaurants             | restaurantId        |
| restaurant_menu_items   | menuItemId          |
| restaurant_orders       | orderId             |
| restaurant_reservations | reservationId       |
| restaurant_members      | userId+restaurantId |
| restaurant_campaigns    | campaignId          |
| carbon_credits          | userId              |
| carbon_transactions     | transactionId       |
| carbon_milestones       | milestoneId         |
| carbon_exchange_records | recordId            |
| government_programs     | programId           |
| public_participation    | recordId            |
| esg_reports             | reportId            |

**配置地址**: https://console.cloud.tencent.com/tcb

**参考文档**: `Docs/数据库索引配置v4.0.md`

### 🟡 P1 - 本周完成 (2-3 小时)

配置其余 80 个索引 (v3.0: 37 + v4.0: 43)

### 🟢 P2 - 本月完成

1. 部署新云函数
2. 招募试点餐厅
3. 对接政府项目
4. 开发餐厅小程序

---

## 📊 数据规模

### 当前状态

| 域                        | 集合数 | 数据量     |
| ------------------------- | ------ | ---------- |
| v1.0 基础                 | 14     | 401 条     |
| v2.0 智慧                 | 7      | 30 条      |
| v3.0 电商+运营            | 9      | 22 条      |
| **v4.0 餐厅+碳普惠+政府** | **15** | **12 条**  |
| **总计**                  | **45** | **465 条** |

### 预期规模 (10 万用户)

| 项目       | 数据量    | 月增量   | 存储      |
| ---------- | --------- | -------- | --------- |
| 用户       | 10 万     | +1000    | 25GB      |
| 餐食+订单  | 500 万    | +5 万    | 80GB      |
| 餐厅       | 500 家    | +20      | 50MB      |
| 菜品       | 5000      | +100     | 500MB     |
| 碳积分交易 | 200 万    | +2 万    | 20GB      |
| 政府项目   | 20 个     | +1       | 10MB      |
| **总计**   | ~600 万条 | ~8 万/月 | **150GB** |

**月度成本**: 约 ¥1,200

---

## 💡 关键技术点

### 统一数据管理

**database 云函数** - 支持 12 种操作:

```bash
# v4.0 操作 (新增)
{"action": "init-v4"}      # 创建餐厅+碳普惠+政府域集合 ✅
{"action": "migrate-v4"}   # 扩展 v4.0 字段 ✅
{"action": "seed-v4-data"} # 导入 v4.0 示例数据 ✅

# v3.0 操作
{"action": "init-v3"}      # 创建电商+运营域集合
{"action": "migrate-v3"}   # 扩展 v3.0 字段

# v2.0 操作
{"action": "init-v2"}      # 创建智慧域集合
{"action": "migrate-v2"}   # 扩展 v2.0 字段

# v1.0 操作
{"action": "init-v1"}      # 初始化基础集合

# 通用操作
{"action": "get-status"}   # 查看数据库状态 ✅
{"action": "test-upgrade"} # 测试升级结果
```

### 数据打通机制

**餐厅订单 → 花园同步**:

1. 用户在餐厅就餐 (restaurant_orders)
2. 云函数自动触发 (restaurant-order-sync)
3. 计算碳减排, 发放碳积分 (carbon_credits)
4. 创建 meals 记录
5. 更新 daily_stats
6. 记录公众参与 (public_participation)
7. 浇灌植物

**碳普惠数据流**:

1. 用户碳减排 (carbon_credits)
2. 汇总上报 (carbon_exchange_records)
3. 政府核证 (government_programs)
4. 补贴发放 (carbon_transactions)
5. 用户获得权益 (公共出行/文旅)

---

## 🎁 示例数据

### 3 家气候餐厅

| 餐厅     | 等级    | 位置   | 人均 | 累计减排 |
| -------- | ------- | ------ | ---- | -------- |
| 悦素堂   | 🥇 金牌 | 西湖区 | ¥88  | 12.5 吨  |
| 本来素食 | 🥈 银牌 | 江干区 | ¥45  | 6.8 吨   |
| 绿意小厨 | 🥉 铜牌 | 拱墅区 | ¥38  | 2.3 吨   |

### 3 个低碳菜品

| 菜品       | 碳足迹 | 碳标签 | 减排  | 碳评分 |
| ---------- | ------ | ------ | ----- | ------ |
| 时蔬养生煲 | 0.65kg | 低碳   | 84.5% | 88 分  |
| 豆腐家常菜 | 0.48kg | 超低碳 | 93.3% | 95 分  |
| 糙米盖浇饭 | 0.52kg | 低碳   | 93.9% | 90 分  |

---

## 📖 完整文档导航

### 🎯 核心文档

1. **数据库架构升级方案 v4.0-气候餐厅版.md** - 完整方案 (17,000 字)
2. **数据库 v4.0 升级-执行指南.md** - 操作手册
3. **数据库索引配置 v4.0.md** - 索引配置 (56 个)
4. **v4.0 示例数据说明.md** - 数据详解 (12 条)

### 🔧 技术文档

5. **数据库架构设计文档-完整版.md** - 技术规范
6. **索引创建-复制粘贴版 v4.0.md** - 快速配置 (待创建)

---

## 🎯 成功指标

### 技术指标

- [x] 45 个集合创建 ✅
- [x] 4 个集合扩展 ✅
- [x] 12 条示例数据 ✅
- [x] 2 个云函数编写 ✅
- [ ] 93 个索引配置 ⏳
- [ ] 功能测试通过 ⏳

**完成度**: 4/6 = 67%

### 业务指标 (12 个月目标)

- [ ] 气候餐厅 500 家
- [ ] 用户突破 10 万
- [ ] 累计减排 500 吨
- [ ] 政府项目 5 个
- [ ] 年度收入 ¥720 万

---

## ❓ 常见问题

### Q: v4.0 与 v3.0 的区别?

**A**:

- v3.0: 花园 + 商城 (个人层面)
- v4.0: 花园 + 商城 + 餐厅 + 碳普惠 (社会层面)

### Q: 为什么需要气候餐厅?

**A**:

- 扩展外出就餐场景
- 触达更广泛人群 (非素食者)
- 对接政府碳普惠政策
- B2B 餐饮供应链业务

### Q: 碳普惠是什么?

**A**:

- 政府主导的碳减排激励机制
- 个人/企业减排行为 → 碳积分
- 碳积分 → 政府补贴 + 公共权益
- v4.0 已具备对接能力

### Q: 如何回滚到 v3.0?

**A**:

```bash
# 手动删除 v4.0 新建的 15 个集合
# restaurants, restaurant_*, carbon_*, government_*, public_*, esg_*
```

---

## 🏆 里程碑

- [x] 2025-10-14: v2.0 完成 (践行者智慧)
- [x] 2025-10-15 上午: v3.0 完成 (九悦融合)
- [x] 2025-10-15 下午: v4.0 完成 (气候餐厅) 🎉
- [ ] 2025-10-20: 索引配置完成
- [ ] 2025-11-01: 试点餐厅招募
- [ ] 2025-12-01: 政府项目对接
- [ ] 2026-03: 规模化推广

---

## 🎊 恭喜!

**数据库 v4.0 核心升级已完成!**

**下一步**:

1. 配置 93 个索引 (参考: `Docs/数据库索引配置v4.0.md`)
2. 部署新云函数 (2 个)
3. 招募试点餐厅 (5-10 家)
4. 对接政府碳普惠项目

**愿景**:

> **打造中国第一个社会化减碳行动平台**  
> **让每一餐都成为改变世界的力量**

---

_最后更新: 2025-10-15_
