# æˆ‘çš„èŠ±å›­é¡¹ç›® - æ•°æ®åº“æ¶æ„è§„åˆ’æ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

## ä¸€ã€æ•´ä½“æ¶æ„è®¾è®¡åŸåˆ™

### 1.1 æ ¸å¿ƒè®¾è®¡ç›®æ ‡

- **è§„æ¨¡æ”¯æŒ**: 10 ä¸‡ç”¨æˆ·ä»¥å†…ï¼Œæ—¥æ´» 1-3 ä¸‡
- **å®‰å…¨ç­‰çº§**: åŸºç¡€ä¿å¯†ï¼ˆç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹è¦æ±‚ï¼‰
- **è¯»å–æ€§èƒ½**: ä¸ªäººæ•°æ®æŸ¥è¯¢ <50msï¼Œå¤æ‚æŸ¥è¯¢ <200ms
- **æ•°æ®åŒæ­¥**: æ”¯æŒå¤–å–å¹³å°ã€é¤å… POS ç­‰ç¬¬ä¸‰æ–¹æ•°æ®åŒæ­¥

### 1.2 ç®€åŒ–è®¾è®¡ç­–ç•¥

- **é›†åˆç²¾ç®€**: 13 ä¸ªæ ¸å¿ƒé›†åˆï¼ˆvs åŸæ–¹æ¡ˆ 18+ï¼‰
- **åŸºç¡€åŠ å¯†**: ä»…å¯¹ OpenID ç­‰å…³é”®å­—æ®µåŠ å¯†ï¼Œæ— éœ€ KMS
- **ç®€åŒ–ç´¢å¼•**: 32 ä¸ªæ ¸å¿ƒç´¢å¼•ï¼ˆvs åŸæ–¹æ¡ˆ 50+ï¼‰
- **å•åº“æ–¹æ¡ˆ**: æ— éœ€åˆ†ç‰‡ï¼Œä½¿ç”¨å•ä¸€æ•°æ®åº“å®ä¾‹

---

## äºŒã€æ ¸å¿ƒé›†åˆè®¾è®¡ï¼ˆ13 ä¸ªé›†åˆï¼‰

### 2.1 ç”¨æˆ·åŸŸï¼ˆ2 ä¸ªé›†åˆï¼‰

#### **users** - ç”¨æˆ·ä¸»è¡¨

```javascript
{
  _id: ObjectId,
  openId: String,              // å¾®ä¿¡OpenIDï¼ˆå“ˆå¸Œå­˜å‚¨ï¼‰

  // åŸºç¡€ä¿¡æ¯
  profile: {
    nickname: String,
    avatar: String,
    bio: String
  },

  // ç­‰çº§ç§¯åˆ†
  level: Number,               // ç”¨æˆ·ç­‰çº§ 1-4
  points: Number,              // å½“å‰ç§¯åˆ†
  experience: Number,          // æ€»ç»éªŒå€¼

  // åå¥½è®¾ç½®ï¼ˆç®€åŒ–ï¼‰
  preferences: {
    dietType: String,          // vegetarian/vegan/flexitarian
    notifications: Boolean,     // æ˜¯å¦æ¥æ”¶é€šçŸ¥ï¼ˆç®€åŒ–ä¸ºå¸ƒå°”å€¼ï¼‰
    language: String           // zh-CN/en-US
  },

  // å¿«é€Ÿè®¿é—®ç»Ÿè®¡ï¼ˆå†—ä½™è®¾è®¡ï¼‰
  stats: {
    totalCarbonReduction: Number,
    totalMeals: Number,
    currentStreak: Number,
    gardenPlantsCount: Number
  },

  // ç¬¬ä¸‰æ–¹åŒæ­¥çŠ¶æ€ï¼ˆç®€åŒ–ï¼‰
  syncedPlatforms: [String],   // ['meituan', 'eleme'] å·²ç»‘å®šçš„å¹³å°

  // æ—¶é—´æˆ³
  createdAt: Date,
  updatedAt: Date,
  lastLoginAt: Date
}

// æ ¸å¿ƒç´¢å¼•ï¼ˆ3ä¸ªï¼‰
db.users.createIndex({ openId: 1 }, { unique: true })
db.users.createIndex({ level: -1, points: -1 })  // æ’è¡Œæ¦œ
db.users.createIndex({ lastLoginAt: -1 })  // æ´»è·ƒåº¦
```

#### **user_sessions** - ä¼šè¯è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå¤šè®¾å¤‡ç®¡ç†ï¼‰

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  accessToken: String,
  expiresAt: Date,
  deviceInfo: String,          // ç®€åŒ–ä¸ºå­—ç¬¦ä¸²
  createdAt: Date
}

// ç´¢å¼•
db.user_sessions.createIndex({ userId: 1, expiresAt: 1 })
db.user_sessions.createIndex({ accessToken: 1 })
db.user_sessions.createIndex({ expiresAt: 1 }, { expireAfterSeconds: 0 })  // TTLè‡ªåŠ¨æ¸…ç†
```

---

### 2.2 ç¢³è¶³è¿¹åŸŸï¼ˆ2 ä¸ªé›†åˆï¼‰

#### **meals** - é¤é£Ÿè®°å½•è¡¨

```javascript
{
  _id: ObjectId,
  userId: ObjectId,

  // åŸºæœ¬ä¿¡æ¯
  mealType: String,            // breakfast/lunch/dinner/snack
  mealDate: Date,

  // é£Ÿæï¼ˆç®€åŒ–ç»“æ„ï¼‰
  ingredients: [{
    ingredientId: ObjectId,    // å¯é€‰ï¼Œå…³è”ingredientsè¡¨
    name: String,              // å¿…å¡«
    quantity: Number,          // å…‹
    carbonFootprint: Number    // å•é¡¹ç¢³æ’æ”¾
  }],

  // çƒ¹é¥ªä¿¡æ¯ï¼ˆç®€åŒ–ï¼‰
  cookingMethod: String,       // å¯é€‰

  // ç¢³è¶³è¿¹ç»“æœ
  totalCarbonFootprint: Number,
  carbonReduction: Number,

  // æ•°æ®æ¥æº
  source: String,              // manual/third_party
  sourcePlatform: String,      // meituan/elemeç­‰ï¼Œä»…ç¬¬ä¸‰æ–¹åŒæ­¥æ—¶å¡«å†™
  sourceOrderId: String,       // ç¬¬ä¸‰æ–¹è®¢å•IDï¼ˆå“ˆå¸Œå­˜å‚¨ï¼‰

  // ç¤¾äº¤
  isPublic: Boolean,

  // æ—¶é—´æˆ³
  createdAt: Date
}

// æ ¸å¿ƒç´¢å¼•ï¼ˆ4ä¸ªï¼‰
db.meals.createIndex({ userId: 1, mealDate: -1 })  // æœ€é«˜é¢‘æŸ¥è¯¢
db.meals.createIndex({ userId: 1, createdAt: -1 })
db.meals.createIndex({ userId: 1, source: 1, sourceOrderId: 1 }, { unique: true, sparse: true })  // é˜²é‡å¤åŒæ­¥
db.meals.createIndex({ isPublic: 1, createdAt: -1 })  // å…¬å¼€åŠ¨æ€
```

#### **daily_stats** - æ¯æ—¥ç»Ÿè®¡è¡¨ï¼ˆé¢„èšåˆï¼‰

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  date: Date,                  // YYYY-MM-DD 00:00:00

  // ç»Ÿè®¡æ•°æ®
  totalMeals: Number,
  totalCarbonReduction: Number,
  mealTypes: {
    breakfast: Number,
    lunch: Number,
    dinner: Number,
    snack: Number
  },

  // æ—¶é—´æˆ³
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•
db.daily_stats.createIndex({ userId: 1, date: -1 })
db.daily_stats.createIndex({ date: -1, totalCarbonReduction: -1 })  // æ¯æ—¥æ’è¡Œæ¦œ
db.daily_stats.createIndex({ userId: 1, date: 1 }, { unique: true })
```

---

### 2.3 èŠ±å›­åŸŸï¼ˆ1 ä¸ªé›†åˆï¼‰

#### **gardens** - èŠ±å›­è¡¨

```javascript
{
  _id: ObjectId,
  userId: ObjectId,            // å”¯ä¸€

  // åœºæ™¯
  currentScene: String,        // desert/rainforest/wetland/future
  unlockedScenes: [String],

  // æ¤ç‰©åˆ—è¡¨ï¼ˆç®€åŒ–ï¼‰
  plants: [{
    id: String,                // æ¤ç‰©ID
    type: String,              // cactus/lavender/cherry/orchid
    position: { x: Number, y: Number },  // 2Dåæ ‡
    growth: Number,            // 0-100
    plantedAt: Date,
    isHarvested: Boolean
  }],

  // ç»Ÿè®¡ï¼ˆç®€åŒ–ï¼‰
  totalPlantsPlanted: Number,
  totalPlantsHarvested: Number,

  // æ—¶é—´æˆ³
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•
db.gardens.createIndex({ userId: 1 }, { unique: true })
```

---

### 2.4 åŸºç¡€æ•°æ®åŸŸï¼ˆ3 ä¸ªé›†åˆï¼‰

#### **ingredients** - é£Ÿæåº“

```javascript
{
  _id: ObjectId,

  // åŸºæœ¬ä¿¡æ¯
  name: String,
  nameEn: String,
  category: String,            // vegetables/beans/grains/fruits

  // ç¢³è¶³è¿¹æ•°æ®ï¼ˆç®€åŒ–ï¼‰
  carbonFootprint: Number,     // åŸºç¡€ç³»æ•° kg CO2e/kg

  // è¥å…»æ•°æ®ï¼ˆç®€åŒ–ï¼Œæ¯100gï¼‰
  nutrition: {
    calories: Number,
    protein: Number,
    carbs: Number,
    fat: Number
  },

  // ç¬¬ä¸‰æ–¹å¹³å°æ˜ å°„
  platformMappings: {
    meituan: String,           // ç¾å›¢å¹³å°ID
    eleme: String              // é¥¿äº†ä¹ˆå¹³å°ID
  },

  // çŠ¶æ€
  status: String,              // active/deprecated
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•
db.ingredients.createIndex({ name: 1 })
db.ingredients.createIndex({ category: 1 })
db.ingredients.createIndex({ name: "text", nameEn: "text" })  // å…¨æ–‡æœç´¢
```

#### **recipes** - é£Ÿè°±åº“ï¼ˆå¯é€‰ï¼‰

```javascript
{
  _id: ObjectId,
  name: String,
  description: String,
  images: [String],

  // é£Ÿæ
  ingredients: [{
    ingredientId: ObjectId,
    name: String,
    quantity: Number,
    unit: String
  }],

  // é¢„è®¡ç®—
  estimatedCarbonFootprint: Number,
  estimatedCalories: Number,

  // æ¥æº
  source: String,              // official/user
  creatorId: ObjectId,

  // äº’åŠ¨
  usageCount: Number,

  createdAt: Date
}

// ç´¢å¼•
db.recipes.createIndex({ name: "text" })
db.recipes.createIndex({ usageCount: -1 })
```

#### **meat_products** - è‚‰ç±»ç¢³è¶³è¿¹æ•°æ®åº“ ğŸ†•

```javascript
{
  _id: ObjectId,

  // åŸºæœ¬ä¿¡æ¯
  name: String,                // ä¸­æ–‡åç§°ï¼Œå¦‚"ç‰›è‚‰ï¼ˆç‰›è…©ï¼‰"
  nameEn: String,              // è‹±æ–‡åç§°ï¼Œå¦‚"Beef Brisket"

  // åˆ†ç±»
  category: String,            // red_meat/poultry/seafood/processed_meat
  subcategory: String,         // beef/pork/lamb/chicken/fishç­‰

  // ç¢³è¶³è¿¹æ•°æ®ï¼ˆæ ¸å¿ƒï¼‰
  carbonFootprint: Number,     // kg COâ‚‚e/kgï¼ˆåŸºäºæƒå¨ç ”ç©¶ï¼‰

  // è¥å…»æ•°æ®ï¼ˆæ¯100gï¼‰
  nutrition: {
    calories: Number,          // çƒ­é‡ kcal
    protein: Number,           // è›‹ç™½è´¨ g
    carbs: Number,             // ç¢³æ°´åŒ–åˆç‰© g
    fat: Number                // è„‚è‚ª g
  },

  // ç”Ÿäº§ä¿¡æ¯
  productionMethod: String,    // conventional/organic/farmed/wild_caught/processed
  region: String,              // china_average/import

  // æ•°æ®æ¥æºï¼ˆç§‘å­¦æ€§ä¿éšœï¼‰
  sources: [String],           // å¦‚["FAO 2021", "Our World in Data"]

  // å¯¹æ¯”åˆ†ç»„
  comparisonGroup: String,     // ç”¨äºå¯¹æ¯”ç´ é£Ÿæ›¿ä»£å“ï¼Œå¦‚"beef"/"pork"

  // ç´ é£Ÿæ›¿ä»£å“æ¨è
  veganAlternatives: [String], // æ¨èçš„ç´ é£Ÿæ›¿ä»£å“åç§°åˆ—è¡¨

  // çŠ¶æ€
  status: String,              // active/deprecated
  createdAt: Date,
  updatedAt: Date
}

// ç´¢å¼•ï¼ˆ4ä¸ªï¼‰
db.meat_products.createIndex({ name: 1 }, { unique: true })  // æŸ¥è¯¢è‚‰ç±»ã€ç¡®ä¿å”¯ä¸€
db.meat_products.createIndex({ category: 1, subcategory: 1 }) // åˆ†ç±»ç»Ÿè®¡
db.meat_products.createIndex({ carbonFootprint: -1 })         // ç¢³è¶³è¿¹æ’åº
db.meat_products.createIndex({ status: 1 })                   // è¿‡æ»¤æ´»è·ƒæ•°æ®
```

**è®¾è®¡è¯´æ˜**ï¼š

- **ç”¨é€”**: ç”¨äº"ç´ é£Ÿ vs è‚‰é£Ÿ"ç¢³æ’æ”¾å¯¹æ¯”è®¡ç®—
- **æ•°æ®è§„æ¨¡**: 81 ç§è‚‰ç±»äº§å“ï¼ˆçº¢è‚‰ 20+ç¦½è‚‰ 12+æ°´äº§ 27+åŠ å·¥è‚‰ 15+ä¹³åˆ¶å“ 7ï¼‰
- **ç¢³è¶³è¿¹èŒƒå›´**: 2.9-64.2 kg COâ‚‚e/kg
- **æ•°æ®æ¥æº**: FAOã€Our World in Dataï¼ˆPoore & Nemecek 2018 Scienceï¼‰ã€IPCC ç­‰æƒå¨ç ”ç©¶
- **å…³é”®åŠŸèƒ½**:
  - å¯¹æ¯”è®¡ç®—ï¼šç´ é£Ÿ vs è‚‰é£Ÿçš„å‡æ’é‡è®¡ç®—
  - æ›¿ä»£æ¨èï¼šæŸ¥è¯¢è‚‰ç±»çš„ç´ é£Ÿæ›¿ä»£å“
  - æ•™è‚²å±•ç¤ºï¼šç¢³è¶³è¿¹æ’è¡Œæ¦œ
- **ä¸ ingredients å…³è”**: veganAlternatives å­—æ®µå…³è” ingredients é›†åˆä¸­çš„ç´ é£Ÿé£Ÿæ

---

### 2.5 ç¬¬ä¸‰æ–¹åŒæ­¥åŸŸï¼ˆ2 ä¸ªé›†åˆï¼‰

#### **sync_tasks** - åŒæ­¥ä»»åŠ¡è¡¨

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  platform: String,            // meituan/eleme

  // ä»»åŠ¡ä¿¡æ¯
  status: String,              // pending/completed/failed
  orderId: String,             // ç¬¬ä¸‰æ–¹è®¢å•IDï¼ˆå“ˆå¸Œï¼‰
  mealId: ObjectId,            // åˆ›å»ºçš„é¤é£Ÿè®°å½•ID

  // é”™è¯¯å¤„ç†
  attempts: Number,
  errorMessage: String,
  nextRetry: Date,

  // æ—¶é—´æˆ³
  createdAt: Date,
  completedAt: Date
}

// ç´¢å¼•
db.sync_tasks.createIndex({ userId: 1, platform: 1, status: 1 })
db.sync_tasks.createIndex({ status: 1, nextRetry: 1 })
db.sync_tasks.createIndex({ platform: 1, orderId: 1 }, { unique: true, sparse: true })
db.sync_tasks.createIndex({ createdAt: 1 }, { expireAfterSeconds: 2592000 })  // 30å¤©è‡ªåŠ¨åˆ é™¤
```

#### **platform_configs** - å¹³å°é…ç½®è¡¨

```javascript
{
  _id: ObjectId,
  platform: String,            // meituan/eleme

  // APIé…ç½®
  apiEndpoint: String,
  apiVersion: String,
  authType: String,

  // é£Ÿææ˜ å°„ï¼ˆç®€åŒ–ï¼‰
  ingredientMappings: [{
    platformId: String,
    platformName: String,
    ourIngredientId: ObjectId
  }],

  status: String,
  updatedAt: Date
}

// ç´¢å¼•
db.platform_configs.createIndex({ platform: 1 }, { unique: true })
```

---

### 2.6 ç¤¾äº¤åŸŸï¼ˆ2 ä¸ªé›†åˆï¼‰

#### **friends** - å¥½å‹å…³ç³»è¡¨

```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  friendId: ObjectId,
  status: String,              // pending/accepted/blocked

  // ç®€åŒ–çš„äº’åŠ¨ç»Ÿè®¡
  interactions: {
    waterGiven: Number,
    lastInteraction: Date
  },

  createdAt: Date
}

// ç´¢å¼•
db.friends.createIndex({ userId: 1, friendId: 1 }, { unique: true })
db.friends.createIndex({ userId: 1, status: 1 })
```

#### **posts** - åŠ¨æ€è¡¨ï¼ˆç®€åŒ–ï¼‰

```javascript
{
  _id: ObjectId,
  userId: ObjectId,

  // å†…å®¹
  type: String,                // meal/garden/achievement
  content: String,
  images: [String],
  relatedMealId: ObjectId,

  // äº’åŠ¨
  likes: Number,

  // å¯è§æ€§
  visibility: String,          // public/friends/private

  createdAt: Date
}

// ç´¢å¼•
db.posts.createIndex({ userId: 1, createdAt: -1 })
db.posts.createIndex({ visibility: 1, createdAt: -1 })
```

---

### 2.7 ç§¯åˆ†å•†åŸåŸŸï¼ˆ1 ä¸ªé›†åˆï¼‰

#### **orders** - è®¢å•è¡¨

```javascript
{
  _id: ObjectId,
  orderNo: String,
  userId: ObjectId,

  // å•†å“ä¿¡æ¯ï¼ˆç®€åŒ–ï¼Œç›´æ¥å­˜å‚¨ï¼‰
  productName: String,
  pointsPrice: Number,

  // é…é€ä¿¡æ¯ï¼ˆåŸºç¡€å­˜å‚¨ï¼‰
  shippingInfo: {
    name: String,
    phone: String,
    address: String
  },

  // çŠ¶æ€
  status: String,              // pending/completed/cancelled

  createdAt: Date,
  completedAt: Date
}

// ç´¢å¼•
db.orders.createIndex({ orderNo: 1 }, { unique: true })
db.orders.createIndex({ userId: 1, createdAt: -1 })
```

---

## ä¸‰ã€ç®€åŒ–çš„å®‰å…¨æ–¹æ¡ˆ

### 3.1 åŸºç¡€åŠ å¯†ç­–ç•¥

#### åŠ å¯†å­—æ®µï¼ˆä»… 3 ç±»ï¼‰

| é›†åˆ   | å­—æ®µ               | å¤„ç†æ–¹å¼      | è¯´æ˜             |
| ------ | ------------------ | ------------- | ---------------- |
| users  | openId             | SHA-256 å“ˆå¸Œ  | ä¸å¯é€†ï¼Œç”¨äºæŸ¥è¯¢ |
| meals  | sourceOrderId      | SHA-256 å“ˆå¸Œ  | é˜²æ­¢è®¢å• ID æ³„éœ² |
| orders | shippingInfo.phone | ä¸­é—´ 4 ä½æ©ç  | æ˜¾ç¤ºæ—¶è„±æ•       |

#### åŠ å¯†å·¥å…·ï¼ˆç®€åŒ–ç‰ˆï¼‰

```javascript
// cloudfunctions/common/encryption.js
const crypto = require("crypto");

class SimpleEncryption {
  constructor() {
    this.salt = process.env.ENCRYPTION_SALT || "my-garden-salt-2025";
  }

  // å“ˆå¸ŒOpenIDï¼ˆä¸å¯é€†ï¼‰
  hashOpenId(openId) {
    return crypto
      .createHash("sha256")
      .update(openId + this.salt)
      .digest("hex");
  }

  // å“ˆå¸Œè®¢å•ID
  hashOrderId(orderId) {
    return crypto
      .createHash("sha256")
      .update(orderId + this.salt)
      .digest("hex");
  }

  // æ‰‹æœºå·è„±æ•
  maskPhone(phone) {
    if (!phone || phone.length < 11) return phone;
    return phone.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
  }

  // åœ°å€è„±æ•
  maskAddress(address) {
    if (!address) return "";
    // åªä¿ç•™åˆ°å¸‚çº§
    const parts = address.split("å¸‚");
    return parts[0] + "å¸‚***";
  }
}

module.exports = new SimpleEncryption();
```

### 3.2 åŸºç¡€è®¿é—®æ§åˆ¶

#### äº‘å‡½æ•°æƒé™ï¼ˆç®€åŒ–ï¼‰

```javascript
// cloudfunctions/common/permission.js
const cloud = require("wx-server-sdk");
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

class PermissionChecker {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®ç‰¹å®šæ•°æ®
  async checkAccess(requestUserId, targetUserId, dataType) {
    // 1. è‡ªå·±çš„æ•°æ®
    if (requestUserId === targetUserId) {
      return { allowed: true, reason: "Owner access" };
    }

    // 2. å¥½å‹æ•°æ®ï¼ˆä»…èŠ±å›­å’Œç»Ÿè®¡ï¼‰
    if (dataType === "garden" || dataType === "stats") {
      const friendCount = await db
        .collection("friends")
        .where({
          userId: targetUserId,
          friendId: requestUserId,
          status: "accepted",
        })
        .count();

      if (friendCount.total > 0) {
        return { allowed: true, reason: "Friend access" };
      }
    }

    // 3. å…¬å¼€æ•°æ®
    if (dataType === "public_post") {
      return { allowed: true, reason: "Public access" };
    }

    return { allowed: false, reason: "Access denied" };
  }

  // éªŒè¯æ˜¯å¦ä¸ºè‡ªå·±çš„æ•°æ®
  async checkOwnership(userId, collection, docId) {
    const doc = await db.collection(collection).doc(docId).get();
    if (!doc.data) {
      return { valid: false, reason: "Document not found" };
    }

    if (doc.data.userId !== userId) {
      return { valid: false, reason: "Not the owner" };
    }

    return { valid: true };
  }
}

module.exports = new PermissionChecker();
```

---

## å››ã€ä¼˜åŒ–çš„ç´¢å¼•ç­–ç•¥

### 4.1 æ ¸å¿ƒæŸ¥è¯¢åœºæ™¯ï¼ˆ3 ä¸ªï¼‰

#### åœºæ™¯ 1: ç”¨æˆ·é¦–é¡µåŠ è½½ï¼ˆæœ€é«˜é¢‘ï¼‰

```javascript
// å•æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰æ•°æ®
async function loadUserDashboard(userId) {
  const db = cloud.database();

  // å¹¶è¡ŒæŸ¥è¯¢
  const [user, garden, recentMeals, todayStats] = await Promise.all([
    // 1. ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸»é”®æŸ¥è¯¢ï¼‰
    db.collection("users").doc(userId).get(),

    // 2. èŠ±å›­ï¼ˆuserIdå”¯ä¸€ç´¢å¼•ï¼‰
    db.collection("gardens").where({ userId }).get(),

    // 3. æœ€è¿‘é¤é£Ÿï¼ˆå¤åˆç´¢å¼•: userId + mealDateï¼‰
    db
      .collection("meals")
      .where({ userId })
      .orderBy("mealDate", "desc")
      .limit(5)
      .get(),

    // 4. ä»Šæ—¥ç»Ÿè®¡ï¼ˆå¤åˆç´¢å¼•: userId + dateï¼‰
    db
      .collection("daily_stats")
      .where({
        userId,
        date: getTodayStart(),
      })
      .get(),
  ]);

  return {
    user: user.data,
    garden: garden.data[0],
    recentMeals: recentMeals.data,
    todayStats: todayStats.data[0],
  };
}

// æ€§èƒ½ç›®æ ‡: æ€»è®¡ < 50ms
```

#### åœºæ™¯ 2: æ’è¡Œæ¦œæŸ¥è¯¢

```javascript
// ä½¿ç”¨é¢„èšåˆçš„daily_statsè¡¨
async function getDailyRanking(date, limit = 20) {
  const db = cloud.database();

  const rankings = await db
    .collection("daily_stats")
    .where({ date })
    .orderBy("totalCarbonReduction", "desc")
    .limit(limit)
    .get();

  // è·å–ç”¨æˆ·ä¿¡æ¯
  const userIds = rankings.data.map((r) => r.userId);
  const users = await db
    .collection("users")
    .where({
      _id: db.command.in(userIds),
    })
    .field({
      profile: true,
      level: true,
    })
    .get();

  // åˆå¹¶æ•°æ®
  const usersMap = new Map(users.data.map((u) => [u._id, u]));
  return rankings.data.map((rank, index) => ({
    rank: index + 1,
    user: usersMap.get(rank.userId),
    carbonReduction: rank.totalCarbonReduction,
    mealCount: rank.totalMeals,
  }));
}

// æ€§èƒ½ç›®æ ‡: < 100ms
```

#### åœºæ™¯ 3: ç¬¬ä¸‰æ–¹åŒæ­¥é˜²é‡

```javascript
// å”¯ä¸€å¤åˆç´¢å¼•
async function checkOrderSynced(userId, platform, orderId) {
  const db = cloud.database();
  const encryption = require("./common/encryption");

  const hashedOrderId = encryption.hashOrderId(orderId);

  const existing = await db
    .collection("meals")
    .where({
      userId,
      source: "third_party",
      sourceOrderId: hashedOrderId,
    })
    .get();

  return existing.data.length > 0;
}

// æ€§èƒ½ç›®æ ‡: < 20ms
```

### 4.2 ç´¢å¼•æ¸…å•

| é›†åˆ             | ç´¢å¼•                          | ç±»å‹     | ç”¨é€”          |
| ---------------- | ----------------------------- | -------- | ------------- |
| users            | openId                        | å”¯ä¸€     | ç™»å½•æŸ¥è¯¢      |
| users            | level, points                 | å¤åˆé™åº | æ’è¡Œæ¦œ        |
| users            | lastLoginAt                   | é™åº     | æ´»è·ƒåº¦ç»Ÿè®¡    |
| user_sessions    | userId, expiresAt             | å¤åˆ     | ä¼šè¯ç®¡ç†      |
| user_sessions    | accessToken                   | æ™®é€š     | Token éªŒè¯    |
| user_sessions    | expiresAt                     | TTL      | è‡ªåŠ¨æ¸…ç†      |
| meals            | userId, mealDate              | å¤åˆé™åº | ä¸ªäººè®°å½•æŸ¥è¯¢  |
| meals            | userId, createdAt             | å¤åˆé™åº | æœ€è¿‘è®°å½•      |
| meals            | userId, source, sourceOrderId | å”¯ä¸€ç¨€ç– | é˜²é‡å¤åŒæ­¥    |
| meals            | isPublic, createdAt           | å¤åˆé™åº | å…¬å¼€åŠ¨æ€      |
| daily_stats      | userId, date                  | å¤åˆé™åº | ä¸ªäººç»Ÿè®¡      |
| daily_stats      | date, totalCarbonReduction    | å¤åˆé™åº | æ’è¡Œæ¦œ        |
| daily_stats      | userId, date                  | å”¯ä¸€     | æ•°æ®å”¯ä¸€æ€§    |
| gardens          | userId                        | å”¯ä¸€     | ä¸ªäººèŠ±å›­      |
| ingredients      | name                          | æ™®é€š     | åç§°æŸ¥è¯¢      |
| ingredients      | category                      | æ™®é€š     | åˆ†ç±»æŸ¥è¯¢      |
| ingredients      | name, nameEn                  | æ–‡æœ¬     | å…¨æ–‡æœç´¢      |
| recipes          | name                          | æ–‡æœ¬     | å…¨æ–‡æœç´¢      |
| recipes          | usageCount                    | é™åº     | çƒ­é—¨é£Ÿè°±      |
| sync_tasks       | userId, platform, status      | å¤åˆ     | ä»»åŠ¡ç®¡ç†      |
| sync_tasks       | status, nextRetry             | å¤åˆ     | é‡è¯•é˜Ÿåˆ—      |
| sync_tasks       | platform, orderId             | å”¯ä¸€ç¨€ç– | ä»»åŠ¡å”¯ä¸€æ€§    |
| sync_tasks       | createdAt                     | TTL      | 30 å¤©è‡ªåŠ¨åˆ é™¤ |
| platform_configs | platform                      | å”¯ä¸€     | å¹³å°é…ç½®      |
| friends          | userId, friendId              | å”¯ä¸€     | å¥½å‹å…³ç³»      |
| friends          | userId, status                | å¤åˆ     | å¥½å‹åˆ—è¡¨      |
| posts            | userId, createdAt             | å¤åˆé™åº | ä¸ªäººåŠ¨æ€      |
| posts            | visibility, createdAt         | å¤åˆé™åº | å…¬å¼€åŠ¨æ€      |
| orders           | orderNo                       | å”¯ä¸€     | è®¢å•æŸ¥è¯¢      |
| orders           | userId, createdAt             | å¤åˆé™åº | è®¢å•åˆ—è¡¨      |
| meat_products    | name                          | å”¯ä¸€     | è‚‰ç±»åç§°æŸ¥è¯¢  |
| meat_products    | category, subcategory         | å¤åˆ     | åˆ†ç±»ç»Ÿè®¡      |
| meat_products    | carbonFootprint               | é™åº     | ç¢³è¶³è¿¹æ’åº    |
| meat_products    | status                        | æ™®é€š     | è¿‡æ»¤æ´»è·ƒæ•°æ®  |

**æ€»è®¡: 32 ä¸ªç´¢å¼•**

---

## äº”ã€ç¬¬ä¸‰æ–¹æ•°æ®åŒæ­¥

### 5.1 åŒæ­¥æµç¨‹æ¶æ„

```
ç”¨æˆ·æˆæƒ â†’ å¹³å°OAuth â†’ è®¢å•åŒæ­¥ â†’ é£Ÿææ˜ å°„ â†’ ç¢³è¶³è¿¹è®¡ç®— â†’ åˆ›å»ºé¤é£Ÿè®°å½•
   â†“           â†“           â†“           â†“            â†“             â†“
 ç»‘å®šå¹³å°   è·å–Token   é˜²é‡æ£€æŸ¥   æ™ºèƒ½åŒ¹é…   è‡ªåŠ¨è®¡ç®—      æ›´æ–°ç»Ÿè®¡
```

### 5.2 ç¾å›¢è®¢å•åŒæ­¥å®ç°

```javascript
// cloudfunctions/sync/meituan-sync/index.js
const cloud = require("wx-server-sdk");
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();
const _ = db.command;
const encryption = require("../../common/encryption");

/**
 * ç¾å›¢è®¢å•åŒæ­¥äº‘å‡½æ•°
 */
exports.main = async (event) => {
  const { userId, orderId, accessToken } = event;

  try {
    // 1. å“ˆå¸Œè®¢å•ID
    const hashedOrderId = encryption.hashOrderId(orderId);

    // 2. æ£€æŸ¥æ˜¯å¦å·²åŒæ­¥
    const existingMeal = await db
      .collection("meals")
      .where({
        userId,
        source: "third_party",
        sourcePlatform: "meituan",
        sourceOrderId: hashedOrderId,
      })
      .get();

    if (existingMeal.data.length > 0) {
      return {
        code: 0,
        message: "Already synced",
        mealId: existingMeal.data[0]._id,
      };
    }

    // 3. è°ƒç”¨ç¾å›¢APIè·å–è®¢å•è¯¦æƒ…
    const orderData = await fetchMeituanOrder(orderId, accessToken);

    if (!orderData) {
      throw new Error("Failed to fetch order from Meituan");
    }

    // 4. é£Ÿææ˜ å°„
    const ingredients = await mapMeituanIngredients(orderData.dishes);

    // 5. è®¡ç®—ç¢³è¶³è¿¹
    const totalCarbon = ingredients.reduce(
      (sum, item) => sum + (item.carbonFootprint || 0),
      0
    );
    const carbonReduction = Math.max(0, 2.5 - totalCarbon); // åŸºå‡†2.5kg

    // 6. åˆ¤æ–­é¤ç±»å‹
    const mealType = determineMealType(orderData.orderTime);

    // 7. åˆ›å»ºé¤é£Ÿè®°å½•
    const mealResult = await db.collection("meals").add({
      data: {
        userId,
        mealType,
        mealDate: new Date(orderData.orderTime),
        ingredients,
        totalCarbonFootprint: totalCarbon,
        carbonReduction,
        source: "third_party",
        sourcePlatform: "meituan",
        sourceOrderId: hashedOrderId,
        isPublic: false,
        createdAt: new Date(),
      },
    });

    // 8. æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
    await db
      .collection("users")
      .where({ _id: userId })
      .update({
        data: {
          "stats.totalMeals": _.inc(1),
          "stats.totalCarbonReduction": _.inc(carbonReduction),
          updatedAt: new Date(),
        },
      });

    // 9. æ›´æ–°æ¯æ—¥ç»Ÿè®¡
    await updateDailyStats(userId, new Date(orderData.orderTime), {
      meals: 1,
      carbonReduction,
      mealType,
    });

    // 10. è®°å½•åŒæ­¥ä»»åŠ¡
    await db.collection("sync_tasks").add({
      data: {
        userId,
        platform: "meituan",
        status: "completed",
        orderId: hashedOrderId,
        mealId: mealResult._id,
        attempts: 1,
        createdAt: new Date(),
        completedAt: new Date(),
      },
    });

    return {
      code: 0,
      message: "Sync completed successfully",
      data: {
        mealId: mealResult._id,
        carbonReduction,
        pointsEarned: Math.floor(carbonReduction * 10),
      },
    };
  } catch (error) {
    console.error("Meituan sync failed:", error);

    // è®°å½•å¤±è´¥ä»»åŠ¡
    await db.collection("sync_tasks").add({
      data: {
        userId,
        platform: "meituan",
        status: "failed",
        orderId: encryption.hashOrderId(orderId),
        attempts: 1,
        errorMessage: error.message,
        nextRetry: new Date(Date.now() + 300000), // 5åˆ†é’Ÿåé‡è¯•
        createdAt: new Date(),
      },
    });

    return {
      code: 500,
      message: "Sync failed",
      error: error.message,
    };
  }
};

/**
 * è°ƒç”¨ç¾å›¢APIè·å–è®¢å•è¯¦æƒ…
 */
async function fetchMeituanOrder(orderId, accessToken) {
  // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„ç¾å›¢API
  // ç¤ºä¾‹ä»£ç 
  const axios = require("axios");

  try {
    const response = await axios.get(
      "https://api.meituan.com/orders/" + orderId,
      {
        headers: {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        },
        timeout: 5000,
      }
    );

    return response.data;
  } catch (error) {
    console.error("Failed to fetch Meituan order:", error);
    return null;
  }
}

/**
 * æ˜ å°„ç¾å›¢é£Ÿæåˆ°æˆ‘ä»¬çš„é£Ÿæåº“
 */
async function mapMeituanIngredients(dishes) {
  const mapped = [];

  // è·å–å¹³å°é…ç½®
  const config = await db
    .collection("platform_configs")
    .where({ platform: "meituan" })
    .get();

  const mappings = config.data[0]?.ingredientMappings || [];
  const mappingsMap = new Map(
    mappings.map((m) => [m.platformId, m.ourIngredientId])
  );

  for (const dish of dishes) {
    // å°è¯•ä»æ˜ å°„è¡¨æŸ¥æ‰¾
    const ourIngredientId = mappingsMap.get(dish.dishId);

    if (ourIngredientId) {
      // æ‰¾åˆ°æ˜ å°„ï¼Œè·å–æˆ‘ä»¬çš„é£Ÿæè¯¦æƒ…
      const ingredient = await db
        .collection("ingredients")
        .doc(ourIngredientId)
        .get();

      if (ingredient.data) {
        mapped.push({
          ingredientId: ingredient.data._id,
          name: ingredient.data.name,
          quantity: dish.quantity || 100,
          carbonFootprint:
            ingredient.data.carbonFootprint * (dish.quantity / 1000),
        });
        continue;
      }
    }

    // æ²¡æœ‰æ˜ å°„ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
    const fuzzyMatch = await db
      .collection("ingredients")
      .where({
        name: db.RegExp({
          regexp: dish.dishName,
          options: "i",
        }),
      })
      .limit(1)
      .get();

    if (fuzzyMatch.data.length > 0) {
      const ingredient = fuzzyMatch.data[0];

      // åˆ›å»ºæ–°æ˜ å°„
      await db
        .collection("platform_configs")
        .where({ platform: "meituan" })
        .update({
          data: {
            ingredientMappings: _.push({
              platformId: dish.dishId,
              platformName: dish.dishName,
              ourIngredientId: ingredient._id,
            }),
          },
        });

      mapped.push({
        ingredientId: ingredient._id,
        name: ingredient.name,
        quantity: dish.quantity || 100,
        carbonFootprint: ingredient.carbonFootprint * (dish.quantity / 1000),
      });
    } else {
      // å®Œå…¨æ— æ³•åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤ä¼°ç®—
      mapped.push({
        name: dish.dishName,
        quantity: dish.quantity || 100,
        carbonFootprint: 0.5, // é»˜è®¤ä¼°ç®—å€¼
      });
    }
  }

  return mapped;
}

/**
 * æ ¹æ®è®¢å•æ—¶é—´åˆ¤æ–­é¤ç±»å‹
 */
function determineMealType(orderTime) {
  const hour = new Date(orderTime).getHours();

  if (hour >= 6 && hour < 10) return "breakfast";
  if (hour >= 10 && hour < 14) return "lunch";
  if (hour >= 14 && hour < 17) return "snack";
  if (hour >= 17 && hour < 22) return "dinner";
  return "snack";
}

/**
 * æ›´æ–°æ¯æ—¥ç»Ÿè®¡
 */
async function updateDailyStats(userId, date, updates) {
  const dayStart = new Date(date);
  dayStart.setHours(0, 0, 0, 0);

  // æŸ¥è¯¢ä»Šæ—¥ç»Ÿè®¡æ˜¯å¦å­˜åœ¨
  const existing = await db
    .collection("daily_stats")
    .where({
      userId,
      date: dayStart,
    })
    .get();

  if (existing.data.length > 0) {
    // æ›´æ–°ç°æœ‰ç»Ÿè®¡
    const stats = existing.data[0];
    await db
      .collection("daily_stats")
      .doc(stats._id)
      .update({
        data: {
          totalMeals: _.inc(updates.meals),
          totalCarbonReduction: _.inc(updates.carbonReduction),
          [`mealTypes.${updates.mealType}`]: _.inc(1),
          updatedAt: new Date(),
        },
      });
  } else {
    // åˆ›å»ºæ–°ç»Ÿè®¡
    await db.collection("daily_stats").add({
      data: {
        userId,
        date: dayStart,
        totalMeals: updates.meals,
        totalCarbonReduction: updates.carbonReduction,
        mealTypes: {
          breakfast: updates.mealType === "breakfast" ? 1 : 0,
          lunch: updates.mealType === "lunch" ? 1 : 0,
          dinner: updates.mealType === "dinner" ? 1 : 0,
          snack: updates.mealType === "snack" ? 1 : 0,
        },
        createdAt: new Date(),
        updatedAt: new Date(),
      },
    });
  }
}
```

### 5.3 é¥¿äº†ä¹ˆè®¢å•åŒæ­¥ï¼ˆç±»ä¼¼ç»“æ„ï¼‰

```javascript
// cloudfunctions/sync/eleme-sync/index.js
// ç»“æ„ä¸ç¾å›¢ç±»ä¼¼ï¼Œåªæ˜¯APIè°ƒç”¨å’Œæ˜ å°„é€»è¾‘ä¸åŒ

exports.main = async (event) => {
  // ç±»ä¼¼ç¾å›¢çš„å®ç°ï¼Œä½†è°ƒç”¨é¥¿äº†ä¹ˆAPI
  // ...
};
```

---

## å…­ã€æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 6.1 åˆ›å»ºæ‰€æœ‰é›†åˆå’Œç´¢å¼•

```javascript
// cloudfunctions/database/init-collections.js
const cloud = require("wx-server-sdk");
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

/**
 * åˆå§‹åŒ–æ‰€æœ‰æ•°æ®åº“é›†åˆå’Œç´¢å¼•
 */
exports.main = async (event) => {
  const results = [];

  try {
    // 1. åˆ›å»ºusersé›†åˆ
    await createUsersCollection();
    results.push({ collection: "users", status: "success" });

    // 2. åˆ›å»ºuser_sessionsé›†åˆ
    await createUserSessionsCollection();
    results.push({ collection: "user_sessions", status: "success" });

    // 3. åˆ›å»ºmealsé›†åˆ
    await createMealsCollection();
    results.push({ collection: "meals", status: "success" });

    // 4. åˆ›å»ºdaily_statsé›†åˆ
    await createDailyStatsCollection();
    results.push({ collection: "daily_stats", status: "success" });

    // 5. åˆ›å»ºgardensé›†åˆ
    await createGardensCollection();
    results.push({ collection: "gardens", status: "success" });

    // 6. åˆ›å»ºingredientsé›†åˆ
    await createIngredientsCollection();
    results.push({ collection: "ingredients", status: "success" });

    // 7. åˆ›å»ºrecipesé›†åˆ
    await createRecipesCollection();
    results.push({ collection: "recipes", status: "success" });

    // 8. åˆ›å»ºsync_tasksé›†åˆ
    await createSyncTasksCollection();
    results.push({ collection: "sync_tasks", status: "success" });

    // 9. åˆ›å»ºplatform_configsé›†åˆ
    await createPlatformConfigsCollection();
    results.push({ collection: "platform_configs", status: "success" });

    // 10. åˆ›å»ºfriendsé›†åˆ
    await createFriendsCollection();
    results.push({ collection: "friends", status: "success" });

    // 11. åˆ›å»ºpostsé›†åˆ
    await createPostsCollection();
    results.push({ collection: "posts", status: "success" });

    // 12. åˆ›å»ºordersé›†åˆ
    await createOrdersCollection();
    results.push({ collection: "orders", status: "success" });

    // 13. åˆ›å»ºmeat_productsé›†åˆ
    await createMeatProductsCollection();
    results.push({ collection: "meat_products", status: "success" });

    return {
      code: 0,
      message: "Database initialization completed (13 collections)",
      results,
    };
  } catch (error) {
    console.error("Database initialization failed:", error);
    return {
      code: 500,
      message: "Initialization failed",
      error: error.message,
      results,
    };
  }
};

// åˆ›å»ºusersé›†åˆå’Œç´¢å¼•
async function createUsersCollection() {
  try {
    await db.createCollection("users");
  } catch (e) {
    console.log("users collection may already exist");
  }

  // åˆ›å»ºç´¢å¼•
  await db.collection("users").createIndex({
    keys: { openId: 1 },
    unique: true,
    name: "openId_unique",
  });

  await db.collection("users").createIndex({
    keys: { level: -1, points: -1 },
    name: "level_points_ranking",
  });

  await db.collection("users").createIndex({
    keys: { lastLoginAt: -1 },
    name: "lastLoginAt_index",
  });
}

// åˆ›å»ºuser_sessionsé›†åˆå’Œç´¢å¼•
async function createUserSessionsCollection() {
  try {
    await db.createCollection("user_sessions");
  } catch (e) {
    console.log("user_sessions collection may already exist");
  }

  await db.collection("user_sessions").createIndex({
    keys: { userId: 1, expiresAt: 1 },
    name: "userId_expiresAt_index",
  });

  await db.collection("user_sessions").createIndex({
    keys: { accessToken: 1 },
    name: "accessToken_index",
  });

  await db.collection("user_sessions").createIndex({
    keys: { expiresAt: 1 },
    expireAfterSeconds: 0,
    name: "expiresAt_ttl",
  });
}

// åˆ›å»ºmealsé›†åˆå’Œç´¢å¼•
async function createMealsCollection() {
  try {
    await db.createCollection("meals");
  } catch (e) {
    console.log("meals collection may already exist");
  }

  await db.collection("meals").createIndex({
    keys: { userId: 1, mealDate: -1 },
    name: "userId_mealDate_index",
  });

  await db.collection("meals").createIndex({
    keys: { userId: 1, createdAt: -1 },
    name: "userId_createdAt_index",
  });

  await db.collection("meals").createIndex({
    keys: { userId: 1, source: 1, sourceOrderId: 1 },
    unique: true,
    sparse: true,
    name: "userId_source_orderId_unique",
  });

  await db.collection("meals").createIndex({
    keys: { isPublic: 1, createdAt: -1 },
    name: "isPublic_createdAt_index",
  });
}

// åˆ›å»ºdaily_statsé›†åˆå’Œç´¢å¼•
async function createDailyStatsCollection() {
  try {
    await db.createCollection("daily_stats");
  } catch (e) {
    console.log("daily_stats collection may already exist");
  }

  await db.collection("daily_stats").createIndex({
    keys: { userId: 1, date: -1 },
    name: "userId_date_index",
  });

  await db.collection("daily_stats").createIndex({
    keys: { date: -1, totalCarbonReduction: -1 },
    name: "date_carbonReduction_ranking",
  });

  await db.collection("daily_stats").createIndex({
    keys: { userId: 1, date: 1 },
    unique: true,
    name: "userId_date_unique",
  });
}

// åˆ›å»ºgardensé›†åˆå’Œç´¢å¼•
async function createGardensCollection() {
  try {
    await db.createCollection("gardens");
  } catch (e) {
    console.log("gardens collection may already exist");
  }

  await db.collection("gardens").createIndex({
    keys: { userId: 1 },
    unique: true,
    name: "userId_unique",
  });
}

// åˆ›å»ºingredientsé›†åˆå’Œç´¢å¼•
async function createIngredientsCollection() {
  try {
    await db.createCollection("ingredients");
  } catch (e) {
    console.log("ingredients collection may already exist");
  }

  await db.collection("ingredients").createIndex({
    keys: { name: 1 },
    name: "name_index",
  });

  await db.collection("ingredients").createIndex({
    keys: { category: 1 },
    name: "category_index",
  });

  // å…¨æ–‡æœç´¢ç´¢å¼•
  await db.collection("ingredients").createIndex({
    keys: { name: "text", nameEn: "text" },
    name: "name_fulltext",
    weights: { name: 10, nameEn: 5 },
    default_language: "chinese",
  });
}

// åˆ›å»ºrecipesé›†åˆå’Œç´¢å¼•
async function createRecipesCollection() {
  try {
    await db.createCollection("recipes");
  } catch (e) {
    console.log("recipes collection may already exist");
  }

  await db.collection("recipes").createIndex({
    keys: { name: "text" },
    name: "name_fulltext",
  });

  await db.collection("recipes").createIndex({
    keys: { usageCount: -1 },
    name: "usageCount_index",
  });
}

// åˆ›å»ºsync_tasksé›†åˆå’Œç´¢å¼•
async function createSyncTasksCollection() {
  try {
    await db.createCollection("sync_tasks");
  } catch (e) {
    console.log("sync_tasks collection may already exist");
  }

  await db.collection("sync_tasks").createIndex({
    keys: { userId: 1, platform: 1, status: 1 },
    name: "userId_platform_status_index",
  });

  await db.collection("sync_tasks").createIndex({
    keys: { status: 1, nextRetry: 1 },
    name: "status_nextRetry_index",
  });

  await db.collection("sync_tasks").createIndex({
    keys: { platform: 1, orderId: 1 },
    unique: true,
    sparse: true,
    name: "platform_orderId_unique",
  });

  await db.collection("sync_tasks").createIndex({
    keys: { createdAt: 1 },
    expireAfterSeconds: 2592000, // 30å¤©
    name: "createdAt_ttl",
  });
}

// åˆ›å»ºplatform_configsé›†åˆå’Œç´¢å¼•
async function createPlatformConfigsCollection() {
  try {
    await db.createCollection("platform_configs");
  } catch (e) {
    console.log("platform_configs collection may already exist");
  }

  await db.collection("platform_configs").createIndex({
    keys: { platform: 1 },
    unique: true,
    name: "platform_unique",
  });
}

// åˆ›å»ºfriendsé›†åˆå’Œç´¢å¼•
async function createFriendsCollection() {
  try {
    await db.createCollection("friends");
  } catch (e) {
    console.log("friends collection may already exist");
  }

  await db.collection("friends").createIndex({
    keys: { userId: 1, friendId: 1 },
    unique: true,
    name: "userId_friendId_unique",
  });

  await db.collection("friends").createIndex({
    keys: { userId: 1, status: 1 },
    name: "userId_status_index",
  });
}

// åˆ›å»ºpostsé›†åˆå’Œç´¢å¼•
async function createPostsCollection() {
  try {
    await db.createCollection("posts");
  } catch (e) {
    console.log("posts collection may already exist");
  }

  await db.collection("posts").createIndex({
    keys: { userId: 1, createdAt: -1 },
    name: "userId_createdAt_index",
  });

  await db.collection("posts").createIndex({
    keys: { visibility: 1, createdAt: -1 },
    name: "visibility_createdAt_index",
  });
}

// åˆ›å»ºordersé›†åˆå’Œç´¢å¼•
async function createOrdersCollection() {
  try {
    await db.createCollection("orders");
  } catch (e) {
    console.log("orders collection may already exist");
  }

  await db.collection("orders").createIndex({
    keys: { orderNo: 1 },
    unique: true,
    name: "orderNo_unique",
  });

  await db.collection("orders").createIndex({
    keys: { userId: 1, createdAt: -1 },
    name: "userId_createdAt_index",
  });
}

// åˆ›å»ºmeat_productsé›†åˆå’Œç´¢å¼•
async function createMeatProductsCollection() {
  try {
    await db.createCollection("meat_products");
  } catch (e) {
    console.log("meat_products collection may already exist");
  }

  await db.collection("meat_products").createIndex({
    keys: { name: 1 },
    unique: true,
    name: "name_unique",
  });

  await db.collection("meat_products").createIndex({
    keys: { category: 1, subcategory: 1 },
    name: "category_subcategory_index",
  });

  await db.collection("meat_products").createIndex({
    keys: { carbonFootprint: -1 },
    name: "carbonFootprint_index",
  });

  await db.collection("meat_products").createIndex({
    keys: { status: 1 },
    name: "status_index",
  });
}
```

---

## ä¸ƒã€æ•°æ®å¤‡ä»½ä¸æ¢å¤

### 7.1 æ¯æ—¥å¤‡ä»½äº‘å‡½æ•°

```javascript
// cloudfunctions/maintenance/backup/index.js
const cloud = require("wx-server-sdk");
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });
const db = cloud.database();

/**
 * æ¯æ—¥å¤‡ä»½äº‘å‡½æ•°ï¼ˆå®šæ—¶è§¦å‘ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
 */
exports.main = async (event) => {
  const collections = ["users", "meals", "gardens", "daily_stats"];
  const backupResults = [];

  for (const collName of collections) {
    try {
      console.log(`Starting backup for ${collName}...`);

      // åˆ†æ‰¹å¯¼å‡ºæ•°æ®ï¼ˆæ¯æ¬¡1000æ¡ï¼‰
      let allData = [];
      let skip = 0;
      const batchSize = 1000;

      while (true) {
        const batch = await db
          .collection(collName)
          .skip(skip)
          .limit(batchSize)
          .get();

        if (batch.data.length === 0) break;

        allData = allData.concat(batch.data);
        skip += batchSize;

        if (batch.data.length < batchSize) break;
      }

      // ä¸Šä¼ åˆ°äº‘å­˜å‚¨
      const timestamp = Date.now();
      const fileName = `backup/${collName}_${timestamp}.json`;

      await cloud.uploadFile({
        cloudPath: fileName,
        fileContent: Buffer.from(JSON.stringify(allData, null, 2)),
      });

      backupResults.push({
        collection: collName,
        recordCount: allData.length,
        fileName: fileName,
        status: "success",
      });

      console.log(
        `Backup completed for ${collName}: ${allData.length} records`
      );
    } catch (error) {
      console.error(`Backup failed for ${collName}:`, error);
      backupResults.push({
        collection: collName,
        status: "failed",
        error: error.message,
      });
    }
  }

  // è®°å½•å¤‡ä»½æ—¥å¿—
  await db.collection("backup_logs").add({
    data: {
      backupTime: new Date(),
      results: backupResults,
      success: backupResults.every((r) => r.status === "success"),
    },
  });

  return {
    code: 0,
    message: "Backup completed",
    results: backupResults,
  };
};
```

---

## å…«ã€æ€§èƒ½ç›‘æ§

### 8.1 æ…¢æŸ¥è¯¢ç›‘æ§

```javascript
// cloudfunctions/maintenance/monitor/index.js
const cloud = require("wx-server-sdk");
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

/**
 * æ€§èƒ½ç›‘æ§äº‘å‡½æ•°
 * åœ¨å…¶ä»–äº‘å‡½æ•°ä¸­è°ƒç”¨æ­¤å‡½æ•°è®°å½•æ…¢æŸ¥è¯¢
 */
exports.logSlowQuery = async (collection, query, duration) => {
  if (duration > 200) {
    // è¶…è¿‡200msè®°å½•
    console.warn(`Slow query detected: ${collection}, duration: ${duration}ms`);

    // å¯ä»¥å°†æ…¢æŸ¥è¯¢è®°å½•åˆ°ä¸“é—¨çš„é›†åˆæˆ–æ—¥å¿—æœåŠ¡
    // è¿™é‡Œç®€åŒ–ä¸ºæ§åˆ¶å°è¾“å‡º
  }
};

/**
 * æ•°æ®åº“å®¹é‡æ£€æŸ¥ï¼ˆæ¯å‘¨æ‰§è¡Œï¼‰
 */
exports.checkCapacity = async (event) => {
  const db = cloud.database();
  const collections = [
    "users",
    "meals",
    "gardens",
    "daily_stats",
    "ingredients",
    "meat_products",
  ];

  const report = [];

  for (const collName of collections) {
    const count = await db.collection(collName).count();
    report.push({
      collection: collName,
      documentCount: count.total,
      estimatedSize: estimateSize(collName, count.total),
    });
  }

  const totalSize = report.reduce((sum, item) => sum + item.estimatedSize, 0);

  return {
    code: 0,
    report,
    totalSize: formatBytes(totalSize),
    needsAction: totalSize > 80 * 1024 * 1024 * 1024, // è¶…è¿‡80GB
  };
};

// ä¼°ç®—é›†åˆå¤§å°
function estimateSize(collection, count) {
  const avgSizes = {
    users: 3 * 1024, // 3KB
    meals: 1.5 * 1024, // 1.5KB
    gardens: 2 * 1024, // 2KB
    daily_stats: 0.5 * 1024, // 0.5KB
    ingredients: 3 * 1024, // 3KB
    meat_products: 2 * 1024, // 2KB
  };

  return (avgSizes[collection] || 1024) * count;
}

// æ ¼å¼åŒ–å­—èŠ‚
function formatBytes(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + " KB";
  if (bytes < 1024 * 1024 * 1024)
    return (bytes / 1024 / 1024).toFixed(2) + " MB";
  return (bytes / 1024 / 1024 / 1024).toFixed(2) + " GB";
}
```

---

## ä¹ã€å®¹é‡è§„åˆ’ï¼ˆ10 ä¸‡ç”¨æˆ·ï¼‰

### 9.1 å­˜å‚¨å®¹é‡ä¼°ç®—

| é›†åˆ             | å•æ¡å¤§å° | æ¡æ•°ä¼°ç®—   | æ€»å®¹é‡    |
| ---------------- | -------- | ---------- | --------- |
| users            | 3KB      | 100,000    | 300MB     |
| user_sessions    | 0.5KB    | 200,000    | 100MB     |
| meals            | 1.5KB    | 36,000,000 | 54GB      |
| daily_stats      | 0.5KB    | 36,500,000 | 18GB      |
| gardens          | 2KB      | 100,000    | 200MB     |
| ingredients      | 3KB      | 5,000      | 15MB      |
| recipes          | 5KB      | 10,000     | 50MB      |
| sync_tasks       | 0.5KB    | 1,000,000  | 500MB     |
| platform_configs | 10KB     | 10         | 100KB     |
| friends          | 0.2KB    | 3,000,000  | 600MB     |
| posts            | 2KB      | 3,000,000  | 6GB       |
| orders           | 1KB      | 500,000    | 500MB     |
| meat_products    | 2KB      | 81         | 162KB     |
| **æ€»è®¡**         | -        | -          | **â‰ˆ80GB** |

**å»ºè®®é…ç½®**: 100GB å­˜å‚¨ç©ºé—´ï¼ˆé¢„ç•™ 20%å¢é•¿ï¼‰

### 9.2 æ€§èƒ½ä¼°ç®—

#### æ—¥æ´» 1-3 ä¸‡ç”¨æˆ·åœºæ™¯

- **æ¯æ—¥æŸ¥è¯¢é‡**: çº¦ 1000 ä¸‡æ¬¡ï¼ˆæ¯ç”¨æˆ·å¹³å‡ 300-400 æ¬¡è¯·æ±‚ï¼‰
- **æ¯æ—¥å†™å…¥é‡**: çº¦ 100 ä¸‡æ¬¡ï¼ˆé¤é£Ÿè®°å½•ã€ç»Ÿè®¡æ›´æ–°ç­‰ï¼‰
- **å³°å€¼ QPS**: çº¦ 200-500ï¼ˆæ™šé¤æ—¶æ®µï¼‰

#### æ•°æ®åº“æ€§èƒ½è¦æ±‚

- **å•æ¬¡æŸ¥è¯¢å“åº”**: <50msï¼ˆ95%ileï¼‰
- **å¤æ‚èšåˆæŸ¥è¯¢**: <200msï¼ˆ95%ileï¼‰
- **å¹¶å‘è¿æ¥æ•°**: 100-200
- **æ•°æ®åº“å®ä¾‹**: 2 æ ¸ 4GB å³å¯æ»¡è¶³

### 9.3 æˆæœ¬ä¼°ç®—ï¼ˆè…¾è®¯äº‘å¼€å‘ï¼‰

#### æœˆåº¦æˆæœ¬æ˜ç»†

| é¡¹ç›®         | ç”¨é‡         | å•ä»·             | æœˆè´¹ç”¨    |
| ------------ | ------------ | ---------------- | --------- |
| **æ•°æ®åº“**   |
| å­˜å‚¨å®¹é‡     | 100GB        | Â¥0.07/GB/å¤©      | Â¥210      |
| è¯»æ“ä½œ       | 1000 ä¸‡æ¬¡/å¤© | Â¥0.015/ä¸‡æ¬¡      | Â¥45       |
| å†™æ“ä½œ       | 100 ä¸‡æ¬¡/å¤©  | Â¥0.05/ä¸‡æ¬¡       | Â¥150      |
| **äº‘å­˜å‚¨**   |
| å­˜å‚¨å®¹é‡     | 50GB         | Â¥0.0043/GB/å¤©    | Â¥6.5      |
| CDN æµé‡     | 100GB        | Â¥0.18/GB         | Â¥18       |
| **äº‘å‡½æ•°**   |
| è°ƒç”¨æ¬¡æ•°     | 5000 ä¸‡æ¬¡    | Â¥0.0133/ä¸‡æ¬¡     | Â¥66.5     |
| èµ„æºä½¿ç”¨     | 10 ä¸‡ GBÂ·s   | Â¥0.00011639/GBÂ·s | Â¥11.6     |
| **å…¶ä»–**     |
| å¤‡ä»½å­˜å‚¨     | 20GB         | Â¥0.0043/GB/å¤©    | Â¥2.6      |
| **æœˆåº¦æ€»è®¡** | -            | -                | **â‰ˆÂ¥510** |

**å¹´åº¦æˆæœ¬**: çº¦ **Â¥6,120**

---

## åã€å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1 å‘¨ï¼‰

#### Day 1-2: æ•°æ®åº“åˆå§‹åŒ–

- [ ] åˆ›å»º 13 ä¸ªæ ¸å¿ƒé›†åˆ
- [ ] é…ç½® 32 ä¸ªç´¢å¼•
- [ ] æµ‹è¯•ç´¢å¼•æ€§èƒ½

#### Day 3-4: åŸºç¡€å·¥å…·

- [ ] å®ç°åŠ å¯†å·¥å…·ï¼ˆSHA-256ï¼‰
- [ ] å®ç°æƒé™æ£€æŸ¥ä¸­é—´ä»¶
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

#### Day 5-7: æ ¸å¿ƒäº‘å‡½æ•°

- [ ] æ›´æ–° login äº‘å‡½æ•°ï¼ˆæ”¯æŒå“ˆå¸Œ OpenIDï¼‰
- [ ] æ›´æ–° user äº‘å‡½æ•°
- [ ] æ›´æ–° garden äº‘å‡½æ•°
- [ ] æ›´æ–° carbon äº‘å‡½æ•°

### ç¬¬äºŒé˜¶æ®µï¼šç¬¬ä¸‰æ–¹åŒæ­¥ï¼ˆ1 å‘¨ï¼‰

#### Day 1-3: ç¾å›¢åŒæ­¥

- [ ] åˆ›å»º sync_tasks é›†åˆ
- [ ] åˆ›å»º platform_configs é›†åˆ
- [ ] å®ç°ç¾å›¢è®¢å•åŒæ­¥äº‘å‡½æ•°
- [ ] é…ç½®é£Ÿææ˜ å°„è¡¨
- [ ] æµ‹è¯•åŒæ­¥æµç¨‹

#### Day 4-6: é¥¿äº†ä¹ˆåŒæ­¥

- [ ] å®ç°é¥¿äº†ä¹ˆè®¢å•åŒæ­¥äº‘å‡½æ•°
- [ ] é…ç½®é¥¿äº†ä¹ˆé£Ÿææ˜ å°„
- [ ] æµ‹è¯•åŒæ­¥æµç¨‹

#### Day 7: åŒæ­¥ä»»åŠ¡ç®¡ç†

- [ ] å®ç°å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] é…ç½®å®šæ—¶æ¸…ç†ä»»åŠ¡
- [ ] ç›‘æ§å‘Šè­¦é…ç½®

### ç¬¬ä¸‰é˜¶æ®µï¼šç¤¾äº¤å’Œå•†åŸï¼ˆ3 å¤©ï¼‰

#### Day 1: ç¤¾äº¤åŠŸèƒ½

- [ ] åˆ›å»º friends é›†åˆ
- [ ] åˆ›å»º posts é›†åˆ
- [ ] å®ç°å¥½å‹æ·»åŠ åŠŸèƒ½
- [ ] å®ç°åŠ¨æ€å‘å¸ƒåŠŸèƒ½

#### Day 2: ç§¯åˆ†å•†åŸ

- [ ] åˆ›å»º orders é›†åˆ
- [ ] å®ç°è®¢å•åˆ›å»º
- [ ] å®ç°ç§¯åˆ†å…‘æ¢

#### Day 3: æµ‹è¯•å’Œä¼˜åŒ–

- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] Bug ä¿®å¤

### ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å’Œä¸Šçº¿ï¼ˆ3 å¤©ï¼‰

#### Day 1: æ€§èƒ½ä¼˜åŒ–

- [ ] æ…¢æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç´¢å¼•è°ƒä¼˜
- [ ] ç¼“å­˜ç­–ç•¥

#### Day 2: è¿ç»´é…ç½®

- [ ] é…ç½®æ¯æ—¥å¤‡ä»½
- [ ] é…ç½®å®¹é‡ç›‘æ§
- [ ] é…ç½®å‘Šè­¦è§„åˆ™

#### Day 3: ä¸Šçº¿å‡†å¤‡

- [ ] æ•°æ®è¿ç§»æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•
- [ ] ç°åº¦å‘å¸ƒ

---

## åä¸€ã€å…³é”®å·®å¼‚å¯¹æ¯”

| é¡¹ç›®             | å®Œæ•´ç‰ˆæ–¹æ¡ˆ           | ç®€åŒ–ç‰ˆæ–¹æ¡ˆï¼ˆå½“å‰ï¼‰       |
| ---------------- | -------------------- | ------------------------ |
| **ç”¨æˆ·è§„æ¨¡**     | 10-100 ä¸‡            | 10 ä¸‡ä»¥å†…                |
| **é›†åˆæ•°é‡**     | 18+                  | 13                       |
| **ç´¢å¼•æ•°é‡**     | 50+                  | 32                       |
| **åŠ å¯†æ–¹æ¡ˆ**     | è…¾è®¯äº‘ KMS + AES-256 | Node.js crypto + SHA-256 |
| **æ•æ„Ÿæ•°æ®å­—æ®µ** | 9 ç±»                 | 3 ç±»                     |
| **å®¡è®¡æ—¥å¿—**     | å®Œæ•´å®¡è®¡ç³»ç»Ÿ         | åŸºç¡€æ—¥å¿—                 |
| **æƒé™æ§åˆ¶**     | è¡Œçº§+åˆ—çº§            | åŸºç¡€ä¸‰çº§                 |
| **åˆ†ç‰‡ç­–ç•¥**     | å†·çƒ­åˆ†ç¦»+åˆ†åŒº        | å•åº“                     |
| **å¤‡ä»½æ–¹æ¡ˆ**     | å®æ—¶+å®šæœŸ+å½’æ¡£       | æ¯æ—¥å¤‡ä»½                 |
| **ç›‘æ§ç³»ç»Ÿ**     | å®Œæ•´ç›‘æ§+å‘Šè­¦        | åŸºç¡€ç›‘æ§                 |
| **æœˆåº¦æˆæœ¬**     | Â¥7,176               | Â¥510                     |
| **å®æ–½å‘¨æœŸ**     | 8 å‘¨                 | 2.5 å‘¨                   |
| **å¼€å‘å¤æ‚åº¦**   | é«˜                   | ä¸­                       |
| **è¿ç»´å¤æ‚åº¦**   | é«˜                   | ä½                       |

---

## åäºŒã€è¿ç§»æŒ‡å—

### 12.1 ä»ç°æœ‰æ•°æ®åº“è¿ç§»

å¦‚æœæ‚¨å·²æœ‰ usersã€mealsã€gardens ç­‰åŸºç¡€é›†åˆï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤è¿ç§»ï¼š

#### Step 1: å¤‡ä»½ç°æœ‰æ•°æ®

```bash
# ä½¿ç”¨äº‘å¼€å‘CLIå¯¼å‡ºæ•°æ®
tcb database:export users -e your-env-id
tcb database:export meals -e your-env-id
tcb database:export gardens -e your-env-id
```

#### Step 2: æ·»åŠ æ–°å­—æ®µ

```javascript
// ä¸ºusersé›†åˆæ·»åŠ æ–°å­—æ®µ
db.collection("users")
  .where({})
  .update({
    data: {
      "stats.totalCarbonReduction": 0,
      "stats.totalMeals": 0,
      "stats.currentStreak": 0,
      "stats.gardenPlantsCount": 0,
      syncedPlatforms: [],
    },
  });

// ä¸ºmealsé›†åˆæ·»åŠ æ–°å­—æ®µ
db.collection("meals")
  .where({})
  .update({
    data: {
      source: "manual",
      isPublic: false,
    },
  });
```

#### Step 3: åˆ›å»ºæ–°é›†åˆ

```javascript
// æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬åˆ›å»ºæ–°é›†åˆ
// daily_stats, sync_tasks, platform_configs, friends, posts, orders
```

#### Step 4: è¿ç§»å†å²æ•°æ®åˆ° daily_stats

```javascript
// èšåˆå†å²é¤é£Ÿæ•°æ®åˆ°daily_stats
// å¯é€šè¿‡äº‘å‡½æ•°æ‰¹é‡æ‰§è¡Œ
```

### 12.2 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

```javascript
// æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
async function checkDataIntegrity() {
  const db = cloud.database();

  // 1. æ£€æŸ¥userså’Œgardensçš„ä¸€è‡´æ€§
  const usersCount = await db.collection("users").count();
  const gardensCount = await db.collection("gardens").count();

  console.log(`Users: ${usersCount.total}, Gardens: ${gardensCount.total}`);

  // 2. æ£€æŸ¥mealså’Œdaily_statsçš„ä¸€è‡´æ€§
  // ...

  // 3. æ£€æŸ¥ç´¢å¼•æ˜¯å¦æ­£å¸¸
  // ...
}
```

---

## åä¸‰ã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä¸ºä»€ä¹ˆä¸ä½¿ç”¨è…¾è®¯äº‘ KMSï¼Ÿ

**A**: å¯¹äº 10 ä¸‡ç”¨æˆ·è§„æ¨¡ï¼ŒNode.js å†…ç½® crypto çš„ SHA-256 å“ˆå¸Œå·²è¶³å¤Ÿå®‰å…¨ï¼Œä¸”ï¼š

- æ— éœ€é¢å¤–çš„ KMS è´¹ç”¨ï¼ˆçº¦ Â¥200/æœˆï¼‰
- ç®€åŒ–å¼€å‘å’Œéƒ¨ç½²æµç¨‹
- æ€§èƒ½æ›´å¥½ï¼ˆæœ¬åœ°è®¡ç®—ï¼‰

### Q2: å¦‚ä½•ä¿è¯ç¬¬ä¸‰æ–¹åŒæ­¥çš„æ•°æ®å®‰å…¨ï¼Ÿ

**A**:

- è®¢å• ID ä½¿ç”¨ SHA-256 å“ˆå¸Œå­˜å‚¨
- API Token åŠ å¯†å­˜å‚¨
- HTTPS ä¼ è¾“
- å®šæœŸæ¸…ç†è¿‡æœŸçš„åŒæ­¥ä»»åŠ¡ï¼ˆ30 å¤©ï¼‰

### Q3: å¦‚æœç”¨æˆ·è¶…è¿‡ 10 ä¸‡æ€ä¹ˆåŠï¼Ÿ

**A**: å¯ä»¥å‡çº§åˆ°å®Œæ•´ç‰ˆæ–¹æ¡ˆï¼š

- å¯ç”¨å†·çƒ­æ•°æ®åˆ†ç¦»
- é…ç½®æ•°æ®åˆ†ç‰‡
- å‡çº§åˆ°è…¾è®¯äº‘ KMS
- å¢åŠ å®¡è®¡æ—¥å¿—ç³»ç»Ÿ

### Q4: daily_stats è¡¨å¦‚ä½•ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

**A**:

- ä½¿ç”¨å”¯ä¸€å¤åˆç´¢å¼•ï¼ˆuserId + dateï¼‰é˜²æ­¢é‡å¤
- ä½¿ç”¨åŸå­æ€§æ›´æ–°æ“ä½œï¼ˆ`_.inc()`ï¼‰
- å®šæœŸæ ¡éªŒå’Œä¿®å¤ä¸ä¸€è‡´æ•°æ®

### Q5: å¤‡ä»½æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

**A**:

- å­˜å‚¨åœ¨è…¾è®¯äº‘å­˜å‚¨ï¼ˆCloud Storageï¼‰
- è·¯å¾„ï¼š`backup/é›†åˆå_æ—¶é—´æˆ³.json`
- å»ºè®®ä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
- å¯é…ç½®è‡ªåŠ¨ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ OSS

---

## åå››ã€åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1-3 ä¸ªæœˆï¼‰

1. **é£Ÿæåº“æ‰©å……**: ä»å½“å‰ 5000 ç§æ‰©å±•åˆ° 1 ä¸‡ç§
2. **é£Ÿææ˜ å°„ä¼˜åŒ–**: æé«˜ç¾å›¢/é¥¿äº†ä¹ˆé£ŸæåŒ¹é…å‡†ç¡®ç‡åˆ° 95%
3. **æŸ¥è¯¢ç¼“å­˜**: å¯¹çƒ­ç‚¹æ•°æ®ï¼ˆæ’è¡Œæ¦œã€çƒ­é—¨é£Ÿè°±ï¼‰å¢åŠ ç¼“å­˜å±‚
4. **å›¾ç‰‡ä¼˜åŒ–**: ä½¿ç”¨è…¾è®¯äº‘ COS+CDN åŠ é€Ÿå›¾ç‰‡åŠ è½½

### ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6 ä¸ªæœˆï¼‰

1. **æ¨èç³»ç»Ÿ**: åŸºäºç”¨æˆ·å†å²æ•°æ®æ¨èé£Ÿè°±
2. **AI è¯†åˆ«**: é›†æˆé£Ÿç‰©å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
3. **æ•°æ®åˆ†æ**: æä¾›æ›´è¯¦ç»†çš„ç¢³è¶³è¿¹åˆ†ææŠ¥å‘Š
4. **ç¤¾äº¤åŠŸèƒ½å¢å¼º**: æ·»åŠ è¯„è®ºã€ç‚¹èµã€åˆ†äº«ç­‰åŠŸèƒ½

### é•¿æœŸä¼˜åŒ–ï¼ˆ6-12 ä¸ªæœˆï¼‰

1. **å¤šå¹³å°æ”¯æŒ**: æ¥å…¥æ›´å¤šå¤–å–å¹³å°ï¼ˆäº¬ä¸œåˆ°å®¶ã€ç›’é©¬ç­‰ï¼‰
2. **ä¼ä¸šç‰ˆåŠŸèƒ½**: æ”¯æŒä¼ä¸šå›¢é˜Ÿç¢³å‡æ’ç®¡ç†
3. **æ•°æ®å¯¼å‡º**: æ”¯æŒä¸ªäººç¢³è¶³è¿¹æŠ¥å‘Šå¯¼å‡º
4. **å›½é™…åŒ–**: æ”¯æŒè‹±æ–‡ã€æ—¥æ–‡ç­‰å¤šè¯­è¨€

---

## é™„å½• Aï¼šæ–‡ä»¶æ¸…å•

### äº‘å‡½æ•°ç›®å½•ç»“æ„

```
cloudfunctions/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ encryption.js           # åŠ å¯†å·¥å…·ï¼ˆ200è¡Œï¼‰
â”‚   â””â”€â”€ permission.js           # æƒé™æ£€æŸ¥ï¼ˆ150è¡Œï¼‰
â”‚
â”œâ”€â”€ database/
â”‚   â””â”€â”€ init-collections.js     # æ•°æ®åº“åˆå§‹åŒ–ï¼ˆ500è¡Œï¼‰
â”‚
â”œâ”€â”€ sync/
â”‚   â”œâ”€â”€ meituan-sync/
â”‚   â”‚   â”œâ”€â”€ index.js           # ç¾å›¢åŒæ­¥ï¼ˆ300è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ eleme-sync/
â”‚       â”œâ”€â”€ index.js           # é¥¿äº†ä¹ˆåŒæ­¥ï¼ˆ300è¡Œï¼‰
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ maintenance/
â”‚   â”œâ”€â”€ backup/
â”‚   â”‚   â”œâ”€â”€ index.js           # å¤‡ä»½ï¼ˆ150è¡Œï¼‰
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â””â”€â”€ monitor/
â”‚       â”œâ”€â”€ index.js           # ç›‘æ§ï¼ˆ100è¡Œï¼‰
â”‚       â””â”€â”€ package.json
â”‚
â””â”€â”€ [ç°æœ‰äº‘å‡½æ•°]
    â”œâ”€â”€ login/
    â”œâ”€â”€ user/
    â”œâ”€â”€ garden/
    â””â”€â”€ carbon/
```

**æ€»è®¡æ–°å¢ä»£ç **: çº¦ 1700 è¡Œ

---

## é™„å½• Bï¼šç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶é…ç½®

# è…¾è®¯äº‘å¼€å‘
CLOUDBASE_ENVID=your-env-id
CLOUDBASE_REGION=ap-shanghai

# å¾®ä¿¡å°ç¨‹åº
WECHAT_APPID=your-wechat-appid
WECHAT_SECRET=your-wechat-secret

# åŠ å¯†ç›å€¼
ENCRYPTION_SALT=my-garden-salt-2025-change-this

# ç¾å›¢APIé…ç½®
MEITUAN_API_ENDPOINT=https://api.meituan.com
MEITUAN_API_KEY=your-meituan-api-key
MEITUAN_API_SECRET=your-meituan-api-secret

# é¥¿äº†ä¹ˆAPIé…ç½®
ELEME_API_ENDPOINT=https://api.ele.me
ELEME_API_KEY=your-eleme-api-key
ELEME_API_SECRET=your-eleme-api-secret
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-11  
**æ›´æ–°æ—¥æœŸ**: 2025-10-14  
**é€‚ç”¨è§„æ¨¡**: 10 ä¸‡ç”¨æˆ·ä»¥å†…  
**é¢„ä¼°æˆæœ¬**: Â¥510/æœˆ  
**å®æ–½å‘¨æœŸ**: 2.5 å‘¨

**ç»´æŠ¤å›¢é˜Ÿ**: MyGarden å¼€å‘å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2025-10-14

---

## ç‰ˆæœ¬æ›´æ–°è®°å½•

### v1.1 (2025-10-14)

**æ–°å¢å†…å®¹**ï¼š

- æ–°å¢ `meat_products` é›†åˆï¼ˆè‚‰ç±»ç¢³è¶³è¿¹æ•°æ®åº“ï¼‰
- 81 ç§è‚‰ç±»äº§å“æ•°æ®ï¼ˆçº¢è‚‰/ç¦½è‚‰/æ°´äº§/åŠ å·¥è‚‰ï¼‰
- 4 ä¸ª meat_products é›†åˆç´¢å¼•
- æ”¯æŒ"ç´ é£Ÿ vs è‚‰é£Ÿ"å¯¹æ¯”è®¡ç®—åŠŸèƒ½

**é›†åˆæ€»æ•°**ï¼š12 ä¸ª â†’ 13 ä¸ª  
**ç´¢å¼•æ€»æ•°**ï¼š28 ä¸ª â†’ 32 ä¸ª

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

- ç¢³æ’æ”¾å¯¹æ¯”è®¡ç®—
- ç´ é£Ÿæ›¿ä»£å“æ¨è
- å‡æ’é‡å¯è§†åŒ–å±•ç¤º

### v1.0 (2025-01-11)

**åˆå§‹ç‰ˆæœ¬**ï¼š

- 12 ä¸ªæ ¸å¿ƒé›†åˆè®¾è®¡
- 28 ä¸ªæ ¸å¿ƒç´¢å¼•
- åŸºç¡€å®‰å…¨æ–¹æ¡ˆ
- ç¬¬ä¸‰æ–¹åŒæ­¥æ”¯æŒ
