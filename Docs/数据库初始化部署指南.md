# 数据库初始化部署指南

## ⚠️ 重要说明（v1.1 更新）

**由于腾讯云开发限制**:

- ✅ 云函数可以创建集合（12 个）
- ❌ 云函数无法创建索引（需手动）
- 📖 索引创建请参考: [数据库索引创建手册.md](./数据库索引创建手册.md)

## 📋 概述

本文档说明如何部署和执行数据库初始化脚本，为"我的花园"项目创建 12 个核心集合，并指导手动创建 28 个索引。

## 🎯 初始化目标

- ✅ 创建 12 个核心集合
- ✅ 配置 28 个数据库索引
- ✅ 验证索引性能
- ✅ 确保查询速度满足要求（个人数据 <50ms）

## 📦 准备工作

### 1. 确认环境配置

确保已完成腾讯云开发环境配置：

```bash
# 检查云开发CLI是否安装
tcb --version

# 如果未安装，执行
npm install -g @cloudbase/cli

# 登录腾讯云
tcb login
```

### 2. 获取环境 ID

在腾讯云开发控制台获取您的环境 ID（env-id）：

- 登录 https://console.cloud.tencent.com/tcb
- 复制环境 ID，格式如：`my-garden-app-env-xxxxxx`

## 🚀 部署步骤

### 方法一：通过云开发控制台部署（推荐）

#### Step 1: 上传云函数

```bash
cd cloudfunctions/database

# 安装依赖
npm install

# 部署到云端
tcb fn deploy database --envId your-env-id
```

#### Step 2: 在控制台执行

1. 打开腾讯云开发控制台
2. 进入「云函数」管理
3. 找到 `database` 函数
4. 点击「测试」
5. 输入测试参数（空对象）:
   ```json
   {}
   ```
6. 点击「运行测试」
7. 查看执行日志

预期输出：

```
========================================
开始初始化数据库...
========================================

[1/12] 创建users集合...
  配置索引...
  ✓ openId_unique (唯一索引)
  ✓ level_points_ranking (复合降序)
  ✓ lastLoginAt_index (降序)
✅ users集合创建成功

[2/12] 创建user_sessions集合...
...

========================================
🎉 数据库初始化完成！
========================================
总计创建: 12/12 个集合
总计配置: 28 个索引
========================================
```

### 方法二：通过命令行部署

```bash
# 进入云函数目录
cd cloudfunctions/database

# 安装依赖
npm install

# 部署并立即调用
tcb fn deploy database --envId your-env-id && \
tcb fn invoke database --envId your-env-id
```

### 方法三：在小程序中调用

如果您已经部署了云函数，可以在小程序代码中直接调用：

```javascript
// 在小程序中调用初始化
wx.cloud
  .callFunction({
    name: "database",
    data: {},
  })
  .then((res) => {
    console.log("✅ 数据库初始化成功");
    console.log("创建集合数:", res.result.summary.totalCollections);
    console.log("创建索引数:", res.result.summary.totalIndexes);
  })
  .catch((err) => {
    console.error("❌ 初始化失败:", err);
  });
```

## ✅ 验证步骤

### 1. 检查集合创建

在云开发控制台：

1. 进入「数据库」管理
2. 查看集合列表
3. 应该看到以下 12 个集合：

```
✓ users
✓ user_sessions
✓ meals
✓ daily_stats
✓ gardens
✓ ingredients
✓ recipes
✓ sync_tasks
✓ platform_configs
✓ friends
✓ posts
✓ orders
```

### 2. 测试索引性能

部署性能测试云函数：

```bash
cd cloudfunctions/database

# 使用相同的部署命令，但指定test-indexes
tcb fn deploy database --envId your-env-id

# 调用性能测试
tcb fn invoke database:test-indexes --envId your-env-id
```

或者在控制台手动调用 `test-indexes.js`。

预期结果：

```
========================================
测试完成！汇总结果：
========================================

通过: 10/10
平均查询时间: 45ms
性能等级: A+ (优秀)

✅ [1] users.用户登录查询
   耗时: 32ms (预期: <50ms)
✅ [2] users.排行榜查询
   耗时: 78ms (预期: <100ms)
...
```

### 3. 手动验证查询性能

在小程序或云函数中测试：

```javascript
// 测试用户查询
const startTime = Date.now();
const user = await db
  .collection("users")
  .where({ openId: "test-openid" })
  .get();
const duration = Date.now() - startTime;
console.log("用户查询耗时:", duration, "ms"); // 应该 <50ms

// 测试餐食记录查询
const startTime2 = Date.now();
const meals = await db
  .collection("meals")
  .where({ userId: "test-user-id" })
  .orderBy("mealDate", "desc")
  .limit(10)
  .get();
const duration2 = Date.now() - startTime2;
console.log("餐食查询耗时:", duration2, "ms"); // 应该 <50ms
```

## 🔍 故障排查

### 问题 1: 部署失败 - "函数不存在"

**解决方案**:

```bash
# 确保在正确的目录
cd cloudfunctions/database

# 检查文件结构
ls -la
# 应该看到: init-collections.js, package.json, README.md

# 重新部署
tcb fn deploy database --envId your-env-id --force
```

### 问题 2: 执行超时

**原因**: 首次创建索引可能需要较长时间

**解决方案**:

1. 在控制台设置函数超时时间为 60 秒
2. 或者分批创建集合

### 问题 3: 索引创建冲突

**错误信息**: "Index already exists"

**解决方案**: 这是正常情况，脚本会自动跳过已存在的索引

### 问题 4: 权限不足

**错误信息**: "Permission denied"

**解决方案**:

1. 检查云函数是否有数据库管理权限
2. 在云开发控制台 → 云函数 → 权限设置
3. 确保开启「数据库完全控制权限」

### 问题 5: 查询性能不达标

**症状**: 测试显示查询时间 >100ms

**解决方案**:

1. 检查索引是否正确创建
2. 清空测试数据，索引在空数据库上可能不生效
3. 插入一些测试数据后重新测试
4. 检查网络延迟（控制台测试 vs 本地测试）

## 📊 性能基准

根据设计目标，查询性能应满足：

| 查询类型     | 目标性能 | 实测平均 | 状态 |
| ------------ | -------- | -------- | ---- |
| 个人数据查询 | <50ms    | ~30-40ms | ✅   |
| 排行榜查询   | <100ms   | ~60-80ms | ✅   |
| 防重复查询   | <20ms    | ~10-15ms | ✅   |
| 全文搜索     | <200ms   | ~150ms   | ✅   |
| 复杂聚合     | <300ms   | ~200ms   | ✅   |

## 📝 数据库集合详情

### 核心业务集合（7 个）

1. **users** - 用户主表

   - 索引: 3 个
   - 预计容量: 300MB (10 万用户)

2. **meals** - 餐食记录表

   - 索引: 4 个（含防重）
   - 预计容量: 54GB (3600 万条记录)
   - ⚠️ 最大集合，需重点优化

3. **daily_stats** - 每日统计表

   - 索引: 3 个
   - 预计容量: 18GB (3650 万条记录)

4. **gardens** - 花园表

   - 索引: 1 个
   - 预计容量: 200MB (10 万用户)

5. **ingredients** - 食材库

   - 索引: 3 个（含全文搜索）
   - 预计容量: 15MB (5000 种)

6. **recipes** - 食谱库

   - 索引: 2 个
   - 预计容量: 50MB (1 万个)

7. **orders** - 订单表
   - 索引: 2 个
   - 预计容量: 500MB (50 万订单)

### 第三方同步集合（2 个）

8. **sync_tasks** - 同步任务表

   - 索引: 4 个（含 TTL 自动清理）
   - 预计容量: 500MB
   - 🔄 30 天自动清理

9. **platform_configs** - 平台配置表
   - 索引: 1 个
   - 预计容量: 100KB (10 个平台)

### 社交功能集合（2 个）

10. **friends** - 好友关系表

    - 索引: 2 个
    - 预计容量: 600MB (300 万关系)

11. **posts** - 动态表
    - 索引: 2 个
    - 预计容量: 6GB (300 万动态)

### 会话管理集合（1 个）

12. **user_sessions** - 会话表
    - 索引: 3 个（含 TTL 自动清理）
    - 预计容量: 100MB
    - 🔄 自动清理过期会话

## 🎯 下一步

数据库初始化完成后，继续执行：

### Day 3-4: 基础工具实现

```bash
# 创建加密工具
cloudfunctions/common/encryption.js

# 创建权限检查中间件
cloudfunctions/common/permission.js
```

### Day 5-7: 核心云函数更新

更新现有云函数以使用新的数据库结构：

- [ ] login 云函数 - 支持 OpenID 哈希
- [ ] user 云函数 - 支持新的 stats 字段
- [ ] garden 云函数 - 适配新索引
- [ ] carbon 云函数 - 适配 daily_stats

## 📚 相关文档

- [数据库架构设计文档-简化版](./数据库架构设计文档-简化版.md) - 完整架构说明
- [腾讯云开发环境配置指南](./腾讯云开发环境配置指南.md) - 环境配置
- [云函数 README](../cloudfunctions/database/README.md) - 详细使用说明

## 💡 常见问题

### Q1: 可以重复执行初始化吗？

**A**: 可以，脚本具有幂等性。已存在的集合和索引会被自动跳过。

### Q2: 初始化会删除现有数据吗？

**A**: 不会，脚本只创建集合和索引，不会删除或修改现有数据。

### Q3: 索引创建失败怎么办？

**A**: 查看错误日志，通常是因为：

- 数据格式不符合索引要求
- 索引名称冲突
- 权限不足

可以手动删除冲突的索引后重新执行。

### Q4: 为什么查询性能还是很慢？

**A**: 可能原因：

1. 索引尚未生效（需要等待或插入数据）
2. 查询条件未使用索引
3. 网络延迟
4. 数据量太大需要分片

### Q5: 如何回滚？

**A**: 如果需要删除所有集合：

```javascript
// 谨慎操作！这会删除所有数据
const collections = ['users', 'meals', ...];
for (const name of collections) {
  await db.collection(name).remove({});
}
```

## ✅ 验收清单

完成数据库初始化后，确认以下项目：

- [ ] 12 个集合全部创建成功
- [ ] 28 个索引全部配置成功
- [ ] 用户查询性能 <50ms
- [ ] 排行榜查询性能 <100ms
- [ ] 防重复查询性能 <20ms
- [ ] TTL 索引正常工作（会话自动清理）
- [ ] 全文搜索功能正常
- [ ] 无权限错误
- [ ] 无数据丢失

---

**文档版本**: v1.0  
**创建日期**: 2025-01-11  
**维护团队**: MyGarden 开发团队
