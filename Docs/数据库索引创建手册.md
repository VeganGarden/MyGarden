# 数据库索引创建手册

## 📋 概述

由于腾讯云开发的 MongoDB 不支持通过代码创建索引，需要在**云开发控制台**手动创建。

本文档提供 28 个索引的详细创建步骤和配置参数。

## ⚠️ 重要说明

- **前置条件**: 必须先执行 `database` 云函数创建 12 个集合
- **创建位置**: 腾讯云开发控制台 → 数据库 → 选择集合 → 索引管理
- **创建时间**: 预计需要 15-20 分钟
- **必须完成**: 索引是查询性能的关键，必须全部创建

## 🚀 快速开始

### 访问路径

1. 登录 https://console.cloud.tencent.com/tcb
2. 选择您的环境（`my-garden-app-env`）
3. 点击左侧菜单「数据库」
4. 点击「集合管理」

---

## 📊 索引创建清单（28 个）

### 1️⃣ users 集合（3 个索引）

#### 索引 1: openId_unique

**用途**: 用户登录查询（唯一索引）  
**优先级**: ⭐⭐⭐⭐⭐ 最高

**创建步骤**:

1. 选择 `users` 集合
2. 点击「索引管理」→「新建索引」
3. 填写配置：

| 字段     | 配置值        |
| -------- | ------------- |
| 索引名称 | openId_unique |
| 索引字段 | openId        |
| 排序方式 | 升序(1)       |
| 索引属性 | ✅ 唯一索引   |

**控制台 JSON 配置**:

```json
{
  "name": "openId_unique",
  "keys": [{ "name": "openId", "direction": "1" }],
  "unique": true
}
```

#### 索引 2: level_points_ranking

**用途**: 排行榜查询（复合索引）  
**优先级**: ⭐⭐⭐⭐

**创建步骤**:

1. 点击「新建索引」
2. 添加两个字段：

| 字段     | 配置值               |
| -------- | -------------------- |
| 索引名称 | level_points_ranking |
| 字段 1   | level，降序(-1)      |
| 字段 2   | points，降序(-1)     |

**控制台 JSON 配置**:

```json
{
  "name": "level_points_ranking",
  "keys": [
    { "name": "level", "direction": "-1" },
    { "name": "points", "direction": "-1" }
  ]
}
```

#### 索引 3: lastLoginAt_index

**用途**: 活跃度统计  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "lastLoginAt_index",
  "keys": [{ "name": "lastLoginAt", "direction": "-1" }]
}
```

---

### 2️⃣ user_sessions 集合（3 个索引）

#### 索引 1: userId_expiresAt_index

**用途**: 会话管理  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_expiresAt_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "expiresAt", "direction": "1" }
  ]
}
```

#### 索引 2: accessToken_index

**用途**: Token 验证  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "accessToken_index",
  "keys": [{ "name": "accessToken", "direction": "1" }]
}
```

#### 索引 3: expiresAt_ttl

**用途**: TTL 自动清理过期会话  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "expiresAt_ttl",
  "keys": [{ "name": "expiresAt", "direction": "1" }],
  "expireAfterSeconds": 0
}
```

**注意**: 腾讯云可能不支持 TTL 索引，如不支持可跳过，使用定时云函数清理。

---

### 3️⃣ meals 集合（4 个索引）⭐ 最重要

#### 索引 1: userId_mealDate_index

**用途**: 个人餐食记录查询（最高频查询）  
**优先级**: ⭐⭐⭐⭐⭐ 最高

**控制台 JSON 配置**:

```json
{
  "name": "userId_mealDate_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "mealDate", "direction": "-1" }
  ]
}
```

#### 索引 2: userId_createdAt_index

**用途**: 最近记录查询  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_createdAt_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "createdAt", "direction": "-1" }
  ]
}
```

#### 索引 3: userId_source_orderId_unique

**用途**: 防止第三方订单重复同步（唯一稀疏索引）  
**优先级**: ⭐⭐⭐⭐⭐ 最高

**控制台 JSON 配置**:

```json
{
  "name": "userId_source_orderId_unique",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "source", "direction": "1" },
    { "name": "sourceOrderId", "direction": "1" }
  ],
  "unique": true,
  "sparse": true
}
```

**注意**: 如果控制台不支持稀疏索引，则创建为普通唯一索引。

#### 索引 4: isPublic_createdAt_index

**用途**: 公开动态查询  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "isPublic_createdAt_index",
  "keys": [
    { "name": "isPublic", "direction": "1" },
    { "name": "createdAt", "direction": "-1" }
  ]
}
```

---

### 4️⃣ daily_stats 集合（3 个索引）

#### 索引 1: userId_date_index

**用途**: 个人统计查询  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_date_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "date", "direction": "-1" }
  ]
}
```

#### 索引 2: date_carbonReduction_ranking

**用途**: 每日排行榜查询  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "date_carbonReduction_ranking",
  "keys": [
    { "name": "date", "direction": "-1" },
    { "name": "totalCarbonReduction", "direction": "-1" }
  ]
}
```

#### 索引 3: userId_date_unique

**用途**: 数据唯一性保证（防止重复统计）  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_date_unique",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "date", "direction": "1" }
  ],
  "unique": true
}
```

---

### 5️⃣ gardens 集合（1 个索引）

#### 索引 1: userId_unique

**用途**: 个人花园查询（唯一索引）  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_unique",
  "keys": [{ "name": "userId", "direction": "1" }],
  "unique": true
}
```

---

### 6️⃣ ingredients 集合（3 个索引）

#### 索引 1: name_index

**用途**: 食材名称查询  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "name_index",
  "keys": [{ "name": "name", "direction": "1" }]
}
```

#### 索引 2: category_index

**用途**: 分类查询  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "category_index",
  "keys": [{ "name": "category", "direction": "1" }]
}
```

#### 索引 3: name_fulltext

**用途**: 全文搜索（文本索引）  
**优先级**: ⭐⭐⭐⭐

**创建步骤**:

1. 选择索引类型：「文本索引」
2. 选择字段：name, nameEn
3. 设置权重：name(10), nameEn(5)
4. 语言：Chinese

**注意**: 如果控制台不支持文本索引，可以暂时跳过，使用正则查询代替。

---

### 7️⃣ recipes 集合（2 个索引）

#### 索引 1: name_fulltext

**用途**: 食谱名称搜索  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "name_fulltext",
  "keys": [{ "name": "name", "direction": "text" }]
}
```

**注意**: 文本索引可能不支持，可用普通索引代替：

```json
{
  "name": "name_index",
  "keys": [{ "name": "name", "direction": "1" }]
}
```

#### 索引 2: usageCount_index

**用途**: 热门食谱排序  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "usageCount_index",
  "keys": [{ "name": "usageCount", "direction": "-1" }]
}
```

---

### 8️⃣ sync_tasks 集合（4 个索引）

#### 索引 1: userId_platform_status_index

**用途**: 同步任务管理  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_platform_status_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "platform", "direction": "1" },
    { "name": "status", "direction": "1" }
  ]
}
```

#### 索引 2: status_nextRetry_index

**用途**: 失败任务重试队列  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "status_nextRetry_index",
  "keys": [
    { "name": "status", "direction": "1" },
    { "name": "nextRetry", "direction": "1" }
  ]
}
```

#### 索引 3: platform_orderId_unique

**用途**: 防止同步任务重复  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "platform_orderId_unique",
  "keys": [
    { "name": "platform", "direction": "1" },
    { "name": "orderId", "direction": "1" }
  ],
  "unique": true,
  "sparse": true
}
```

#### 索引 4: createdAt_ttl

**用途**: 30 天后自动删除（TTL 索引）  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "createdAt_ttl",
  "keys": [{ "name": "createdAt", "direction": "1" }],
  "expireAfterSeconds": 2592000
}
```

**注意**: 如果不支持 TTL，需要创建定时云函数手动清理。

---

### 9️⃣ platform_configs 集合（1 个索引）

#### 索引 1: platform_unique

**用途**: 平台配置唯一性  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "platform_unique",
  "keys": [{ "name": "platform", "direction": "1" }],
  "unique": true
}
```

---

### 🔟 friends 集合（2 个索引）

#### 索引 1: userId_friendId_unique

**用途**: 好友关系唯一性  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_friendId_unique",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "friendId", "direction": "1" }
  ],
  "unique": true
}
```

#### 索引 2: userId_status_index

**用途**: 好友列表查询  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_status_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "status", "direction": "1" }
  ]
}
```

---

### 1️⃣1️⃣ posts 集合（2 个索引）

#### 索引 1: userId_createdAt_index

**用途**: 个人动态查询  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_createdAt_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "createdAt", "direction": "-1" }
  ]
}
```

#### 索引 2: visibility_createdAt_index

**用途**: 公开动态流  
**优先级**: ⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "visibility_createdAt_index",
  "keys": [
    { "name": "visibility", "direction": "1" },
    { "name": "createdAt", "direction": "-1" }
  ]
}
```

---

### 1️⃣2️⃣ orders 集合（2 个索引）

#### 索引 1: orderNo_unique

**用途**: 订单号唯一性  
**优先级**: ⭐⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "orderNo_unique",
  "keys": [{ "name": "orderNo", "direction": "1" }],
  "unique": true
}
```

#### 索引 2: userId_createdAt_index

**用途**: 用户订单列表  
**优先级**: ⭐⭐⭐⭐

**控制台 JSON 配置**:

```json
{
  "name": "userId_createdAt_index",
  "keys": [
    { "name": "userId", "direction": "1" },
    { "name": "createdAt", "direction": "-1" }
  ]
}
```

---

## 📋 索引创建检查清单

创建完成后，请逐一确认：

### 用户域

- [ ] users.openId_unique（唯一）
- [ ] users.level_points_ranking（复合）
- [ ] users.lastLoginAt_index
- [ ] user_sessions.userId_expiresAt_index
- [ ] user_sessions.accessToken_index
- [ ] user_sessions.expiresAt_ttl（TTL，可选）

### 碳足迹域

- [ ] meals.userId_mealDate_index（⭐ 最重要）
- [ ] meals.userId_createdAt_index
- [ ] meals.userId_source_orderId_unique（唯一稀疏）
- [ ] meals.isPublic_createdAt_index
- [ ] daily_stats.userId_date_index
- [ ] daily_stats.date_carbonReduction_ranking
- [ ] daily_stats.userId_date_unique（唯一）

### 花园域

- [ ] gardens.userId_unique（唯一）

### 基础数据域

- [ ] ingredients.name_index
- [ ] ingredients.category_index
- [ ] ingredients.name_fulltext（文本索引，可选）
- [ ] recipes.name_fulltext（文本索引，可选）
- [ ] recipes.usageCount_index

### 第三方同步域

- [ ] sync_tasks.userId_platform_status_index
- [ ] sync_tasks.status_nextRetry_index
- [ ] sync_tasks.platform_orderId_unique（唯一稀疏）
- [ ] sync_tasks.createdAt_ttl（TTL，可选）
- [ ] platform_configs.platform_unique（唯一）

### 社交域

- [ ] friends.userId_friendId_unique（唯一）
- [ ] friends.userId_status_index
- [ ] posts.userId_createdAt_index
- [ ] posts.visibility_createdAt_index

### 积分商城域

- [ ] orders.orderNo_unique（唯一）
- [ ] orders.userId_createdAt_index

**总计: 28 个索引**  
**必须创建: 20 个（⭐⭐⭐⭐⭐ 和 ⭐⭐⭐⭐）**  
**可选创建: 8 个（⭐⭐⭐ 和 TTL/文本索引）**

---

## 🎯 优先级说明

- ⭐⭐⭐⭐⭐ **最高优先级**: 必须立即创建，影响核心功能

  - users.openId_unique（登录）
  - meals.userId_mealDate_index（最高频查询）
  - meals.userId_source_orderId_unique（防重）
  - daily_stats.userId_date_index（统计）
  - gardens.userId_unique（花园）
  - user_sessions.accessToken_index（认证）
  - orders.orderNo_unique（订单）

- ⭐⭐⭐⭐ **高优先级**: 影响性能，建议创建

  - 所有复合索引
  - 排行榜相关索引

- ⭐⭐⭐ **中优先级**: 可以后续创建
  - 社交功能索引
  - 全文搜索索引

---

## 💡 控制台操作技巧

### 方法 1: 图形界面创建（简单）

1. 在云开发控制台选择集合
2. 点击「索引管理」
3. 点击「新建索引」
4. 按照上面的表格填写
5. 点击「确定」

### 方法 2: JSON 导入（快速，如果支持）

如果控制台支持 JSON 导入，可以直接复制上面的 JSON 配置。

### 方法 3: 批量创建（推荐）

复制下面的完整配置，在控制台查找是否有批量导入功能：

```json
{
  "users": [
    {
      "name": "openId_unique",
      "keys": [{ "name": "openId", "direction": "1" }],
      "unique": true
    },
    {
      "name": "level_points_ranking",
      "keys": [
        { "name": "level", "direction": "-1" },
        { "name": "points", "direction": "-1" }
      ]
    },
    {
      "name": "lastLoginAt_index",
      "keys": [{ "name": "lastLoginAt", "direction": "-1" }]
    }
  ],
  "user_sessions": [
    {
      "name": "userId_expiresAt_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "expiresAt", "direction": "1" }
      ]
    },
    {
      "name": "accessToken_index",
      "keys": [{ "name": "accessToken", "direction": "1" }]
    }
  ],
  "meals": [
    {
      "name": "userId_mealDate_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "mealDate", "direction": "-1" }
      ]
    },
    {
      "name": "userId_createdAt_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "createdAt", "direction": "-1" }
      ]
    },
    {
      "name": "userId_source_orderId_unique",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "source", "direction": "1" },
        { "name": "sourceOrderId", "direction": "1" }
      ],
      "unique": true,
      "sparse": true
    },
    {
      "name": "isPublic_createdAt_index",
      "keys": [
        { "name": "isPublic", "direction": "1" },
        { "name": "createdAt", "direction": "-1" }
      ]
    }
  ],
  "daily_stats": [
    {
      "name": "userId_date_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "date", "direction": "-1" }
      ]
    },
    {
      "name": "date_carbonReduction_ranking",
      "keys": [
        { "name": "date", "direction": "-1" },
        { "name": "totalCarbonReduction", "direction": "-1" }
      ]
    },
    {
      "name": "userId_date_unique",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "date", "direction": "1" }
      ],
      "unique": true
    }
  ],
  "gardens": [
    {
      "name": "userId_unique",
      "keys": [{ "name": "userId", "direction": "1" }],
      "unique": true
    }
  ],
  "ingredients": [
    {
      "name": "name_index",
      "keys": [{ "name": "name", "direction": "1" }]
    },
    {
      "name": "category_index",
      "keys": [{ "name": "category", "direction": "1" }]
    }
  ],
  "recipes": [
    {
      "name": "usageCount_index",
      "keys": [{ "name": "usageCount", "direction": "-1" }]
    }
  ],
  "sync_tasks": [
    {
      "name": "userId_platform_status_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "platform", "direction": "1" },
        { "name": "status", "direction": "1" }
      ]
    },
    {
      "name": "status_nextRetry_index",
      "keys": [
        { "name": "status", "direction": "1" },
        { "name": "nextRetry", "direction": "1" }
      ]
    },
    {
      "name": "platform_orderId_unique",
      "keys": [
        { "name": "platform", "direction": "1" },
        { "name": "orderId", "direction": "1" }
      ],
      "unique": true,
      "sparse": true
    }
  ],
  "platform_configs": [
    {
      "name": "platform_unique",
      "keys": [{ "name": "platform", "direction": "1" }],
      "unique": true
    }
  ],
  "friends": [
    {
      "name": "userId_friendId_unique",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "friendId", "direction": "1" }
      ],
      "unique": true
    },
    {
      "name": "userId_status_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "status", "direction": "1" }
      ]
    }
  ],
  "posts": [
    {
      "name": "userId_createdAt_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "createdAt", "direction": "-1" }
      ]
    },
    {
      "name": "visibility_createdAt_index",
      "keys": [
        { "name": "visibility", "direction": "1" },
        { "name": "createdAt", "direction": "-1" }
      ]
    }
  ],
  "orders": [
    {
      "name": "orderNo_unique",
      "keys": [{ "name": "orderNo", "direction": "1" }],
      "unique": true
    },
    {
      "name": "userId_createdAt_index",
      "keys": [
        { "name": "userId", "direction": "1" },
        { "name": "createdAt", "direction": "-1" }
      ]
    }
  ]
}
```

---

## 🔍 验证索引创建

### 检查方法

在每个集合的「索引管理」页面，您应该看到：

**users 集合**:

```
✓ _id_（系统默认）
✓ openId_unique
✓ level_points_ranking
✓ lastLoginAt_index
```

**meals 集合**:

```
✓ _id_（系统默认）
✓ userId_mealDate_index
✓ userId_createdAt_index
✓ userId_source_orderId_unique
✓ isPublic_createdAt_index
```

...依此类推

### 性能验证

创建索引后，可以使用 `test-indexes` 云函数测试性能。

---

## ⏱️ 预计时间

- **最高优先级索引**（7 个）: 约 5 分钟
- **高优先级索引**（13 个）: 约 10 分钟
- **中优先级索引**（8 个）: 约 5 分钟
- **总计**: 约 20 分钟

---

## 🚨 常见问题

### Q1: 某个索引创建失败怎么办？

**原因**:

- 数据不符合唯一性约束
- 索引名称冲突
- 不支持某些索引类型（TTL、稀疏索引）

**解决**:

- 跳过该索引，标记为"待处理"
- 继续创建其他索引
- 核心索引必须创建，可选索引可以暂缓

### Q2: TTL 索引不支持怎么办？

**解决**: 创建定时云函数手动清理：

```javascript
// 定时清理过期会话（每天执行）
exports.main = async () => {
  const db = cloud.database();
  const now = new Date();

  await db
    .collection("user_sessions")
    .where({
      expiresAt: db.command.lt(now),
    })
    .remove();
};
```

### Q3: 稀疏索引不支持怎么办？

**解决**: 创建为普通唯一索引，但要注意：

- 所有文档都必须有这个字段
- 或者改为非唯一索引

### Q4: 文本索引不支持怎么办？

**解决**: 使用正则查询代替：

```javascript
// 代替全文搜索
db.collection("ingredients")
  .where({
    name: db.RegExp({
      regexp: "豆腐",
      options: "i",
    }),
  })
  .get();
```

---

## 📊 索引统计

| 集合             | 索引数 | 必须创建 | 可选     |
| ---------------- | ------ | -------- | -------- |
| users            | 3      | 3        | 0        |
| user_sessions    | 3      | 2        | 1 (TTL)  |
| meals            | 4      | 4        | 0        |
| daily_stats      | 3      | 3        | 0        |
| gardens          | 1      | 1        | 0        |
| ingredients      | 3      | 2        | 1 (文本) |
| recipes          | 2      | 1        | 1 (文本) |
| sync_tasks       | 4      | 3        | 1 (TTL)  |
| platform_configs | 1      | 1        | 0        |
| friends          | 2      | 2        | 0        |
| posts            | 2      | 2        | 0        |
| orders           | 2      | 2        | 0        |
| **总计**         | **28** | **24**   | **4**    |

---

**文档版本**: v1.0  
**创建日期**: 2025-01-11  
**预计完成时间**: 20 分钟  
**维护团队**: MyGarden 开发团队
