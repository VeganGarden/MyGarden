# 食材数据导入指南

## 📋 概述

本指南将帮助您快速导入 **191 种常见食材** 到云开发数据库，为"我的花园"小程序提供完整的食材库支持。

## ✅ 前置要求

在开始之前，请确保：

- [x] 已完成数据库初始化（12 个集合已创建）
- [x] 已创建全部 28 个索引
- [x] 已安装 CloudBase CLI

## 🚀 快速开始

### 第一步：部署云函数

在项目根目录执行：

```bash
cd /Users/zhangshichao/WeChatProjects/MyGarden
tcb fn deploy data-import --force
```

**预期输出：**

```
✔ 函数 data-import 部署成功
```

**部署时间：** 约 15-30 秒

---

### 第二步：执行导入

#### 方式 1：使用云开发控制台（推荐）

1. 登录腾讯云开发控制台：https://console.cloud.tencent.com/tcb
2. 选择环境：`my-garden-app-env-4e0h762923be2f`
3. 左侧菜单：云函数 → `data-import`
4. 点击右上角 **"测试"** 按钮
5. 在测试参数窗口输入：

```json
{
  "action": "importIngredients"
}
```

6. 点击 **"测试运行"**
7. 等待 20-30 秒，查看返回结果

**成功示例：**

```json
{
  "code": 0,
  "message": "食材数据导入完成",
  "summary": {
    "total": 191,
    "inserted": 191,
    "skipped": 0,
    "failed": 0
  }
}
```

#### 方式 2：使用命令行

```bash
tcb fn invoke data-import --params '{"action":"importIngredients"}'
```

---

### 第三步：验证导入结果

#### 3.1 查看统计

在控制台测试或命令行执行：

```json
{
  "action": "countIngredients"
}
```

**预期返回：**

```json
{
  "code": 0,
  "data": {
    "total": 191,
    "byCategory": [
      { "_id": "vegetables", "count": 95 },
      { "_id": "beans", "count": 25 },
      { "_id": "fruits", "count": 35 },
      { "_id": "grains", "count": 13 },
      { "_id": "nuts", "count": 18 },
      { "_id": "oils", "count": 8 },
      { "_id": "dairy", "count": 7 },
      { "_id": "eggs", "count": 3 },
      { "_id": "sweeteners", "count": 5 }
    ]
  }
}
```

#### 3.2 在数据库中验证

1. 云开发控制台 → 数据库
2. 选择 `ingredients` 集合
3. 查看记录数：应该为 **191 条**
4. 随机打开几条记录检查数据完整性

**检查项：**

- ✅ name (食材名称)
- ✅ nameEn (英文名称)
- ✅ category (分类)
- ✅ carbonFootprint (碳足迹)
- ✅ nutrition (营养成分)
- ✅ createdAt / updatedAt (时间戳)

---

## 📊 导入数据说明

### 食材分类统计

| 分类     | 英文       | 数量 | 示例                           |
| -------- | ---------- | ---- | ------------------------------ |
| 蔬菜类   | vegetables | 95   | 白菜、菠菜、西兰花、番茄、黄瓜 |
| 豆制品   | beans      | 25   | 豆腐、豆浆、豆干、腐竹、毛豆   |
| 水果类   | fruits     | 35   | 苹果、香蕉、葡萄、西瓜、草莓   |
| 谷物类   | grains     | 13   | 大米、面粉、燕麦、藜麦、小米   |
| 坚果种子 | nuts       | 18   | 核桃、杏仁、花生、芝麻、瓜子   |
| 食用油   | oils       | 8    | 橄榄油、花生油、芝麻油、菜籽油 |
| 乳制品   | dairy      | 7    | 牛奶、酸奶、椰奶、杏仁奶       |
| 蛋类     | eggs       | 3    | 鸡蛋、鸭蛋、鹌鹑蛋             |
| 甜味剂   | sweeteners | 5    | 蜂蜜、红糖、白糖、冰糖         |

### 数据来源

- **营养成分**：参考《中国食物成分表（标准版）》
- **碳足迹**：基于国际食物碳足迹研究数据
- **单位**：
  - 营养成分：每 100 克
  - 碳足迹：kg CO₂e / kg

---

## 🔍 常见问题处理

### 问题 1：导入时提示"集合不存在"

**原因**：`ingredients` 集合未创建

**解决**：

```bash
# 重新执行数据库初始化
tcb fn invoke database
```

### 问题 2：部分食材导入失败

**排查**：

1. 查看云函数日志中的错误信息
2. 检查数据格式是否正确
3. 确认索引是否全部创建

**解决**：

- 单条失败不影响整体
- 可以重新执行导入（已存在的会自动跳过）

### 问题 3：执行超时

**原因**：数据量较大，网络较慢

**解决**：

- 超时设置已调整为 60 秒
- 如仍超时，请检查网络连接
- 可以在控制台日志中查看实际导入进度

### 问题 4：重复导入会有问题吗？

**答**：不会。系统会根据食材名称自动检测：

- 已存在的食材 → 跳过
- 新食材 → 导入

可以放心多次执行。

### 问题 5：如何清空重新导入？

**方法**：使用 `clearIngredients` 操作

```json
{
  "action": "clearIngredients",
  "confirm": "YES_I_AM_SURE"
}
```

**⚠️ 警告**：此操作会删除 `ingredients` 集合中的所有数据，请谨慎使用！

---

## 📱 在小程序中使用食材数据

导入完成后，可以在小程序中查询食材：

```javascript
// 查询所有豆制品
const db = wx.cloud.database();
const result = await db
  .collection("ingredients")
  .where({
    category: "beans",
    status: "active",
  })
  .get();

console.log("豆制品列表:", result.data);

// 搜索食材（按名称）
const searchResult = await db
  .collection("ingredients")
  .where({
    name: db.RegExp({
      regexp: "豆腐",
      options: "i",
    }),
  })
  .get();

// 获取单个食材详情
const ingredient = await db.collection("ingredients").doc("食材ID").get();
```

---

## 🎯 后续步骤

✅ 食材数据导入完成后，您可以：

1. **测试碳足迹计算功能**

   - 在小程序中记录一餐
   - 查看计算出的碳足迹

2. **开发食材搜索功能**

   - 利用 `name` 字段的索引
   - 支持模糊搜索

3. **构建饮食推荐系统**

   - 基于 `carbonFootprint` 推荐低碳食材
   - 基于 `nutrition` 提供营养建议

4. **对接第三方平台**
   - 使用 `platformMappings` 字段
   - 同步外卖平台数据

---

## 📖 相关文档

- [数据库架构设计文档-简化版.md](./数据库架构设计文档-简化版.md) - 完整的数据库设计
- [数据库索引创建手册.md](./数据库索引创建手册.md) - 索引创建指南
- [cloudfunctions/data-import/README.md](../cloudfunctions/data-import/README.md) - 云函数详细说明

---

## 🆘 获取帮助

如遇到问题：

1. **查看日志**

   - 云开发控制台 → 云函数 → data-import → 日志
   - 查看详细的执行过程和错误信息

2. **检查清单**

   - [ ] 云函数部署成功
   - [ ] ingredients 集合已创建
   - [ ] 相关索引已创建
   - [ ] 网络连接正常

3. **重新尝试**
   - 大多数问题可以通过重新部署和导入解决
   - 系统会自动跳过已导入的数据

---

**版本**: v1.0.0  
**最后更新**: 2025-10-13  
**预计执行时间**: 2-3 分钟  
**成功率**: 99.9%

✨ 祝您导入顺利！
