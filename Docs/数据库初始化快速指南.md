# æ•°æ®åº“åˆå§‹åŒ–å¿«é€ŸæŒ‡å—

## ğŸ¯ ç›®æ ‡

å¿«é€Ÿå®Œæˆæ•°æ®åº“åˆå§‹åŒ–ï¼Œåˆ›å»º 12 ä¸ªé›†åˆå’Œ 28 ä¸ªç´¢å¼•ã€‚

## âš¡ å¿«é€Ÿæ‰§è¡Œï¼ˆ3 æ­¥ï¼‰

### æ­¥éª¤ 1: é‡æ–°éƒ¨ç½² database äº‘å‡½æ•°ï¼ˆå·²ä¿®å¤ï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /Users/zhangshichao/WeChatProjects/MyGarden

# è¿›å…¥databaseç›®å½•å®‰è£…ä¾èµ–
cd cloudfunctions/database
npm install

# è¿”å›æ ¹ç›®å½•
cd ../..

# éƒ¨ç½²äº‘å‡½æ•°
tcb fn deploy database --envId my-garden-app-env
```

**æˆ–è€…ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·**:

1. å³é”®ç‚¹å‡» `cloudfunctions/database` æ–‡ä»¶å¤¹
2. é€‰æ‹©ã€Œä¸Šä¼ å¹¶éƒ¨ç½²ï¼šäº‘ç«¯å®‰è£…ä¾èµ–ã€
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ

### æ­¥éª¤ 2: æ‰§è¡Œäº‘å‡½æ•°åˆ›å»ºé›†åˆ

**åœ¨äº‘å¼€å‘æ§åˆ¶å°**:

1. è¿›å…¥ https://console.cloud.tencent.com/tcb
2. é€‰æ‹©ç¯å¢ƒ `my-garden-app-env`
3. ç‚¹å‡»ã€Œäº‘å‡½æ•°ã€
4. æ‰¾åˆ° `database` å‡½æ•°
5. ç‚¹å‡»ã€Œæµ‹è¯•ã€
6. è¾“å…¥: `{}`
7. ç‚¹å‡»ã€Œè¿è¡Œæµ‹è¯•ã€

**é¢„æœŸç»“æœ**:

```json
{
  "code": 0,
  "message": "æ•°æ®åº“é›†åˆåˆ›å»ºæˆåŠŸ",
  "summary": {
    "totalCollections": 12,
    "successfulCollections": 12,
    "collections": [...]
  },
  "nextSteps": {
    "action": "æ‰‹åŠ¨åˆ›å»ºç´¢å¼•",
    "guide": "Docs/æ•°æ®åº“ç´¢å¼•åˆ›å»ºæ‰‹å†Œ.md",
    "totalIndexes": 28
  }
}
```

### æ­¥éª¤ 3: æ‰‹åŠ¨åˆ›å»ºç´¢å¼•ï¼ˆé‡è¦ï¼ï¼‰

å‚è€ƒè¯¦ç»†æŒ‡å—ï¼š[æ•°æ®åº“ç´¢å¼•åˆ›å»ºæ‰‹å†Œ.md](./æ•°æ®åº“ç´¢å¼•åˆ›å»ºæ‰‹å†Œ.md)

#### æœ€å°å¿…é¡»ç´¢å¼•ï¼ˆ20 ä¸ªï¼Œçº¦ 10 åˆ†é’Ÿï¼‰

æŒ‰ä¼˜å…ˆçº§åˆ›å»ºä»¥ä¸‹ç´¢å¼•ï¼š

**1. users é›†åˆï¼ˆ3 ä¸ªï¼‰**

```
âœ“ openId_unique - å­—æ®µ: openId(å‡åº)ï¼Œå”¯ä¸€
âœ“ level_points_ranking - å­—æ®µ: level(é™åº), points(é™åº)
âœ“ lastLoginAt_index - å­—æ®µ: lastLoginAt(é™åº)
```

**2. meals é›†åˆï¼ˆ4 ä¸ªï¼‰â­ æœ€é‡è¦**

```
âœ“ userId_mealDate_index - å­—æ®µ: userId(å‡åº), mealDate(é™åº)
âœ“ userId_createdAt_index - å­—æ®µ: userId(å‡åº), createdAt(é™åº)
âœ“ userId_source_orderId_unique - å­—æ®µ: userId, source, sourceOrderIdï¼Œå”¯ä¸€
âœ“ isPublic_createdAt_index - å­—æ®µ: isPublic(å‡åº), createdAt(é™åº)
```

**3. daily_stats é›†åˆï¼ˆ3 ä¸ªï¼‰**

```
âœ“ userId_date_index - å­—æ®µ: userId(å‡åº), date(é™åº)
âœ“ date_carbonReduction_ranking - å­—æ®µ: date(é™åº), totalCarbonReduction(é™åº)
âœ“ userId_date_unique - å­—æ®µ: userId(å‡åº), date(å‡åº)ï¼Œå”¯ä¸€
```

**4. gardens é›†åˆï¼ˆ1 ä¸ªï¼‰**

```
âœ“ userId_unique - å­—æ®µ: userId(å‡åº)ï¼Œå”¯ä¸€
```

**5. ingredients é›†åˆï¼ˆ2 ä¸ªï¼‰**

```
âœ“ name_index - å­—æ®µ: name(å‡åº)
âœ“ category_index - å­—æ®µ: category(å‡åº)
```

**6. recipes é›†åˆï¼ˆ1 ä¸ªï¼‰**

```
âœ“ usageCount_index - å­—æ®µ: usageCount(é™åº)
```

**7. sync_tasks é›†åˆï¼ˆ3 ä¸ªï¼‰**

```
âœ“ userId_platform_status_index - å­—æ®µ: userId, platform, status
âœ“ status_nextRetry_index - å­—æ®µ: status(å‡åº), nextRetry(å‡åº)
âœ“ platform_orderId_unique - å­—æ®µ: platform, orderIdï¼Œå”¯ä¸€
```

**8. platform_configs é›†åˆï¼ˆ1 ä¸ªï¼‰**

```
âœ“ platform_unique - å­—æ®µ: platform(å‡åº)ï¼Œå”¯ä¸€
```

**9. friends é›†åˆï¼ˆ2 ä¸ªï¼‰**

```
âœ“ userId_friendId_unique - å­—æ®µ: userId, friendIdï¼Œå”¯ä¸€
âœ“ userId_status_index - å­—æ®µ: userId, status
```

**10. posts é›†åˆï¼ˆ2 ä¸ªï¼‰**

```
âœ“ userId_createdAt_index - å­—æ®µ: userId(å‡åº), createdAt(é™åº)
âœ“ visibility_createdAt_index - å­—æ®µ: visibility, createdAt(é™åº)
```

**11. orders é›†åˆï¼ˆ2 ä¸ªï¼‰**

```
âœ“ orderNo_unique - å­—æ®µ: orderNo(å‡åº)ï¼Œå”¯ä¸€
âœ“ userId_createdAt_index - å­—æ®µ: userId(å‡åº), createdAt(é™åº)
```

**12. user_sessions é›†åˆï¼ˆ2 ä¸ªï¼Œå¯é€‰ï¼‰**

```
âœ“ userId_expiresAt_index - å­—æ®µ: userId, expiresAt
âœ“ accessToken_index - å­—æ®µ: accessToken(å‡åº)
```

---

## ğŸ“¸ æ§åˆ¶å°æ“ä½œæˆªå›¾è¯´æ˜

### åˆ›å»ºç´¢å¼•çš„æ­¥éª¤ï¼ˆå›¾å½¢ç•Œé¢ï¼‰

1. **è¿›å…¥ç´¢å¼•ç®¡ç†**

   ```
   æ•°æ®åº“ â†’ é€‰æ‹©é›†åˆ(å¦‚users) â†’ ç´¢å¼•ç®¡ç† â†’ æ–°å»ºç´¢å¼•
   ```

2. **å¡«å†™ç´¢å¼•ä¿¡æ¯**

   ```
   ç´¢å¼•åç§°: openId_unique
   ç´¢å¼•å­—æ®µ: ç‚¹å‡»ã€Œæ·»åŠ å­—æ®µã€
     - å­—æ®µå: openId
     - æ’åº: å‡åº(1)
   ç´¢å¼•å±æ€§: å‹¾é€‰ã€Œå”¯ä¸€ç´¢å¼•ã€
   ```

3. **ç¡®è®¤åˆ›å»º**
   ```
   ç‚¹å‡»ã€Œç¡®å®šã€â†’ ç­‰å¾…åˆ›å»ºå®Œæˆï¼ˆçº¦3-5ç§’ï¼‰
   ```

### åˆ›å»ºå¤åˆç´¢å¼•

å¯¹äºæœ‰å¤šä¸ªå­—æ®µçš„ç´¢å¼•ï¼ˆå¦‚ `level_points_ranking`ï¼‰ï¼š

1. ç‚¹å‡»ã€Œæ–°å»ºç´¢å¼•ã€
2. ç´¢å¼•åç§°: `level_points_ranking`
3. ç‚¹å‡»ã€Œæ·»åŠ å­—æ®µã€
   - å­—æ®µ 1: levelï¼Œé€‰æ‹©ã€Œé™åº(-1)ã€
   - ç‚¹å‡»ã€Œæ·»åŠ å­—æ®µã€
   - å­—æ®µ 2: pointsï¼Œé€‰æ‹©ã€Œé™åº(-1)ã€
4. ç‚¹å‡»ã€Œç¡®å®šã€

---

## âœ… å®ŒæˆéªŒè¯

### æ£€æŸ¥é›†åˆ

åœ¨äº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ é›†åˆç®¡ç†ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ“ users
âœ“ user_sessions
âœ“ meals
âœ“ daily_stats
âœ“ gardens
âœ“ ingredients
âœ“ recipes
âœ“ sync_tasks
âœ“ platform_configs
âœ“ friends
âœ“ posts
âœ“ orders
```

**å…±è®¡: 12 ä¸ªé›†åˆ** âœ…

### æ£€æŸ¥ç´¢å¼•

æ¯ä¸ªé›†åˆç‚¹è¿›å»ï¼ŒæŸ¥çœ‹ã€Œç´¢å¼•ç®¡ç†ã€é¡µé¢ï¼Œæ ¸å¯¹ç´¢å¼•æ•°é‡ï¼š

| é›†åˆ             | åº”æœ‰ç´¢å¼•æ•° | åŒ…å«é»˜è®¤*id* |
| ---------------- | ---------- | ------------ |
| users            | 4          | 3+ç³»ç»Ÿé»˜è®¤   |
| user_sessions    | 3          | 2+ç³»ç»Ÿé»˜è®¤   |
| meals            | 5          | 4+ç³»ç»Ÿé»˜è®¤   |
| daily_stats      | 4          | 3+ç³»ç»Ÿé»˜è®¤   |
| gardens          | 2          | 1+ç³»ç»Ÿé»˜è®¤   |
| ingredients      | 3-4        | 2-3+ç³»ç»Ÿé»˜è®¤ |
| recipes          | 2-3        | 1-2+ç³»ç»Ÿé»˜è®¤ |
| sync_tasks       | 4-5        | 3-4+ç³»ç»Ÿé»˜è®¤ |
| platform_configs | 2          | 1+ç³»ç»Ÿé»˜è®¤   |
| friends          | 3          | 2+ç³»ç»Ÿé»˜è®¤   |
| posts            | 3          | 2+ç³»ç»Ÿé»˜è®¤   |
| orders           | 3          | 2+ç³»ç»Ÿé»˜è®¤   |

**æ€»è®¡: 28 ä¸ªç´¢å¼• + 12 ä¸ªç³»ç»Ÿé»˜è®¤ = 40 ä¸ªç´¢å¼•** âœ…

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æ•°æ®åº“åˆå§‹åŒ–å®Œæˆåï¼š

1. âœ… **å¯¼å…¥åŸºç¡€æ•°æ®** (Day 3-4)

   - å¯¼å…¥é£Ÿæåº“æ•°æ®ï¼ˆ5000 ç§é£Ÿæï¼‰
   - é…ç½®å¹³å°æ˜ å°„ï¼ˆç¾å›¢ã€é¥¿äº†ä¹ˆï¼‰

2. âœ… **åˆ›å»ºåŠ å¯†å·¥å…·** (Day 3-4)

   - `cloudfunctions/common/encryption.js`
   - `cloudfunctions/common/permission.js`

3. âœ… **æ›´æ–°ç°æœ‰äº‘å‡½æ•°** (Day 5-7)
   - é€‚é…æ–°çš„æ•°æ®åº“ç»“æ„
   - æ”¯æŒæ–°çš„ç»Ÿè®¡å­—æ®µ

---

**é¢„è®¡æ€»è€—æ—¶**:

- é›†åˆåˆ›å»º: 1 åˆ†é’Ÿï¼ˆè‡ªåŠ¨ï¼‰
- ç´¢å¼•åˆ›å»º: 20 åˆ†é’Ÿï¼ˆæ‰‹åŠ¨ï¼‰
- éªŒè¯æµ‹è¯•: 5 åˆ†é’Ÿ

**æ€»è®¡**: çº¦ 30 åˆ†é’Ÿå³å¯å®Œæˆæ•°æ®åº“åˆå§‹åŒ–ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-11  
**ç»´æŠ¤å›¢é˜Ÿ**: MyGarden å¼€å‘å›¢é˜Ÿ

