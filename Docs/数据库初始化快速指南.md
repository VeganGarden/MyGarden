# 数据库初始化快速指南

## 🎯 目标

快速完成数据库初始化，创建 12 个集合和 28 个索引。

## ⚡ 快速执行（3 步）

### 步骤 1: 重新部署 database 云函数（已修复）

```bash
# 在项目根目录执行
cd /Users/zhangshichao/WeChatProjects/MyGarden

# 进入database目录安装依赖
cd cloudfunctions/database
npm install

# 返回根目录
cd ../..

# 部署云函数
tcb fn deploy database --envId my-garden-app-env
```

**或者使用微信开发者工具**:

1. 右键点击 `cloudfunctions/database` 文件夹
2. 选择「上传并部署：云端安装依赖」
3. 等待上传完成

### 步骤 2: 执行云函数创建集合

**在云开发控制台**:

1. 进入 https://console.cloud.tencent.com/tcb
2. 选择环境 `my-garden-app-env`
3. 点击「云函数」
4. 找到 `database` 函数
5. 点击「测试」
6. 输入: `{}`
7. 点击「运行测试」

**预期结果**:

```json
{
  "code": 0,
  "message": "数据库集合创建成功",
  "summary": {
    "totalCollections": 12,
    "successfulCollections": 12,
    "collections": [...]
  },
  "nextSteps": {
    "action": "手动创建索引",
    "guide": "Docs/数据库索引创建手册.md",
    "totalIndexes": 28
  }
}
```

### 步骤 3: 手动创建索引（重要！）

参考详细指南：[数据库索引创建手册.md](./数据库索引创建手册.md)

#### 最小必须索引（20 个，约 10 分钟）

按优先级创建以下索引：

**1. users 集合（3 个）**

```
✓ openId_unique - 字段: openId(升序)，唯一
✓ level_points_ranking - 字段: level(降序), points(降序)
✓ lastLoginAt_index - 字段: lastLoginAt(降序)
```

**2. meals 集合（4 个）⭐ 最重要**

```
✓ userId_mealDate_index - 字段: userId(升序), mealDate(降序)
✓ userId_createdAt_index - 字段: userId(升序), createdAt(降序)
✓ userId_source_orderId_unique - 字段: userId, source, sourceOrderId，唯一
✓ isPublic_createdAt_index - 字段: isPublic(升序), createdAt(降序)
```

**3. daily_stats 集合（3 个）**

```
✓ userId_date_index - 字段: userId(升序), date(降序)
✓ date_carbonReduction_ranking - 字段: date(降序), totalCarbonReduction(降序)
✓ userId_date_unique - 字段: userId(升序), date(升序)，唯一
```

**4. gardens 集合（1 个）**

```
✓ userId_unique - 字段: userId(升序)，唯一
```

**5. ingredients 集合（2 个）**

```
✓ name_index - 字段: name(升序)
✓ category_index - 字段: category(升序)
```

**6. recipes 集合（1 个）**

```
✓ usageCount_index - 字段: usageCount(降序)
```

**7. sync_tasks 集合（3 个）**

```
✓ userId_platform_status_index - 字段: userId, platform, status
✓ status_nextRetry_index - 字段: status(升序), nextRetry(升序)
✓ platform_orderId_unique - 字段: platform, orderId，唯一
```

**8. platform_configs 集合（1 个）**

```
✓ platform_unique - 字段: platform(升序)，唯一
```

**9. friends 集合（2 个）**

```
✓ userId_friendId_unique - 字段: userId, friendId，唯一
✓ userId_status_index - 字段: userId, status
```

**10. posts 集合（2 个）**

```
✓ userId_createdAt_index - 字段: userId(升序), createdAt(降序)
✓ visibility_createdAt_index - 字段: visibility, createdAt(降序)
```

**11. orders 集合（2 个）**

```
✓ orderNo_unique - 字段: orderNo(升序)，唯一
✓ userId_createdAt_index - 字段: userId(升序), createdAt(降序)
```

**12. user_sessions 集合（2 个，可选）**

```
✓ userId_expiresAt_index - 字段: userId, expiresAt
✓ accessToken_index - 字段: accessToken(升序)
```

---

## 📸 控制台操作截图说明

### 创建索引的步骤（图形界面）

1. **进入索引管理**

   ```
   数据库 → 选择集合(如users) → 索引管理 → 新建索引
   ```

2. **填写索引信息**

   ```
   索引名称: openId_unique
   索引字段: 点击「添加字段」
     - 字段名: openId
     - 排序: 升序(1)
   索引属性: 勾选「唯一索引」
   ```

3. **确认创建**
   ```
   点击「确定」→ 等待创建完成（约3-5秒）
   ```

### 创建复合索引

对于有多个字段的索引（如 `level_points_ranking`）：

1. 点击「新建索引」
2. 索引名称: `level_points_ranking`
3. 点击「添加字段」
   - 字段 1: level，选择「降序(-1)」
   - 点击「添加字段」
   - 字段 2: points，选择「降序(-1)」
4. 点击「确定」

---

## ✅ 完成验证

### 检查集合

在云开发控制台 → 数据库 → 集合管理，应该看到：

```
✓ users
✓ user_sessions
✓ meals
✓ daily_stats
✓ gardens
✓ ingredients
✓ recipes
✓ sync_tasks
✓ platform_configs
✓ friends
✓ posts
✓ orders
```

**共计: 12 个集合** ✅

### 检查索引

每个集合点进去，查看「索引管理」页面，核对索引数量：

| 集合             | 应有索引数 | 包含默认*id* |
| ---------------- | ---------- | ------------ |
| users            | 4          | 3+系统默认   |
| user_sessions    | 3          | 2+系统默认   |
| meals            | 5          | 4+系统默认   |
| daily_stats      | 4          | 3+系统默认   |
| gardens          | 2          | 1+系统默认   |
| ingredients      | 3-4        | 2-3+系统默认 |
| recipes          | 2-3        | 1-2+系统默认 |
| sync_tasks       | 4-5        | 3-4+系统默认 |
| platform_configs | 2          | 1+系统默认   |
| friends          | 3          | 2+系统默认   |
| posts            | 3          | 2+系统默认   |
| orders           | 3          | 2+系统默认   |

**总计: 28 个索引 + 12 个系统默认 = 40 个索引** ✅

---

## 🎯 下一步

数据库初始化完成后：

1. ✅ **导入基础数据** (Day 3-4)

   - 导入食材库数据（5000 种食材）
   - 配置平台映射（美团、饿了么）

2. ✅ **创建加密工具** (Day 3-4)

   - `cloudfunctions/common/encryption.js`
   - `cloudfunctions/common/permission.js`

3. ✅ **更新现有云函数** (Day 5-7)
   - 适配新的数据库结构
   - 支持新的统计字段

---

**预计总耗时**:

- 集合创建: 1 分钟（自动）
- 索引创建: 20 分钟（手动）
- 验证测试: 5 分钟

**总计**: 约 30 分钟即可完成数据库初始化！

---

**文档版本**: v1.0  
**创建日期**: 2025-01-11  
**维护团队**: MyGarden 开发团队

