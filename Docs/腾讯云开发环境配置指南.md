# 腾讯云开发环境配置指南

## 1. 环境准备

### 1.1 安装 CloudBase CLI
```bash
npm install -g @cloudbase/cli
```

### 1.2 登录腾讯云
```bash
cloudbase login
```

## 2. 环境配置

### 2.1 创建云开发环境
1. 访问 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 创建新环境：`my-garden-app-env-4e0h762923be2f`
3. 选择区域：`华东地区（上海）`

### 2.2 配置环境变量
复制 `.env.example` 为 `.env` 并填写实际配置：

```bash
cp .env.example .env
```

编辑 `.env` 文件：
```env
# 腾讯云开发环境配置
CLOUDBASE_ENVID=your-actual-env-id
CLOUDBASE_REGION=ap-shanghai

# 微信小程序配置
WECHAT_APPID=your-wechat-appid
WECHAT_SECRET=your-wechat-secret
```

## 3. 数据库配置

### 3.1 初始化数据库
运行数据库初始化脚本：
```bash
node scripts/init-db.js
```

### 3.2 数据库集合说明

| 集合名称 | 用途 | 索引 |
|---------|------|------|
| users | 用户信息 | openid (唯一索引) |
| gardens | 用户花园数据 | userId (唯一索引) |
| meals | 餐食记录 | userId + recordedAt |
| carbon_stats | 碳足迹统计 | userId + period |

## 4. 云函数部署

### 4.1 部署所有云函数
```bash
node scripts/deploy.js
```

### 4.2 单独部署云函数
```bash
# 部署登录云函数
cloudbase functions:deploy login -e your-env-id

# 部署用户管理云函数
cloudbase functions:deploy user -e your-env-id

# 部署花园管理云函数
cloudbase functions:deploy garden -e your-env-id

# 部署碳足迹计算云函数
cloudbase functions:deploy carbon -e your-env-id
```

## 5. 云函数说明

### 5.1 login 云函数
- **功能**: 微信用户登录
- **输入**: 微信登录 code
- **输出**: 用户信息和 session key

### 5.2 user 云函数
- **功能**: 用户信息管理
- **操作**: getProfile, updateProfile, updatePreferences

### 5.3 garden 云函数
- **功能**: 花园数据管理
- **操作**: getGardenInfo, addPlant, recordMeal

### 5.4 carbon 云函数
- **功能**: 碳足迹计算和统计
- **操作**: calculateMealCarbon, getUserStats

## 6. 前端集成

### 6.1 状态管理说明
项目已完全移除 Redux 状态管理，改为使用 React Hooks 进行本地状态管理。

### 6.2 初始化云开发环境
```typescript
import { initCloudbase } from '@/utils/cloudbase'

// 在应用启动时调用
initCloudbase()
```

### 6.3 调用云函数示例
```typescript
import { loginWithWechat, recordVegetarianMeal } from '@/utils/cloudbase'

// 用户登录
const loginResult = await loginWithWechat(wxCode)

// 记录餐食
const mealResult = await recordVegetarianMeal({
  userId: 'user123',
  mealType: 'lunch',
  ingredients: [...],
  cookingMethod: 'steamed'
})
```

### 6.4 本地状态管理示例
```typescript
import React, { useState, useEffect } from 'react'

const GardenPage: React.FC = () => {
  const [gardens, setGardens] = useState<any[]>([])
  const [loading, setLoading] = useState(false)

  useEffect(() => {
    loadGardens()
  }, [])

  const loadGardens = async () => {
    setLoading(true)
    try {
      // 调用云函数获取数据
      const result = await Taro.cloud.callFunction({
        name: 'garden',
        data: { action: 'getGardens' }
      })
      setGardens(result.result.data)
    } catch (error) {
      console.error('加载花园数据失败:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    // 组件JSX
  )
}
```

## 7. 权限配置

### 7.1 数据库权限
确保数据库集合具有正确的读写权限：

```javascript
// 用户集合权限配置
{
  "read": "auth != null",
  "write": "auth != null && doc.openid == auth.uid"
}
```

### 7.2 云存储权限
配置云存储桶的访问权限，确保用户只能访问自己的文件。

## 8. 监控和日志

### 8.1 云函数监控
- 访问腾讯云开发控制台查看云函数运行状态
- 监控云函数的调用次数、执行时间、错误率

### 8.2 日志查看
```bash
# 查看云函数日志
cloudbase functions:log login -e your-env-id
```

## 9. 故障排除

### 9.1 常见问题

**问题**: 云函数调用超时
**解决**: 检查云函数超时设置，适当增加 timeout 值

**问题**: 数据库连接失败
**解决**: 检查数据库权限配置和环境变量

**问题**: 微信登录失败
**解决**: 检查 WECHAT_APPID 和 WECHAT_SECRET 配置

### 9.2 调试技巧
1. 使用 `console.log` 输出调试信息
2. 查看云函数日志定位问题
3. 使用 try-catch 捕获异常

## 10. 安全建议

1. **环境变量**: 敏感信息使用环境变量存储
2. **权限控制**: 严格配置数据库和存储权限
3. **输入验证**: 云函数中对输入参数进行验证
4. **错误处理**: 完善的错误处理机制

---

**文档版本**: v1.1.0  
**最后更新**: 2025-10-02  
**维护者**: AI开发助手

## 更新日志

### v1.1.0 (2025-10-02)
- 更新实际环境ID：`my-garden-app-env-4e0h762923be2f`
- 修正数据库初始化脚本路径
- 添加状态管理说明：项目已移除Redux，使用React Hooks
- 添加本地状态管理示例代码