#!/bin/bash

###############################################################################
# æ•°æ®åº“å‡çº§ v2.0 - ä¸€é”®éƒ¨ç½²è„šæœ¬
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# chmod +x deploy-database-upgrade.sh
# ./deploy-database-upgrade.sh
###############################################################################

echo "========================================"
echo "æ•°æ®åº“å‡çº§ v2.0 - è‡ªåŠ¨éƒ¨ç½²è„šæœ¬"
echo "========================================"
echo ""

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"

echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
echo ""

# æ£€æŸ¥ tcb CLI
if ! command -v tcb &> /dev/null; then
    echo "âŒ æœªå®‰è£… tcb CLI"
    echo "è¯·å…ˆå®‰è£…: npm install -g @cloudbase/cli"
    exit 1
fi

echo "âœ… tcb CLI å·²å®‰è£…: $(tcb --version | head -n 1)"
echo ""

# æ£€æŸ¥ç™»å½•çŠ¶æ€
echo "ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€..."
if ! tcb env list &> /dev/null; then
    echo "âŒ æœªç™»å½•ï¼Œè¯·å…ˆæ‰§è¡Œ: tcb login"
    exit 1
fi

echo "âœ… å·²ç™»å½•"
echo ""

# æ­¥éª¤1ï¼šéƒ¨ç½² database äº‘å‡½æ•°
echo "========================================"
echo "æ­¥éª¤ 1/5: éƒ¨ç½² database äº‘å‡½æ•°"
echo "========================================"

cd cloudfunctions/database
echo "ğŸ“¦ éƒ¨ç½² database äº‘å‡½æ•°..."
tcb fn deploy database --force

if [ $? -eq 0 ]; then
    echo "âœ… database äº‘å‡½æ•°éƒ¨ç½²æˆåŠŸ"
else
    echo "âŒ database äº‘å‡½æ•°éƒ¨ç½²å¤±è´¥"
    exit 1
fi

cd ../..
echo ""

# æ­¥éª¤2ï¼šåˆ›å»º v2.0 æ–°é›†åˆ
echo "========================================"
echo "æ­¥éª¤ 2/5: åˆ›å»º v2.0 æ–°é›†åˆ"
echo "========================================"

echo "ğŸ”§ æ‰§è¡Œåˆ›å»ºæ–°é›†åˆ..."
tcb fn invoke database --params '{"action":"init-v2"}'

echo ""
read -p "âœ‹ è¯·ç¡®è®¤7ä¸ªæ–°é›†åˆåˆ›å»ºæˆåŠŸåï¼ŒæŒ‰å›è½¦ç»§ç»­..."
echo ""

# æ­¥éª¤3ï¼šè¿ç§»ç°æœ‰é›†åˆï¼ˆé¢„è§ˆï¼‰
echo "========================================"
echo "æ­¥éª¤ 3/5: é¢„è§ˆé›†åˆè¿ç§»"
echo "========================================"

echo "ğŸ‘€ é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¿®æ”¹æ•°æ®ï¼‰..."
tcb fn invoke database --params '{"action":"migrate-v2","params":{"action":"preview","collection":"all"}}'

echo ""
read -p "âœ‹ è¯·ç¡®è®¤é¢„è§ˆç»“æœæ­£ç¡®åï¼ŒæŒ‰å›è½¦ç»§ç»­æ‰§è¡Œè¿ç§»..."
echo ""

# æ­¥éª¤4ï¼šæ‰§è¡Œè¿ç§»
echo "========================================"
echo "æ­¥éª¤ 4/5: æ‰§è¡Œé›†åˆè¿ç§»"
echo "========================================"

echo "ğŸ”„ æ­£åœ¨è¿ç§»ç°æœ‰é›†åˆ..."
tcb fn invoke database --params '{"action":"migrate-v2","params":{"action":"migrate","collection":"all"}}'

echo ""
echo "âœ… è¿ç§»å®Œæˆ"
echo ""

# æ­¥éª¤5ï¼šæµ‹è¯•éªŒè¯
echo "========================================"
echo "æ­¥éª¤ 5/5: æµ‹è¯•éªŒè¯"
echo "========================================"

echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
tcb fn invoke database --params '{"action":"test-upgrade"}'

echo ""

# æŸ¥çœ‹æœ€ç»ˆçŠ¶æ€
echo "========================================"
echo "æŸ¥çœ‹æ•°æ®åº“æœ€ç»ˆçŠ¶æ€"
echo "========================================"

tcb fn invoke database --params '{"action":"get-status"}'

echo ""
echo "========================================"
echo "âœ… æ•°æ®åº“å‡çº§å®Œæˆï¼"
echo "========================================"
echo ""
echo "ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œï¼š"
echo "1. åœ¨äº‘å¼€å‘æ§åˆ¶å°åˆ›å»ºç´¢å¼•ï¼ˆå‚è€ƒï¼šDocs/æ•°æ®åº“ç´¢å¼•é…ç½®v2.0.mdï¼‰"
echo "2. éƒ¨ç½²æ–°äº‘å‡½æ•°ï¼ˆpractitioners, wisdom, practitioner-data-importï¼‰"
echo "3. å¼€å§‹å½•å…¥è·µè¡Œè€…æ•°æ®"
echo ""
echo "ğŸ‰ æ­å–œï¼æŠ€æœ¯å‡çº§å·²å®Œæˆï¼"
echo ""



