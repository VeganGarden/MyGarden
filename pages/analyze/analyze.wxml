<!--pages/analyze/analyze.wxml-->
<view class="container">
  <!-- 页面头部 -->
  <view class="header">
    <view class="back-btn" bindtap="goBack">
      <text class="icon">←</text>
    </view>
    <text class="title">数据分析服务</text>
    <view class="status-dot {{status.online ? 'online' : 'offline'}}"></view>
  </view>

  <!-- 数据上传区域 -->
  <view class="card">
    <view class="card-title">
      <text class="icon">📁</text>
      <text class="text">数据上传</text>
    </view>
    <text class="card-desc">上传CSV、JSON或Excel文件进行数据分析</text>
    
    <view class="upload-area" bindtap="chooseFile">
      <view class="upload-icon">
        <text class="icon">📤</text>
      </view>
      <text class="upload-text">点击选择文件</text>
      <text class="upload-hint">支持CSV、JSON、Excel格式</text>
    </view>

    <view wx:if="{{selectedFile}}" class="file-info">
      <text class="file-name">{{selectedFile.name}}</text>
      <text class="file-size">{{selectedFile.size}} bytes</text>
      <button class="btn-remove" bindtap="removeFile">移除</button>
    </view>
  </view>

  <!-- 分析选项 -->
  <view class="card">
    <view class="card-title">
      <text class="icon">⚙️</text>
      <text class="text">分析选项</text>
    </view>
    
    <view class="option-group">
      <text class="option-label">分析类型</text>
      <picker 
        range="{{analysisTypes}}" 
        value="{{selectedTypeIndex}}" 
        bindchange="onTypeChange"
        class="picker"
      >
        <view class="picker-value">
          {{analysisTypes[selectedTypeIndex]}}
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>

    <view class="option-group">
      <text class="option-label">数据范围</text>
      <picker 
        range="{{dataRanges}}" 
        value="{{selectedRangeIndex}}" 
        bindchange="onRangeChange"
        class="picker"
      >
        <view class="picker-value">
          {{dataRanges[selectedRangeIndex]}}
          <text class="picker-arrow">▼</text>
        </view>
      </picker>
    </view>
  </view>

  <!-- 分析按钮 -->
  <button 
    class="analyze-btn" 
    bindtap="startAnalysis" 
    disabled="{{!selectedFile || analyzing}}"
    loading="{{analyzing}}"
  >
    {{analyzing ? '分析中...' : '开始分析'}}
  </button>

  <!-- 分析结果 -->
  <view wx:if="{{analysisResult}}" class="card result-card">
    <view class="card-title">
      <text class="icon">📊</text>
      <text class="text">分析结果</text>
    </view>
    
    <view class="result-section">
      <text class="section-title">数据概览</text>
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{analysisResult.stats && analysisResult.stats.rowCount ? analysisResult.stats.rowCount : 0}}</text>
          <text class="stat-label">数据行数</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{analysisResult.stats && analysisResult.stats.columnCount ? analysisResult.stats.columnCount : 0}}</text>
          <text class="stat-label">字段数量</text>
        </view>
        <view class="stat-item">
          <text class="stat-value">{{analysisResult.stats && analysisResult.stats.completeness ? analysisResult.stats.completeness : '0%'}}</text>
          <text class="stat-label">数据完整性</text>
        </view>
      </view>
    </view>

    <view class="result-section">
      <text class="section-title">关键洞察</text>
      <view wx:for="{{analysisResult.insights ? analysisResult.insights : []}}" wx:key="index" class="insight-item">
        <text class="insight-text">{{item}}</text>
      </view>
    </view>

    <view class="result-section">
      <text class="section-title">建议</text>
      <view wx:for="{{analysisResult.recommendations ? analysisResult.recommendations : []}}" wx:key="index" class="recommendation-item">
        <text class="recommendation-text">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- 错误信息 -->
  <view wx:if="{{error}}" class="error-card">
    <text class="error-icon">❌</text>
    <text class="error-text">{{error}}</text>
  </view>
</view>