---
name: 食材类别规范库建设方案
overview: 创建食材类别规范库管理系统，包括数据库集合设计、云函数集成、前端管理页面以及所有使用类别的代码更新，实现类别的统一管理和自动分类。
todos:
  - id: init-category-collection
    content: 创建 ingredient_categories 集合初始化脚本（cloudfunctions/database/init-ingredient-categories.js），包含默认类别数据和映射关系
    status: completed
  - id: create-category-utils
    content: 创建类别工具模块（cloudfunctions/ingredient-standard-manage/category-utils.js），提供类别推断、映射等功能
    status: completed
  - id: integrate-category-manage
    content: 在 ingredient-standard-manage 云函数中集成类别管理功能（添加 category.* actions）
    status: completed
    dependencies:
      - create-category-utils
  - id: update-import-flow
    content: 更新 import-ingredients-from-list.js，使用类别工具模块替代硬编码的推断和映射函数
    status: completed
    dependencies:
      - create-category-utils
  - id: update-backend-category-usage
    content: 更新所有后端代码中使用类别的地方（carbon/index.js, restaurant-menu-carbon/index.js 等），使用统一的类别工具模块
    status: completed
    dependencies:
      - create-category-utils
  - id: create-frontend-api
    content: 更新前端服务文件（ingredientStandard.ts），添加类别管理API方法
    status: completed
    dependencies:
      - integrate-category-manage
  - id: create-category-types
    content: 创建前端类型定义文件（types/ingredientCategory.ts）
    status: completed
  - id: create-category-list-page
    content: 创建类别列表页（pages/base/CategoryList.tsx）
    status: completed
    dependencies:
      - create-frontend-api
      - create-category-types
  - id: create-category-detail-page
    content: 创建类别详情/编辑页（pages/base/CategoryDetail.tsx）和关键词管理组件
    status: completed
    dependencies:
      - create-frontend-api
      - create-category-types
  - id: update-routes-and-menu
    content: 更新路由配置（App.tsx）和菜单配置（MainLayout.tsx），添加类别管理页面
    status: completed
    dependencies:
      - create-category-list-page
      - create-category-detail-page
  - id: update-frontend-category-usage
    content: 更新所有前端页面中使用类别的地方（IngredientEdit.tsx, StandardDetail.tsx 等），从API获取类别列表
    status: completed
    dependencies:
      - create-frontend-api
  - id: add-indexes-config
    content: 在索引配置表中添加 ingredient_categories 集合的索引配置
    status: completed
  - id: integrate-init-action
    content: 在 database 云函数中添加 initIngredientCategories action，并部署执行初始化
    status: completed
    dependencies:
      - init-category-collection
---

# 食材类别规范库建设方案

## 一、数据库设计

### 1.1 创建 `ingredient_categories` 集合

集合结构：

```javascript
{
  _id: ObjectId,
  categoryCode: String,           // 类别代码（主键，如 'vegetables'）
  categoryName: String,            // 类别名称（如 '蔬菜类'）
  categoryNameEn: String,          // 英文名称（如 'Vegetables'）
  parentCategoryCode: String,      // 父类别代码（用于层级分类，null表示主类别）
  level: Number,                   // 层级（1=主类别，2=子类别）
  sortOrder: Number,               // 排序顺序
  mapping: {
    factorSubCategory: String,     // 映射到因子库的subCategory（如 'vegetable'）
    keywords: Array<String>        // 自动推断关键词（如 ['菜', '叶', '根']）
  },
  description: String,             // 描述
  status: String,                  // 状态：'active' | 'deprecated'
  createdAt: Date,
  updatedAt: Date,
  createdBy: String,               // 创建者
  updatedBy: String                // 更新者
}
```

索引配置（需要添加到 [Docs/索引配置表.csv](Docs/索引配置表.csv)）：

- `categoryCode` 唯一索引
- `parentCategoryCode` 普通索引
- `status` 普通索引
- `sortOrder` 普通索引

### 1.2 创建类别初始化脚本

文件：`cloudfunctions/database/init-ingredient-categories.js`功能：

- 创建 `ingredient_categories` 集合
- 初始化默认类别数据（从现有的硬编码类别提取）
- 包含类别代码、名称、映射关系、关键词等信息

默认类别数据（基于现有代码）：

- vegetables（蔬菜类）
- beans（豆制品）
- grains（谷物类）
- fruits（水果类）
- nuts（坚果类）
- mushrooms（菌菇类）
- spices（调料类）
- seafood（海鲜类）
- dairy（乳制品）
- others（其他）

## 二、云函数集成

### 2.1 更新 `ingredient-standard-manage` 云函数

文件：`cloudfunctions/ingredient-standard-manage/index.js`添加类别管理相关的 action：

- `category.list` - 获取类别列表
- `category.get` - 获取类别详情
- `category.create` - 创建类别
- `category.update` - 更新类别
- `category.delete` - 删除类别（软删除，设置为deprecated）
- `category.getKeywords` - 获取类别的关键词列表

新增文件：`cloudfunctions/ingredient-standard-manage/manage-categories.js`

- 实现所有类别管理的业务逻辑
- 包含类别CRUD操作
- 包含类别关键词管理

### 2.2 创建类别工具模块

文件：`cloudfunctions/ingredient-standard-manage/category-utils.js`功能：

- `getCategories()` - 从数据库获取所有活跃类别
- `getCategoryByCode(categoryCode)` - 根据类别代码获取类别信息
- `inferCategory(ingredientName)` - 根据食材名称推断类别（使用类别表中的关键词）
- `mapCategoryToFactorSubCategory(categoryCode)` - 映射类别到因子库subCategory

### 2.3 更新导入流程

文件：`cloudfunctions/database/import-ingredients-from-list.js`更新：

- 移除硬编码的 `inferCategory` 函数
- 移除硬编码的 `mapIngredientCategoryToSubCategory` 函数
- 引入 `category-utils` 模块，使用动态的类别推断和映射

### 2.4 更新其他使用类别的地方

需要更新的文件：

1. `cloudfunctions/carbon/index.js` - 更新 `mapIngredientCategoryToSubCategory` 函数
2. `cloudfunctions/restaurant-menu-carbon/index.js` - 更新映射函数
3. `cloudfunctions/database/verify-factors-migration.js` - 更新映射函数
4. `cloudfunctions/database/migrate-factors-integration.js` - 更新映射函数
5. `cloudfunctions/database/init-factors-from-existing-ingredients.js` - 更新映射函数

更新方式：引入 `category-utils` 模块，使用统一的映射函数

## 三、前端服务API

### 3.1 更新前端服务文件

文件：`admin-web/src/services/ingredientStandard.ts`添加类别管理API：

```typescript
category: {
  list: (params?: { status?: 'active' | 'deprecated' }) => ...
  get: (categoryCode: string) => ...
  create: (data: CategoryData) => ...
  update: (categoryCode: string, data: Partial<CategoryData>) => ...
  delete: (categoryCode: string) => ...
  getKeywords: (categoryCode: string) => ...
}
```



### 3.2 创建类别管理的类型定义

文件：`admin-web/src/types/ingredientCategory.ts`定义 `IngredientCategory` 接口

## 四、前端管理页面

### 4.1 创建类别列表页

文件：`admin-web/src/pages/base/CategoryList.tsx`功能：

- 显示类别列表（表格形式）
- 支持按状态筛选（active/deprecated）
- 支持搜索（类别代码、名称）
- 操作：新建、编辑、删除（软删除）、查看详情
- 显示类别的映射关系和关键词数量

### 4.2 创建类别详情/编辑页

文件：`admin-web/src/pages/base/CategoryDetail.tsx`功能：

- 新建/编辑类别
- 基本信息表单（类别代码、名称、映射关系）
- 关键词管理（添加、删除关键词）
- 子类别管理（如果支持层级分类）

### 4.3 创建关键词管理组件（可选）

文件：`admin-web/src/pages/base/components/CategoryKeywordManagement.tsx`功能：

- 显示关键词列表
- 添加关键词（单个或批量）
- 删除关键词

### 4.4 更新路由配置

文件：`admin-web/src/App.tsx`添加路由：

- `/base/categories` - 类别列表
- `/base/categories/new` - 新建类别
- `/base/categories/:categoryCode` - 类别详情/编辑

使用 `RouteGuard` 限制仅 `platform_operator` 角色可访问

### 4.5 更新菜单配置

文件：`admin-web/src/layouts/MainLayout.tsx`在"基础数据管理"菜单下添加：

```javascript
{
  key: '/base/categories',
  label: '食材类别管理',
}
```



## 五、更新所有使用类别的代码

### 5.1 前端页面更新

需要更新的文件：

1. `admin-web/src/pages/base/IngredientEdit.tsx`

- 移除硬编码的 `CATEGORY_OPTIONS`
- 从API获取类别列表并填充下拉选项

2. `admin-web/src/pages/base/IngredientList.tsx`

- 更新类别筛选选项，从API获取

3. `admin-web/src/pages/base/StandardDetail.tsx`

- 更新类别选择，从API获取

4. `admin-web/src/pages/base/StandardList.tsx`

- 更新类别筛选和显示，从API获取

5. `admin-web/src/pages/base/Import.tsx`

- 更新类别说明，从API获取

### 5.2 创建类别工具Hook（可选）

文件：`admin-web/src/hooks/useIngredientCategories.ts`功能：

- 提供获取类别列表的Hook
- 缓存类别数据，避免重复请求
- 提供类别代码到名称的映射函数

## 六、数据库初始化

### 6.1 更新 database 云函数

文件：`cloudfunctions/database/index.js`添加 action：

- `initIngredientCategories` - 初始化类别集合和数据

### 6.2 执行初始化

步骤：

1. 部署更新后的 `database` 云函数
2. 调用 `initIngredientCategories` action 创建集合并初始化数据
3. 在控制台手动创建索引（参考索引配置表）

## 七、数据迁移（如果需要）

如果现有数据中有类别字段需要验证或更新：

- 创建迁移脚本验证现有类别数据是否都在新类别表中
- 如果发现不在表中的类别，可以自动创建或标记为需要处理

## 实施顺序

1. 创建数据库集合和初始化脚本
2. 创建类别工具模块
3. 集成到 `ingredient-standard-manage` 云函数
4. 更新导入流程和所有使用类别的后端代码
5. 创建前端API服务
6. 创建前端管理页面
7. 更新所有使用类别的前端页面
8. 执行数据库初始化
9. 测试验证

## 注意事项

1. **向后兼容**：在过渡期间，如果类别表中没有数据，应回退到硬编码的类别列表
2. **类别代码唯一性**：类别代码作为主键，必须唯一，不可修改（修改时创建新类别）
3. **关键词匹配**：关键词匹配逻辑需要优化，避免误匹配