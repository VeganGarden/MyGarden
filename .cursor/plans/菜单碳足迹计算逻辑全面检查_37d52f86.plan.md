---
name: 菜单碳足迹计算逻辑全面检查
overview: 对菜单碳足迹计算模块进行全面代码审查，列出所有计算逻辑和数据存取逻辑，并提出改进方案
todos:
  - id: fix-calculation-details-update
    content: 简化calculationDetails字段的更新逻辑，避免分两步更新的复杂操作
    status: pending
  - id: add-factor-match-cache
    content: 实现因子匹配结果缓存机制，提高批量计算性能
    status: pending
  - id: optimize-batch-calculation
    content: 优化批量计算性能：避免重复查询餐厅信息，考虑批量更新数据库
    status: pending
  - id: extract-helper-functions
    content: 将长函数拆分为更小的辅助函数：基准值查询、碳减排认定、单位转换等
    status: pending
  - id: improve-error-handling
    content: 根据计算级别优化因子匹配失败的处理策略，添加计算结果合理性验证
    status: pending
  - id: unify-default-values
    content: 创建统一的配置常量文件，统一管理所有硬编码默认值
    status: pending
  - id: add-data-validation
    content: 完善输入数据验证：食材数据格式、cookingTime范围等
    status: pending
  - id: improve-region-validation
    content: 优化区域代码验证：添加降级策略，验证失败时使用默认区域
    status: pending
  - id: remove-category-fallback
    content: 取消Level 3类别兜底匹配：vegetable类别因子过于粗糙，不同蔬菜因子差异大，使用类别匹配会导致结果不准确。匹配失败时返回null并记录警告，更透明
    status: pending
  - id: simplify-energy-factor-match
    content: 简化能源因子匹配策略：只使用精确区域匹配（电力因子使用基准值区域，燃气因子使用因子区域）。取消所有降级策略（电网区域降级、名称匹配、全国平均降级），因为电网区域可以覆盖全国范围，不存在降级需求。匹配失败时返回null并记录警告
    status: pending
---

# 菜单碳足迹计算逻辑全面检查

报告

## 一、核心计算逻辑

### 1.1 计算级别体系

系统支持三个计算级别，位于 `cloudfunctions/restaurant-menu-carbon/index.js`：

#### L1级别（估算级）

- **位置**: `calculateCarbonFootprintL1()` 函数（第783-952行）
- **逻辑**: 直接使用基准值作为估算值，不进行详细分解
- **适用场景**: 快速铺量、小微餐厅、商户数据缺失
- **计算公式**: 
- 总碳足迹 = 基准值
- 分解比例：食材70%，能耗20%，包装5%，运输5%（行业经验值）

#### L2级别（核算级）

- **位置**: `calculateCarbonFootprint()` 函数（第447-756行）
- **逻辑**: 基于标准配方(BOM)和标准能耗模型进行详细计算
- **适用场景**: 常规餐厅和标准菜单
- **计算公式**:
  ```javascript
        CF_dish = CF_ingredients + CF_energy + CF_packaging + CF_transport
        
        CF_ingredients = Σ(M_i × EF_i × (1 + W_i))
                            - M_i: 食材i的净重 (kg)
                            - EF_i: 食材i的排放因子 (kg CO₂e/kg)
                            - W_i: 食材i的损耗率 (比例)
        
        CF_energy = Power(kW) × Time(h) × EnergyFactor(kg CO₂e/kWh)
  ```




#### L3级别（实测级）

- **位置**: `calculateCarbonFootprintL3()` 函数（第968-1301行）
- **逻辑**: 基于动态BOM、智能电表实测数据和溯源因子
- **适用场景**: 标杆气候餐厅、碳资产开发
- **特点**: 
- 支持实测能耗数据（`meterReading`）
- 支持溯源信息（`traceability`）
- 记录审计日志

### 1.2 因子匹配逻辑

#### 食材因子匹配

- **位置**: `matchFactor()` 函数（第1843-1935行）
- **匹配策略**（三级匹配，已优化）:

1. **Level 1**: 精确区域匹配（名称 + 区域）
2. **Level 2**: 别名匹配（别名 + 区域）
3. ~~**Level 3**: 类别兜底（类别 + 区域）~~ **已取消**：类别匹配过于粗糙（如vegetable类别包含多种差异很大的蔬菜），使用`orderBy('createdAt', 'desc').limit(1)`取最新因子不够准确，可能导致计算结果偏差
4. **验证**: 区域代码必须在 `region_configs` 中存在且为激活状态

**注意**: 如果Level 1和Level 2都匹配失败，返回null并记录警告，提示用户需要添加具体的因子数据

#### 能源因子匹配

- **位置**: `matchEnergyFactor()` 函数（第1419-1531行）
- **匹配策略**（已优化为仅精确匹配）:

1. **精确区域匹配**（仅此一级）:

                                                                                                                                                                                                - 电力因子使用基准值区域（电网区域，如 `east_china`, `north_china` 等）
                                                                                                                                                                                                - 燃气因子使用因子区域（国家级别，如 `CN`, `US` 等）

~~2. 电网区域降级到CN（国家级别）~~ **已取消**：电网区域可以覆盖全国范围，不需要降级~~3. 名称匹配~~ **已取消**：不需要降级策略~~4. 全国平均降级~~ **已取消**：如果精确匹配失败，返回null并记录警告**注意**: 如果精确匹配失败，返回null并记录警告，提示用户需要添加对应区域的能源因子

#### 材料因子匹配

- **位置**: `matchMaterialFactor()` 函数（第1539-1634行）
- **匹配策略**: 精确匹配 → 别名匹配 → 模糊匹配 → 国家级匹配

#### 运输因子匹配

- **位置**: `matchTransportFactor()` 函数（第1642-1689行）
- **匹配策略**: 精确区域匹配 → 国家级匹配

### 1.3 基准值查询逻辑

- **位置**: `calculateMenuItemCarbon()` 函数（第258-355行）
- **查询流程**:

1. 调用 `carbon-baseline-query` 云函数查询基准值
2. 如果失败，降级查询全国平均基准值
3. 如果仍失败，使用默认基准值（`getDefaultBaseline()`）

- **置信区间处理**:
- 优先使用基准值中的 `confidenceInterval`
- 如果没有，使用 `uncertainty` 计算置信区间
- 如果都没有，使用默认不确定性（10%）

### 1.4 碳减排认定逻辑

- **位置**: `calculateMenuItemCarbon()` 函数（第360-389行）
- **分级标准**:
- **显著减排**（low）: CF < Baseline_lower_bound
- **行业达标**（medium）: Baseline_lower_bound ≤ CF ≤ Baseline_upper_bound
- **高碳排放**（high）: CF > Baseline_upper_bound

## 二、数据存取逻辑

### 2.1 数据读取

#### 菜单项数据读取

- **位置**: `recalculateMenuItems()` 函数（第1944-2204行）
- **数据源**: `restaurant_menu_items` 集合
- **读取逻辑**:
  ```javascript
        // 查询菜单项
        const menuItems = await db.collection('restaurant_menu_items')
          .where({ restaurantId: data.restaurantId })
          .get()
        
        // 如果菜单项没有ingredients，从关联的recipes获取
        if (!ingredients && menuItem.baseRecipeId) {
          const recipe = await db.collection('recipes').doc(menuItem.baseRecipeId).get()
          ingredients = recipe.data.ingredients
        }
  ```




#### 因子数据读取

- **数据源**: `carbon_emission_factors` 集合
- **查询条件**: 
- `status: 'active'`（必须激活）
- `region`（区域代码）
- `category`（类别：ingredient/energy/material/transport）

#### 配置数据读取

- **位置**: `loadConfigs()` 函数（第1349-1393行）
- **数据源**: `carbon_calculation_configs` 集合
- **缓存机制**: 5分钟TTL，降级使用硬编码默认值
- **配置项**:
- `ingredient_waste_rate`: 食材损耗率
- `default_electric_factor`: 默认电力因子
- `default_gas_factor`: 默认燃气因子
- `standard_time_model`: 标准工时模型
- `standard_power_model`: 标准功率模型

### 2.2 数据保存

#### 计算结果保存

- **位置**: `recalculateMenuItems()` 函数（第2100-2160行）
- **保存字段**:
  ```javascript
        {
          carbonFootprint: { value, baseline, reduction, breakdown },
          baselineInfo: { baselineId, version, source },
          factorMatchInfo: [...],
          calculationLevel: 'L1' | 'L2' | 'L3',
          calculationDetails: {...}, // L2和L3级别才有
          optimizationFlag: { needsOptimization, warningMessage },
          carbonLevel: 'low' | 'medium' | 'high',
          calculatedAt: Date,
          restaurantRegion: string, // 基准值区域代码
          factorRegion: string // 因子区域代码
        }
  ```




#### 特殊处理

- **calculationDetails字段**: 如果原来是null，需要分两步更新（先删除再设置）
- **旧格式兼容**: 如果 `carbonFootprint` 是数字（旧格式），需要删除该字段

## 三、前端交互逻辑

### 3.1 页面组件

- **位置**: `admin-web/src/pages/carbon/Menu.tsx`
- **功能**:
- 菜单项列表展示（使用Collapse组件）
- 计算明细展示（食材明细表格、能耗/包装/运输卡片）
- 重新计算功能（单个/批量）
- 配置编辑功能（餐食类型、用能方式、计算级别、区域配置）

### 3.2 数据转换

- **位置**: `admin-web/src/utils/menuItemTransform.ts`
- **功能**:
- 统一处理新旧数据格式
- 处理 `carbonFootprint` 的 number 和 object 两种格式
- 处理 `calculationDetails` 的 null 值

## 四、发现的问题和改进方案

### 4.1 性能问题

#### 问题1: 批量计算时重复查询餐厅信息

- **位置**: `recalculateMenuItems()` 函数（第1987-1994行）
- **问题**: 虽然预先获取了餐厅信息，但在 `calculateCarbonFootprint()` 中可能再次查询
- **改进方案**: 
- 将餐厅信息作为参数传递，避免重复查询
- 在批量计算时，一次性获取所有需要的配置数据

#### 问题2: 因子匹配没有缓存机制

- **位置**: `matchFactor()` 等匹配函数
- **问题**: 每次计算都要查询数据库，相同食材重复查询
- **改进方案**:
- 实现因子匹配结果缓存（使用Map，键为 `name+category+region`）
- 缓存TTL设置为5分钟

#### 问题3: 批量计算时逐个更新数据库

- **位置**: `recalculateMenuItems()` 函数（第2001-2185行）
- **问题**: 循环中逐个更新，效率低
- **改进方案**:
- 使用批量更新（如果云数据库支持）
- 或者使用事务批量提交

### 4.2 数据一致性问题

#### 问题1: calculationDetails 更新逻辑复杂

- **位置**: `recalculateMenuItems()` 函数（第2124-2153行）
- **问题**: 需要分两步更新（先删除null再设置），容易出错
- **改进方案**:
- 统一使用 `_.set()` 方法更新嵌套字段
- 或者使用 `update()` 的 `merge: true` 选项

#### 问题2: 区域代码验证可能失败

- **位置**: `validateRegionCode()` 函数（第1328-1344行）
- **问题**: 验证失败时返回false，但可能影响计算
- **改进方案**:
- 添加降级策略：验证失败时使用默认区域（CN）
- 记录警告日志，但不中断计算

### 4.3 错误处理问题

#### 问题1: Level 3类别兜底匹配过于粗糙

- **位置**: `matchFactor()` 函数（第1894-1932行）
- **问题**: 
                                                                                                                                - 使用 `orderBy('createdAt', 'desc').limit(1)` 取最新的类别因子
                                                                                                                                - 大量蔬菜都是vegetable类别，但不同蔬菜的排放因子差异很大（如叶菜类 vs 根茎类）
                                                                                                                                - 使用同一个类别因子会导致计算结果不准确
                                                                                                                                - 用户无法知道实际使用的是哪个因子
- **改进方案**:
                                                                                                                                - **取消Level 3类别兜底匹配**
                                                                                                                                - 如果Level 1和Level 2都匹配失败，返回null并记录警告
                                                                                                                                - 在 `factorMatchInfo` 中明确标识匹配失败，提示用户需要添加具体因子
                                                                                                                                - 这样更透明，用户可以知道哪些食材需要补充因子数据

#### 问题2: 因子匹配失败时静默跳过

- **位置**: `calculateCarbonFootprint()` 函数（第610-622行）
- **问题**: 因子匹配失败时只记录warning，不中断计算，可能导致结果不准确
- **改进方案**:
- 根据计算级别决定是否允许失败：L1允许，L2警告，L3必须匹配成功
- 在结果中明确标识哪些食材未匹配到因子

#### 问题3: 能源因子匹配策略过于复杂

- **位置**: `matchEnergyFactor()` 函数（第1419-1531行）
- **问题**: 
                                - 当前有4级匹配策略：精确区域匹配、电网区域降级到CN、名称匹配、全国平均降级
                                - 实际上电网区域可以覆盖全国范围（如华东电网、华北电网等），不存在需要降级到国家级别的情况
                                - 降级策略增加了代码复杂度，且可能匹配到不准确的因子
- **改进方案**:
                                - **只保留精确区域匹配**
                                - 电力因子使用基准值区域（电网区域，如 `east_china`, `north_china` 等）
                                - 燃气因子使用因子区域（国家级别，如 `CN`, `US` 等）
                                - 如果精确匹配失败，返回null并记录警告，提示用户需要添加对应区域的能源因子
                                - 这样更简洁、准确，符合实际业务场景

#### 问题4: 配置加载失败时使用硬编码值

- **位置**: `loadConfigs()` 函数（第1388-1392行）
- **问题**: 降级使用硬编码值，但可能不是最新的配置
- **改进方案**:
- 记录配置加载失败的错误日志
- 在管理后台显示配置加载状态

### 4.4 代码质量问题

#### 问题1: 函数过长

- **位置**: `calculateMenuItemCarbon()` 函数（111行）和 `recalculateMenuItems()` 函数（260行）
- **问题**: 函数过长，难以维护
- **改进方案**:
- 将基准值查询逻辑提取为独立函数
- 将碳减排认定逻辑提取为独立函数
- 将更新逻辑提取为独立函数

#### 问题2: 硬编码的默认值分散

- **位置**: 多处硬编码默认值（损耗率、能源因子、基准值等）
- **问题**: 难以统一管理和更新
- **改进方案**:
- 创建统一的配置常量文件
- 所有默认值从配置常量读取

#### 问题3: 单位转换逻辑重复

- **位置**: `calculateCarbonFootprint()` 和 `calculateCarbonFootprintL3()` 中都有单位转换逻辑
- **问题**: 代码重复
- **改进方案**:
- 提取为单位转换工具函数 `convertToKg(quantity, unit)`

### 4.5 数据验证问题

#### 问题1: 输入数据验证不完整

- **位置**: `calculateMenuItemCarbon()` 函数（第113-137行）
- **问题**: 只验证了必填字段，没有验证数据格式和范围
- **改进方案**:
- 添加食材数据格式验证（quantity必须>0，unit必须在允许列表中）
- 添加cookingTime范围验证（0-999分钟）

#### 问题2: 计算结果验证缺失

- **位置**: 所有计算函数
- **问题**: 没有验证计算结果是否合理（如负数、过大值）
- **改进方案**:
- 添加结果合理性检查
- 如果结果异常，记录警告并返回错误

## 五、改进优先级

### 高优先级（影响功能正确性）

1. **取消Level 3类别兜底匹配**：类别匹配过于粗糙，vegetable类别包含多种差异很大的蔬菜，使用类别因子会导致计算结果不准确。应取消该级别，匹配失败时返回null并记录警告。
2. **简化能源因子匹配策略**：只使用精确区域匹配（电力因子使用基准值区域，燃气因子使用因子区域）。取消所有降级策略（电网区域降级、名称匹配、全国平均降级），因为电网区域可以覆盖全国范围，不存在降级需求。匹配失败时返回null并记录警告。
3. 因子匹配失败处理策略优化（根据计算级别）
4. 计算结果合理性验证
5. calculationDetails 更新逻辑简化

### 中优先级（影响性能和可维护性）

1. 因子匹配缓存机制
2. 批量计算性能优化
3. 函数拆分和代码重构

### 低优先级（代码质量）

1. 硬编码值统一管理
2. 单位转换逻辑提取
3. 错误日志完善

## 六、建议的改进实施步骤