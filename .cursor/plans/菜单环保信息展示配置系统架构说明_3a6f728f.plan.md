---
name: 菜单环保信息展示配置系统架构说明
overview: 创建一个详细的技术文档，说明菜单环保信息展示配置系统的三个核心问题：配置存储位置、与菜单系统的集成方式、以及API接口集成方案
todos:
  - id: doc-architecture
    content: 创建架构说明文档，详细描述配置存储、集成方式和API接口
    status: pending
---

# 菜单环保信息展示配置系统架构说明

## 1. 配置存储位置

### 1.1 数据库集合

配置数据保存在 MongoDB 集合 `restaurant_menu_display_configs` 中。

### 1.2 数据模型结构

每个配置文档包含以下字段：

- `restaurantId`: 餐厅ID（必填，用于区分不同餐厅）
- `tenantId`: 租户ID（从餐厅信息中获取）
- `globalConfig`: 全局配置（默认展示级别、启用状态等）
- `mediaConfig`: 媒介配置（针对6种媒介类型的个性化配置）
- `physicalMenu`: 纸质菜单
- `digitalMenu`: 电子菜单
- `mobileApp`: 移动端App/小程序
- `onlineMenu`: 在线菜单
- `posSystem`: 收银系统
- `receipt`: 小票打印
- `styleConfig`: 视觉样式配置（图标大小、颜色方案、位置等）
- `features`: 功能开关（过滤、排序、推荐等）
- `textConfig`: 文本自定义（多语言支持：zh_CN, en_US）
- `version`: 版本号（用于乐观锁和版本控制）
- `status`: 状态（'active'/'inactive'，支持配置历史记录）
- `createdAt`, `updatedAt`: 时间戳
- `createdBy`, `updatedBy`: 操作人

### 1.3 存储位置代码引用

- 配置创建：[cloudfunctions/menu-carbon-label/index.js:910-913](cloudfunctions/menu-carbon-label/index.js)
- 配置查询：[cloudfunctions/menu-carbon-label/index.js:437-451](cloudfunctions/menu-carbon-label/index.js)
- 配置更新：[cloudfunctions/menu-carbon-label/index.js:959-1020](cloudfunctions/menu-carbon-label/index.js)

## 2. 与餐厅菜单系统的集成方式

### 2.1 集成流程

```javascript
菜单项请求 → 获取配置 → 应用配置 → 格式化标签 → 返回结果
```



### 2.2 核心集成点

#### 2.2.1 配置获取

在获取菜单项的碳标签时，系统会根据 `restaurantId` 和 `media` 类型自动获取对应的配置：

```javascript
// 代码位置：cloudfunctions/menu-carbon-label/index.js:99-100
const config = await getRestaurantConfig(restaurantId, media);
```



#### 2.2.2 配置应用

配置会应用于以下场景：

1. **标签格式化**：根据配置的展示级别和显示内容选项，决定标签显示的详细信息
2. **样式应用**：根据配置的图标大小、颜色方案等，生成对应的标签样式
3. **多语言支持**：根据配置的文本自定义，返回对应语言的标签文本

#### 2.2.3 配置缓存机制

- 使用内存缓存（1小时TTL）提高性能
- 缓存键格式：`${restaurantId}_${media}`
- 配置更新时自动清除缓存

### 2.3 集成代码位置

- 菜单项标签获取：[cloudfunctions/menu-carbon-label/index.js:66-134](cloudfunctions/menu-carbon-label/index.js)
- 批量标签获取：[cloudfunctions/menu-carbon-label/index.js:149-295](cloudfunctions/menu-carbon-label/index.js)
- 配置获取与合并：[cloudfunctions/menu-carbon-label/index.js:511-564](cloudfunctions/menu-carbon-label/index.js)
- 标签格式化：[cloudfunctions/menu-carbon-label/index.js:569-618](cloudfunctions/menu-carbon-label/index.js)

## 3. API接口集成方案

### 3.1 云函数接口

所有接口通过 `menu-carbon-label` 云函数提供，使用 action 模式区分不同操作。

#### 3.1.1 配置管理接口

**获取配置**

```javascript
// 调用方式
{
  action: 'getMenuDisplayConfig',
  data: {
    restaurantId: 'restaurant_id',
    version: 1  // 可选
  }
}

// 返回示例
{
  code: 0,
  message: '成功',
  data: {
    restaurantId: 'restaurant_id',
    globalConfig: {...},
    mediaConfig: {...},
    styleConfig: {...},
    features: {...},
    textConfig: {...},
    version: 1,
    status: 'active',
    updatedAt: '2024-01-01T00:00:00.000Z'
  }
}
```

**创建配置**

```javascript
{
  action: 'createMenuDisplayConfig',
  data: {
    restaurantId: 'restaurant_id',
    config: {
      globalConfig: {...},
      mediaConfig: {...},
      styleConfig: {...},
      features: {...},
      textConfig: {...}
    }
  }
}
```

**更新配置**

```javascript
{
  action: 'updateMenuDisplayConfig',
  data: {
    restaurantId: 'restaurant_id',
    config: {...},
    version: 1  // 必填，用于乐观锁
  }
}
```



#### 3.1.2 标签获取接口

**获取单个菜单项标签**

```javascript
{
  action: 'getMenuItemCarbonLabel',
  data: {
    restaurantId: 'restaurant_id',
    menuItemId: 'menu_item_id',
    media: 'physicalMenu',  // 可选，默认'basic'
    language: 'zh_CN'       // 可选，默认'zh_CN'
  }
}
```

**批量获取菜单项标签**

```javascript
{
  action: 'getMenuItemsCarbonLabels',
  data: {
    restaurantId: 'restaurant_id',
    menuItemIds: ['id1', 'id2'],  // 可选
    media: 'digitalMenu',
    language: 'zh_CN',
    filter: {
      carbonLevel: 'low',
      category: 'main'
    },
    sort: {
      field: 'carbonFootprint',
      order: 'asc'
    },
    page: 1,
    pageSize: 20
  }
}
```

**获取订单标签**

```javascript
{
  action: 'getOrderCarbonLabel',
  data: {
    orderId: 'order_id',
    media: 'receipt',
    language: 'zh_CN'
  }
}
```



### 3.2 前端服务封装

前端通过服务层封装了所有API调用：

- 服务文件：[admin-web/src/services/menuDisplayConfig.ts](admin-web/src/services/menuDisplayConfig.ts)
- 配置管理页面：[admin-web/src/pages/restaurant/MenuDisplayConfig.tsx](admin-web/src/pages/restaurant/MenuDisplayConfig.tsx)

### 3.3 与其他系统集成的建议

#### 3.3.1 通过HTTP触发器（推荐）

如果需要通过HTTP方式调用，可以：

1. 为云函数创建HTTP访问服务
2. 使用标准的RESTful接口设计
3. 添加API密钥或OAuth认证

#### 3.3.2 通过小程序云开发

在小程序端直接调用：

```javascript
wx.cloud.callFunction({
  name: 'menu-carbon-label',
  data: {
    action: 'getMenuItemCarbonLabel',
    data: {
      restaurantId: 'xxx',
      menuItemId: 'xxx'
    }
  }
})
```



#### 3.3.3 通过SDK集成

可以在其他后端系统中：

1. 使用腾讯云SDK调用云函数
2. 或直接连接MongoDB读取配置数据（需要权限控制）

### 3.4 API接口代码位置

- 接口路由分发：[cloudfunctions/menu-carbon-label/index.js:22-55](cloudfunctions/menu-carbon-label/index.js)
- 配置管理接口：[cloudfunctions/menu-carbon-label/index.js:425-1044](cloudfunctions/menu-carbon-label/index.js)
- 标签获取接口：[cloudfunctions/menu-carbon-label/index.js:57-416](cloudfunctions/menu-carbon-label/index.js)

## 总结

1. **配置存储**：每个餐厅的配置独立存储在 `restaurant_menu_display_configs` 集合中，支持版本控制和历史记录