---
name: 气候餐厅碳足迹计算功能完善计划
overview: 基于已有的因子库、基准库、基础食材库和计算规范，完善气候餐厅碳足迹计算功能，包括补全缺失功能点、实现L1/L3计算级别、完善测试和文档等工作。
todos:
  - id: l2_complete
    content: 完善L2级别功能：处理TODO、实现因子库查询（能耗、包装）、添加损耗率支持、添加运输碳排放计算
    status: completed
  - id: data_model
    content: 完善数据模型：餐厅表添加region字段、菜谱表添加mealType/energyType/calculationLevel字段、完善carbonFootprint结构
    status: completed
  - id: frontend_basic
    content: 完善前端基础功能：餐厅编辑页面添加地区选择、菜谱编辑页面添加必要字段、列表和详情页面完善展示
    status: completed
    dependencies:
      - data_model
  - id: l1_implementation
    content: 实现L1级别功能：创建L1计算函数、实现品类基准值数据、支持L1级别选择
    status: completed
    dependencies:
      - l2_complete
  - id: l3_implementation
    content: 实现L3级别功能：动态BOM、智能电表接口、溯源因子支持、审计日志
    status: completed
    dependencies:
      - l2_complete
  - id: testing
    content: 测试验证：单元测试、集成测试、性能测试、数据质量测试
    status: completed
    dependencies:
      - l2_complete
      - l1_implementation
      - l3_implementation
  - id: documentation
    content: 文档完善：API文档、使用文档、部署文档、开发文档
    status: completed
    dependencies:
      - l2_complete
---

# 气候餐厅碳足迹计算功能完善计划

## 一、现状分析

### 已完成的工作

1. **数据基础设施**

   - 因子库（`carbon_emission_factors`）：完整的CRUD和管理功能
   - 基准值库（`carbon_baselines`）：完整的CRUD和管理功能  
   - 基础食材库（`ingredients`, `meat_products`）：已存在
   - 计算规范文档（v1.1）：已更新，明确L1/L2/L3三级体系

2. **核心计算功能（L2级别）**

   - `restaurant-menu-carbon` 云函数：基础计算逻辑已实现
   - 多级因子匹配算法：Level 1-4已实现
   - 基准值查询：已实现并集成

3. **前端管理界面**

   - 因子库管理页面：完整
   - 基准值管理页面：完整
   - 菜谱碳足迹页面（Menu.tsx）：基础功能存在

### 待完成的工作

#### 1. L2级别功能完善

- [ ] 完善 `restaurant-menu-carbon` 云函数中的TODO（第213行）
- [ ] 烹饪能耗因子从因子库查询（当前使用硬编码系数）
- [ ] 包装材料因子从因子库查询（当前使用硬编码系数）
- [ ] 运输碳排放计算（规范中提到但未实现）
- [ ] 损耗率支持（规范中的公式包含 $W_i$ 但代码中未实现）

#### 2. L1级别功能实现（估算级）

- [ ] 创建L1计算逻辑：基于品类基准值直接映射
- [ ] 实现品类基准值数据（或使用现有基准值的简化版）
- [ ] 在菜谱录入时支持选择计算级别（L1/L2/L3）
- [ ] L1计算结果的标识和展示

#### 3. L3级别功能实现（实测级）

- [ ] 实现动态BOM功能（实时食材重量输入）
- [ ] 智能电表数据接入接口（或模拟接口）
- [ ] 溯源因子支持（运输、供应链溯源）
- [ ] L3计算结果的数据追溯和审计日志

#### 4. 数据模型完善

- [ ] 餐厅表添加 `region` 字段（必填）
- [ ] 菜谱表添加 `mealType` 和 `energyType` 字段（必填）
- [ ] 菜谱表完善 `carbonFootprint` 结构（包含value、baseline、reduction三值）
- [ ] 菜谱表添加 `baselineInfo` 字段（记录基准值查询信息）
- [ ] 菜谱表添加 `calculationLevel` 字段（L1/L2/L3）
- [ ] 菜谱表添加 `factorMatchInfo` 字段（记录因子匹配详情）

#### 5. 前端功能完善

- [ ] 餐厅编辑页面添加地区选择（必填验证）
- [ ] 菜谱编辑页面添加餐食类型和用能方式选择（必填验证）
- [ ] 菜谱编辑页面添加计算级别选择（L1/L2/L3）
- [ ] 菜谱列表页面展示三值（碳足迹值、基准值、减排值）
- [ ] 菜谱详情页面展示计算详情（因子匹配信息、基准值信息）
- [ ] 菜谱碳足迹计算结果的可视化展示

#### 6. 数据验证和错误处理

- [ ] 计算前数据完整性验证（必填字段检查）
- [ ] 因子匹配失败的处理策略（降级、提示、记录）
- [ ] 基准值查询失败的处理策略（降级到全国平均、使用默认值）
- [ ] 计算结果异常值的检测和提示

#### 7. 测试验证

- [ ] 单元测试：因子匹配算法测试
- [ ] 单元测试：计算逻辑测试（L1/L2/L3）
- [ ] 集成测试：云函数端到端测试
- [ ] 集成测试：前端页面功能测试
- [ ] 性能测试：批量计算性能测试
- [ ] 数据质量测试：计算结果准确性验证

#### 8. 文档完善

- [ ] API文档：云函数接口文档
- [ ] 使用文档：管理员使用指南
- [ ] 使用文档：餐厅用户使用指南
- [ ] 部署文档：环境配置和部署步骤
- [ ] 开发文档：计算逻辑说明和扩展指南

## 二、实施优先级

### 阶段一：L2级别功能完善（高优先级）

**目标**：完善当前L2级别的核心功能，确保计算准确性和完整性

**任务**：

1. 完善 `calculateCarbonFootprint` 函数（处理TODO）
2. 实现烹饪能耗因子从因子库查询
3. 实现包装材料因子从因子库查询
4. 添加损耗率支持（$W_i$）
5. 添加运输碳排放计算（可选，根据数据源决定）

**相关文件**：

- `cloudfunctions/restaurant-menu-carbon/index.js`
- `cloudfunctions/carbon/index.js`
- `admin-web/src/pages/carbon/Menu.tsx`

### 阶段二：数据模型完善（高优先级）

**目标**：完善数据库结构，支持完整的三值计算和级别标识

**任务**：

1. 餐厅表添加 `region` 字段
2. 菜谱表添加 `mealType`、`energyType`、`calculationLevel` 字段
3. 菜谱表完善 `carbonFootprint` 结构
4. 菜谱表添加 `baselineInfo` 和 `factorMatchInfo` 字段
5. 数据迁移脚本（为现有数据添加新字段默认值）

**相关文件**：

- `cloudfunctions/database/`（数据迁移脚本）
- `admin-web/src/types/`（类型定义）

### 阶段三：前端功能完善（高优先级）

**目标**：完善前端界面，支持完整的菜谱碳足迹管理

**任务**：

1. 餐厅编辑页面添加地区选择
2. 菜谱编辑页面添加必要字段
3. 菜谱列表和详情页面完善展示
4. 添加计算级别选择功能

**相关文件**：

- `admin-web/src/pages/restaurant/`（餐厅管理页面）
- `admin-web/src/pages/carbon/Menu.tsx`
- `admin-web/src/pages/menu/`（菜谱管理页面，如果存在）

### 阶段四：L1级别实现（中优先级）

**目标**：实现快速估算功能，支持数据缺失场景

**任务**：

1. 创建L1计算函数（基于品类基准值）
2. 实现品类基准值数据（可复用现有基准值数据）
3. 在菜谱录入时支持选择L1级别
4. L1计算结果的标识

**相关文件**：

- `cloudfunctions/restaurant-menu-carbon/index.js`（添加L1计算逻辑）
- `admin-web/src/pages/carbon/Menu.tsx`

### 阶段五：L3级别实现（中优先级）

**目标**：实现高精度计算功能，支持碳资产开发

**任务**：

1. 实现动态BOM功能
2. 智能电表数据接口（或模拟接口）
3. 溯源因子支持
4. 审计日志和数据追溯

**相关文件**：

- `cloudfunctions/restaurant-menu-carbon/index.js`（添加L3计算逻辑）
- `cloudfunctions/database/`（新增溯源相关集合）
- `admin-web/src/pages/carbon/Menu.tsx`

### 阶段六：测试和文档（持续进行）

**目标**：确保功能质量和可维护性

**任务**：

1. 编写单元测试
2. 编写集成测试
3. 编写API文档
4. 编写使用文档
5. 编写部署文档

## 三、关键技术点

### 1. 计算级别判断逻辑

```javascript
// 根据数据完整性和用户选择确定计算级别
function determineCalculationLevel(menuItem, userChoice) {
  if (userChoice) return userChoice; // 用户明确选择
  
  // 自动判断：数据完整 -> L2/L3，数据缺失 -> L1
  if (hasCompleteBOM(menuItem) && hasEnergyData(menuItem)) {
    return hasMeterData(menuItem) ? 'L3' : 'L2';
  }
  return 'L1';
}
```

### 2. 三值计算和存储

```javascript
// 计算结果结构
{
  carbonFootprint: {
    value: number,        // 实际碳足迹值
    baseline: number,     // 基准值
    reduction: number,    // 减排值 = baseline - value
    breakdown: {          // 分解数据
      ingredients: number,
      energy: number,
      packaging: number,
      transport: number
    }
  },
  calculationLevel: 'L1' | 'L2' | 'L3',
  baselineInfo: {...},
  factorMatchInfo: [...]
}
```

### 3. 因子匹配信息记录

记录每个食材的因子匹配详情，用于数据追溯和审计：

```javascript
{
  ingredientName: '大米',
  matchedFactor: {
    factorId: 'xxx',
    factorValue: 3.2,
    matchLevel: 'exact_region' | 'national_fallback' | 'alias_fuzzy_match' | 'category_fallback',
    source: 'CLCD',
    year: 2024
  }
}
```

## 四、验收标准

### L2级别功能

- ✅ 所有因子从因子库查询（不再使用硬编码）
- ✅ 支持损耗率计算
- ✅ 支持基准值自动查询和对比
- ✅ 计算结果包含完整的三值和分解数据

### L1级别功能

- ✅ 基于品类基准值快速计算
- ✅ 计算结果明确标识为L1级别
- ✅ 支持在菜谱录入时选择L1级别

### L3级别功能

- ✅ 支持动态BOM输入
- ✅ 支持智能电表数据接入
- ✅ 完整的审计日志和数据追溯

### 前端功能

- ✅ 餐厅编辑页面必填地区
- ✅ 菜谱编辑页面必填餐食类型和用能方式
- ✅ 菜谱列表和详情页面完整展示三值
- ✅ 支持选择计算级别

### 测试

- ✅ 单元测试覆盖率 ≥ 80%
- ✅ 集成测试通过率 100%
- ✅ 性能测试：单次计算 < 2秒，批量计算（100条）< 30秒

### 文档

- ✅ API文档完整
- ✅ 使用文档清晰
- ✅ 部署文档可执行

## 五、风险和注意事项

1. **数据迁移风险**：为现有数据添加新字段时，需要确保不破坏现有功能
2. **性能风险**：L3级别的实时计算可能较慢，需要优化或异