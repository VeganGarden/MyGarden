---
name: 修复菜单碳足迹因子匹配问题并完善L1/L3实现
overview: 修复菜单碳足迹计算中食材因子无法匹配的问题，统一因子匹配逻辑，并完善L1估算级和L3实测级的实现方案。
todos:
  - id: fix_match_factor
    content: 统一 restaurant-menu-carbon/index.js 中的 matchFactor 函数实现，与 carbon/index.js 保持一致，添加区域代码验证
    status: completed
  - id: fix_region_code
    content: 修复区域代码传递逻辑，确保使用正确的区域代码格式（CN），并正确传递给 matchFactor
    status: completed
  - id: add_region_validation
    content: 在 restaurant-menu-carbon/index.js 中添加 validateRegionCode 函数，与 carbon/index.js 保持一致
    status: completed
    dependencies:
      - fix_match_factor
  - id: improve_l1
    content: 完善L1估算级实现，优化基准值查询逻辑，确保使用正确的区域配置
    status: completed
    dependencies:
      - fix_region_code
  - id: improve_l3
    content: 完善L3实测级实现，完善实测能耗数据接口和溯源因子支持
    status: completed
    dependencies:
      - fix_region_code
  - id: frontend_optimization
    content: 优化前端显示，添加因子匹配失败提示和L1/L3级别标识
    status: completed
    dependencies:
      - fix_match_factor
      - improve_l1
      - improve_l3
  - id: test_factor_matching
    content: 测试因子匹配功能，验证常见食材（如丝瓜、刀豆）的匹配结果
    status: pending
    dependencies:
      - fix_match_factor
      - fix_region_code
      - add_region_validation
  - id: test_l1_l3
    content: 测试L1和L3级别的计算功能，验证不同场景下的计算结果
    status: pending
    dependencies:
      - improve_l1
      - improve_l3
---

#修复菜单碳足迹因子匹配问题并完善L1/L3实现

## 问题分析

### 当前问题

1. **因子匹配失败**：菜单碳足迹计算中，食材（如"丝瓜"、"刀豆"）显示"未匹配"，导致碳足迹为0.00
2. **区域代码不一致**：`restaurant-menu-carbon/index.js` 中的 `matchFactor` 函数使用旧逻辑，默认使用 `national_average`，但因子库中的区域代码是 `CN`
3. **匹配逻辑不统一**：`restaurant-menu-carbon/index.js` 和 `carbon/index.js` 中的 `matchFactor` 函数逻辑不一致
4. **L1/L3实现不完整**：L1和L3级别已实现基础功能，但需要完善和优化

### 根本原因

- `restaurant-menu-carbon/index.js` 中的 `matchFactor` 函数（1529行）没有使用区域配置验证
- 菜单项可能没有正确传递 `restaurantRegion` 或 `region` 参数
- 因子匹配时区域代码格式不匹配（`national_average` vs `CN`）

## 解决方案

### 1. 统一因子匹配逻辑

**文件**: `cloudfunctions/restaurant-menu-carbon/index.js`**问题**: 当前 `matchFactor` 函数（1529行）使用旧逻辑，与 `carbon/index.js` 中的逻辑不一致**解决方案**:

- 将 `restaurant-menu-carbon/index.js` 中的 `matchFactor` 函数替换为与 `carbon/index.js` 一致的实现
- 添加区域代码验证（使用 `validateRegionCode`）
- 确保使用正确的区域代码格式（`CN` 而不是 `national_average`）
- 统一多级匹配策略：精确匹配 → 别名匹配 → 类别兜底

**关键修改点**:

```javascript
// 需要添加区域验证
async function validateRegionCode(regionCode) {
  // 与 carbon/index.js 中的实现保持一致
}

// 统一 matchFactor 实现
async function matchFactor(inputName, category, region = null) {
  // 1. 验证区域代码
  // 2. Level 1: 精确区域匹配（region = 'CN'）
  // 3. Level 2: 别名匹配
  // 4. Level 3: 类别兜底
}
```



### 2. 修复区域代码传递

**文件**: `cloudfunctions/restaurant-menu-carbon/index.js`**问题**: 计算时区域代码可能未正确传递或格式不正确**解决方案**:

- 在 `calculateCarbonFootprint` 函数中，确保 `restaurantRegion` 正确获取和传递
- 优先使用菜单项的 `restaurantRegion`，其次使用餐厅的 `region`，最后使用默认值 `CN`
- 确保传递给 `matchFactor` 的区域代码是有效的因子区域代码（如 `CN`）

**关键修改点**:

```javascript
// 在 calculateCarbonFootprint 函数中
let restaurantRegion = 'CN'; // 默认使用 CN，而不是 national_average
if (data.region) {
  restaurantRegion = data.region;
} else if (data.restaurantId) {
  // 从餐厅信息获取
  const restaurant = await db.collection('restaurants').doc(data.restaurantId).get();
  if (restaurant.data && restaurant.data.region) {
    restaurantRegion = restaurant.data.region;
  }
}
```



### 3. 完善L1估算级实现

**文件**: `cloudfunctions/restaurant-menu-carbon/index.js`**当前状态**: L1级别已实现基础功能（`calculateCarbonFootprintL1`），但需要优化**改进方案**:

- 确保L1级别正确使用基准值作为估算值
- 优化基准值查询逻辑，支持区域配置
- 添加L1级别的标识和说明
- 确保前端正确显示L1级别的计算结果

**关键改进点**:

- 基准值查询时使用正确的区域代码（从 `region_configs` 获取基准值区域）
- 返回结果中明确标识 `calculationLevel: 'L1'` 和 `isEstimated: true`
- 添加L1级别的置信区间信息

### 4. 完善L3实测级实现

**文件**: `cloudfunctions/restaurant-menu-carbon/index.js`**当前状态**: L3级别已实现基础功能（`calculateCarbonFootprintL3`），但需要完善实测数据接口**改进方案**:

- 完善实测能耗数据接口（`meterReading`）
- 支持溯源因子数据（`traceability`）
- 添加L3级别的审计日志记录
- 优化实测数据的验证和处理逻辑

**关键改进点**:

- 实测能耗数据格式验证
- 溯源因子数据结构定义
- L3级别的数据完整性检查
- 审计日志的详细记录

### 5. 前端显示优化

**文件**: `admin-web/src/pages/carbon/Menu.tsx`**改进方案**:

- 优化因子匹配失败时的提示信息
- 显示匹配级别（精确匹配/别名匹配/类别兜底）
- 添加因子匹配建议（如何添加缺失的因子）
- 优化L1/L3级别的显示标识

## 实施步骤

1. **修复因子匹配逻辑**（优先级：最高）

- 统一 `restaurant-menu-carbon/index.js` 中的 `matchFactor` 实现
- 添加区域代码验证
- 测试因子匹配功能

2. **修复区域代码传递**（优先级：最高）

- 确保区域代码正确传递
- 统一使用 `CN` 作为默认值
- 测试不同场景下的区域代码传递

3. **完善L1实现**（优先级：中）

- 优化基准值查询逻辑
- 添加L1级别标识
- 测试L1级别计算

4. **完善L3实现**（优先级：中）

- 完善实测数据接口
- 添加溯源因子支持
- 测试L3级别计算

5. **前端优化**（优先级：低）

- 优化显示效果
- 添加提示信息
- 测试用户体验

## 测试验证

1. **因子匹配测试**

- 测试常见食材的因子匹配（如"丝瓜"、"刀豆"）
- 测试不同区域代码下的匹配结果
- 测试匹配失败时的降级处理

2. **L1/L3级别测试**

- 测试L1级别的基准值查询和计算
- 测试L3级别的实测数据计算
- 测试不同级别之间的切换

3. **集成测试**

- 测试完整的菜单碳足迹计算流程
- 测试前端显示和交互
- 测试数据一致性

## 预期效果

1. **因子匹配成功率提升**：从当前的"未匹配"状态提升到能够匹配到类别因子（至少类别兜底）