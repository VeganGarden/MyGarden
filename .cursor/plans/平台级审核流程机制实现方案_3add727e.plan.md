---
name: 平台级审核流程机制实现方案
overview: 设计并实现一个平台级、可配置的审核流程机制，支持因子库和基准值业务场景，与现有权限、角色、消息系统深度集成。
todos:
  - id: "1"
    content: 创建审核相关数据库集合（approval_configs, approval_requests, approval_records）并添加索引
    status: completed
  - id: "2"
    content: 创建approval-manage云函数，实现审核申请创建、查询、审核操作等核心功能
    status: completed
    dependencies:
      - "1"
  - id: "3"
    content: 创建审核配置管理页面（ApprovalConfig.tsx）和审核申请管理页面（ApprovalRequest.tsx）
    status: completed
    dependencies:
      - "2"
  - id: "4"
    content: 修改carbon-factor-manage云函数，集成审核流程（创建/更新/归档操作改为提交审核申请）
    status: completed
    dependencies:
      - "2"
  - id: "5"
    content: 修改因子库前端页面（FactorAdd.tsx, FactorEdit.tsx），支持审核提交和状态展示
    status: completed
    dependencies:
      - "3"
      - "4"
  - id: "6"
    content: 修改carbon-baseline-manage云函数，集成审核流程
    status: completed
    dependencies:
      - "2"
  - id: "7"
    content: 修改基准值前端页面（BaselineAdd.tsx, BaselineEdit.tsx），支持审核提交和状态展示
    status: completed
    dependencies:
      - "3"
      - "6"
  - id: "8"
    content: 集成消息通知系统，实现审核状态变更时的消息通知
    status: completed
    dependencies:
      - "2"
  - id: "9"
    content: 添加审核超时提醒功能和数据对比展示功能
    status: completed
    dependencies:
      - "3"
      - "8"
---

# 平台级审核流程机制实现方案

## 1. 架构设计

### 1.1 核心概念

审核流程机制采用**工作流引擎 + 配置驱动**的设计模式：

- **审核配置（Approval Config）**：为每个业务场景（如因子库、基准值）定义审核流程
- **审核申请（Approval Request）**：业务操作（创建/更新/删除/归档）提交时创建审核申请
- **审核节点（Approval Node）**：审核流程中的每个审核步骤（可以是角色、用户或条件）
- **审核记录（Approval Record）**：记录每个审核节点的审核结果和意见

### 1.2 数据模型设计

#### 1.2.1 审核配置表（approval_configs）

```javascript
{
  _id: ObjectId,
  configId: string,              // 配置ID，如 "carbon_factor_create"
  businessType: string,          // 业务类型："carbon_factor" | "carbon_baseline"
  operationType: string,         // 操作类型："create" | "update" | "delete" | "archive"
  name: string,                  // 配置名称
  description: string,           // 配置描述
  flowType: string,              // 流程类型："single" | "parallel" | "sequential"
  nodes: [{                      // 审核节点列表
    nodeId: string,              // 节点ID
    nodeName: string,            // 节点名称
    nodeType: string,            // 节点类型："role" | "user" | "condition"
    approverType: string,        // 审核人类型
    approverValue: string,       // 审核人值（角色代码或用户ID）
    order: number,               // 节点顺序（顺序审核时使用）
    required: boolean,           // 是否必需
    timeout: number,             // 超时时间（小时）
    notifyOnCreate: boolean,     // 创建时是否通知
    notifyOnTimeout: boolean     // 超时时是否通知
  }],
  autoApprove: boolean,          // 是否自动通过（用于测试/开发环境）
  status: string,                // "active" | "inactive"
  createdAt: Date,
  updatedAt: Date,
  createdBy: string,
  updatedBy: string
}
```

#### 1.2.2 审核申请表（approval_requests）

```javascript
{
  _id: ObjectId,
  requestId: string,             // 申请ID（唯一标识）
  businessType: string,          // 业务类型
  businessId: string,            // 业务对象ID（如因子ID、基准值ID）
  operationType: string,         // 操作类型
  configId: string,              // 使用的审核配置ID
  title: string,                 // 申请标题
  description: string,           // 申请描述
  requestData: object,           // 申请数据（变更前后的数据对比）
  currentData: object,           // 当前数据快照
  newData: object,               // 新数据快照
  status: string,                // "pending" | "approving" | "approved" | "rejected" | "cancelled" | "expired"
  currentNodeIndex: number,      // 当前审核节点索引
  submitterId: string,           // 提交人ID
  submitterName: string,         // 提交人姓名
  submittedAt: Date,             // 提交时间
  completedAt: Date,             // 完成时间
  completedBy: string,           // 完成人（最后审核人）
  createdAt: Date,
  updatedAt: Date
}
```

#### 1.2.3 审核记录表（approval_records）

```javascript
{
  _id: ObjectId,
  requestId: string,             // 关联的申请ID
  nodeId: string,                // 审核节点ID
  nodeName: string,              // 节点名称
  approverId: string,            // 审核人ID
  approverName: string,          // 审核人姓名
  approverRole: string,          // 审核人角色
  action: string,                // "approve" | "reject" | "return" | "delegate"
  comment: string,               // 审核意见
  delegatedTo: string,           // 委托给（如果action为delegate）
  dataSnapshot: object,          // 审核时的数据快照
  reviewedAt: Date,              // 审核时间
  createdAt: Date
}
```

### 1.3 系统集成点

- **权限系统集成**：审核权限基于现有角色系统（carbon_specialist、platform_operator等）
- **消息系统集成**：审核申请创建、审核完成、超时等事件触发消息通知
- **审计系统集成**：所有审核操作记录到audit_logs

## 2. 云函数设计

### 2.1 审核管理云函数（approval-manage）

**文件位置**：`cloudfunctions/approval-manage/index.js`

**核心功能**：

- `createRequest`: 创建审核申请
- `getRequest`: 获取审核申请详情
- `listRequests`: 查询审核申请列表
- `approve`: 审核通过
- `reject`: 审核拒绝
- `return`: 退回申请
- `cancel`: 取消申请
- `getMyPendingApprovals`: 获取我的待审核列表
- `getConfig`: 获取审核配置
- `updateConfig`: 更新审核配置（管理员）

**审核流程处理逻辑**：

1. 创建申请时，根据businessType和operationType查找审核配置
2. 根据配置创建审核节点记录
3. 发送通知给第一个审核节点的审核人
4. 审核通过后，进入下一个节点（如果是顺序审核）
5. 所有节点通过后，自动执行业务操作并更新申请状态

### 2.2 业务模块集成

#### 2.2.1 因子库管理集成（carbon-factor-manage）

**修改点**：

- `createFactor`: 改为先创建审核申请，而不是直接创建
- `updateFactor`: 改为先创建审核申请
- `archiveFactor`: 改为先创建审核申请
- 新增：`executeApprovedFactorOperation`: 执行已审核通过的操作

**流程**：

1. 用户提交创建/更新/归档操作
2. 创建审核申请，保存变更数据
3. 根据审核配置通知审核人
4. 审核通过后，执行实际的数据操作

#### 2.2.2 基准值管理集成（carbon-baseline-manage）

**修改点**：与因子库管理类似

## 3. 前端实现

### 3.1 审核配置管理页面

**文件位置**：`admin-web/src/pages/system/ApprovalConfig.tsx`

**功能**：

- 审核配置列表
- 创建/编辑审核配置
- 配置审核节点（拖拽排序）
- 启用/禁用配置

### 3.2 审核申请管理页面

**文件位置**：`admin-web/src/pages/system/ApprovalRequest.tsx`

**功能**：

- 我的待审核列表
- 我提交的申请列表
- 审核历史记录
- 审核详情查看（包含数据对比）

### 3.3 审核操作组件

**文件位置**：`admin-web/src/components/ApprovalAction/index.tsx`

**功能**：

- 审核通过/拒绝/退回/委托操作
- 审核意见输入
- 数据对比展示（变更前后）

### 3.4 业务页面集成

**修改文件**：

- `admin-web/src/pages/carbon/FactorAdd.tsx` - 提交时创建审核申请
- `admin-web/src/pages/carbon/FactorEdit.tsx` - 更新时创建审核申请
- `admin-web/src/pages/carbon/BaselineAdd.tsx` - 提交时创建审核申请
- `admin-web/src/pages/carbon/BaselineEdit.tsx` - 更新时创建审核申请

**修改内容**：

- 提交按钮改为"提交审核"
- 显示审核状态标签
- 审核中时禁止编辑
- 显示审核历史记录

## 4. 消息通知集成

### 4.1 消息模板

在`cloudfunctions/message-manage`中新增审核相关消息类型：

- `approval_request_created`: 审核申请已创建（通知审核人）
- `approval_request_approved`: 审核申请已通过（通知提交人）
- `approval_request_rejected`: 审核申请已拒绝（通知提交人）
- `approval_request_returned`: 审核申请已退回（通知提交人）
- `approval_request_timeout`: 审核申请即将超时（通知审核人）

### 4.2 通知触发

在`approval-manage`云函数中，审核状态变更时调用`message-manage`发送通知。

## 5. 实施步骤

### 阶段1：基础架构搭建（2-3天）

1. 创建数据库集合（approval_configs, approval_requests, approval_records）
2. 创建approval-manage云函数基础框架
3. 创建审核配置管理页面基础结构

### 阶段2：审核流程核心功能（3-4天）

1. 实现审核申请创建逻辑
2. 实现审核节点流转逻辑
3. 实现审核操作（通过/拒绝/退回）
4. 实现数据对比功能

### 阶段3：因子库集成（2-3天）

1. 修改carbon-factor-manage，集成审核流程
2. 修改因子库前端页面，支持审核提交和状态展示
3. 测试因子库的创建/更新/归档审核流程

### 阶段4：基准值集成（2-3天）

1. 修改carbon-baseline-manage，集成审核流程
2. 修改基准值前端页面，支持审核提交和状态展示
3. 测试基准值的创建/更新/归档审核流程

### 阶段5：消息通知和优化（2天）

1. 集成消息通知系统
2. 添加审核超时提醒
3. 优化用户体验
4. 编写文档

## 6. 数据库索引设计

```javascript
// approval_configs 集合索引
{ configId: 1 }  // 唯一索引
{ businessType: 1, operationType: 1 }  // 复合索引
{ status: 1 }

// approval_requests 集合索引
{ requestId: 1 }  // 唯一索引
{ businessType: 1, businessId: 1 }  // 复合索引
{ submitterId: 1, status: 1 }  // 复合索引
{ status: 1, currentNodeIndex: 1 }  // 用于查询待审核
{ createdAt: -1 }  // 时间排序

// approval_records 集合索引
{ requestId: 1 }
{ approverId: 1, reviewedAt: -1 }  // 用于查询审核人的审核记录
```

## 7. 关键文件清单

### 后端云函数

- `cloudfunctions/approval-manage/index.js` - 审核管理云函数（新建）
- `cloudfunctions/carbon-factor-manage/index.js` - 因子库管理（修改）
- `cloudfunctions/carbon-baseline-manage/index.js` - 基准值管理（修改）

### 前端页面

- `admin-web/src/pages/system/ApprovalConfig.tsx` - 审核配置管理（新建）
- `admin-web/src/pages/system/ApprovalRequest.tsx` - 审核申请管理（新建）
- `admin-web/src/components/ApprovalAction/index.tsx` - 审核操作组件（新建）
- `admin-web/src/pages/carbon/FactorAdd.tsx` - 因子添加（修改）
- `admin-web/src/pages/carbon/FactorEdit.tsx` - 因子编辑（修改）
- `admin-web/src/pages/carbon/BaselineAdd.tsx` - 基准值添加（修改）
- `admin-web/src/pages/carbon/BaselineEdit.tsx` - 基准值编辑（修改）

### 类型定义

- `admin-web/src/types/approval.ts` - 审核相关类型定义（新建）

### API服务

- `admin-web/src/services/approval.ts` - 审核API服务（新建）