---
name: 平台基础配置-区域管理
overview: 在平台运营角色账号中增加"平台基础配置"栏目，包含两个独立的区域配置：因子区域配置（用于碳足迹因子匹配）和基准值区域配置（用于基准值计算）。
todos:
  - id: db_collection
    content: 创建 region_configs 数据库集合和索引配置
    status: pending
  - id: init_data
    content: 创建区域配置初始化脚本，包含因子区域和基准值区域的初始数据
    status: pending
    dependencies:
      - db_collection
  - id: backend_function
    content: 创建 region-config-manage 云函数，实现区域配置的CRUD操作（直接执行，无需审核）
    status: pending
    dependencies:
      - db_collection
  - id: update_carbon
    content: 更新 carbon 云函数，集成区域配置验证
    status: pending
    dependencies:
      - backend_function
  - id: update_baseline
    content: 更新 baseline 相关云函数，集成区域配置验证
    status: pending
    dependencies:
      - backend_function
  - id: frontend_page
    content: 创建区域配置管理页面（RegionConfig.tsx），支持因子区域和基准值区域的分别管理
    status: pending
    dependencies:
      - backend_function
  - id: update_routes
    content: 更新前端路由配置，添加区域配置管理路由
    status: pending
    dependencies:
      - frontend_page
  - id: update_menu
    content: 更新管理后台菜单，添加平台基础配置入口
    status: pending
    dependencies:
      - update_routes
---

# 平台基础配置

- 区域管理功能

## 功能概述

在管理后台的平台管理模块中，新增"平台基础配置"功能，包含两个独立的区域配置管理：

1. **因子区域配置**：用于碳足迹因子匹配（国家级别）
2. **基准值区域配置**：用于基准值计算（国家+子区域）

## 实现内容

### 1. 数据库设计

#### 1.1 创建区域配置集合

- **集合名称**：`region_configs`
- **数据结构**：
  ```javascript
          {
            _id: ObjectId,
            configType: 'factor_region' | 'baseline_region',  // 配置类型
            code: String,        // 区域代码（唯一）
            name: String,        // 区域名称（中文）
            nameEn: String,      // 区域名称（英文）
            country: String,     // 国家代码（ISO 3166-1 alpha-2）
            countryName: String, // 国家名称
            parentCode: String,  // 父级区域代码（用于基准值区域的层级关系）
            level: Number,       // 层级：1=国家，2=子区域
            isDefault: Boolean,  // 是否为默认区域
            status: 'active' | 'archived',
            sortOrder: Number,   // 排序顺序
            description: String,  // 描述
            createdAt: Date,
            updatedAt: Date,
            createdBy: String,
            updatedBy: String
          }
  ```




- **索引**：
- `configType + code`（唯一索引）
- `configType + country`
- `configType + status`
- `configType + parentCode`

### 2. 后端云函数

#### 2.1 创建区域配置管理云函数

- **文件路径**：`cloudfunctions/region-config-manage/index.js`
- **功能**：
- `list`: 查询区域配置列表（支持按类型、国家筛选）
- `get`: 获取单个区域配置详情
- `create`: 创建区域配置（直接执行，无需审核）
- `update`: 更新区域配置（直接执行，无需审核）
- `archive`: 归档区域配置（直接执行，无需审核）
- `activate`: 激活已归档的区域配置
- **权限控制**：仅 `platform_operator` 和 `system_admin` 可操作
- **操作审计**：所有操作记录到审计日志，但不走审核流程

#### 2.2 更新现有云函数以使用区域配置

- **carbon/index.js**：更新 `matchFactor` 函数，从区域配置中获取可用区域列表
- **carbon-baseline-query/index.js**：更新查询逻辑，验证区域代码是否有效
- **carbon-baseline-manage/index.js**：更新创建/更新逻辑，验证区域代码

### 3. 前端管理界面

#### 3.1 创建区域配置管理页面

- **文件路径**：`admin-web/src/pages/platform/RegionConfig.tsx`
- **功能**：
- 区域配置列表展示（支持按类型切换：因子区域/基准值区域）
- 创建区域配置表单
- 编辑区域配置
- 归档/激活区域配置
- 批量导入区域配置（可选）
- **UI组件**：
- 使用 Ant Design 的 Table、Form、Modal 等组件
- 支持树形结构展示（基准值区域的层级关系）

#### 3.2 更新路由配置

- **文件路径**：`admin-web/src/App.tsx`
- 添加路由：`/platform/region-config`
- 权限控制：仅 `platform_operator` 和 `system_admin` 可见

#### 3.3 更新菜单配置

- 在平台管理模块下添加"平台基础配置"菜单项
- 子菜单：因子区域配置、基准值区域配置

### 4. 初始化数据

#### 4.1 创建初始化脚本

- **文件路径**：`cloudfunctions/database/init-region-configs.js`
- **初始数据**：
- **因子区域**：中国、美国、日本、欧盟等主要国家
- **基准值区域**：中国-华北、中国-华南、中国-华东、中国-西南、中国-西北、中国-东北等

### 5. 数据验证与约束

- 区域代码必须唯一（在同一配置类型内）
- 基准值区域的 `parentCode` 必须指向有效的因子区域
- 每个国家只能有一个默认的因子区域
- 归档区域时，检查是否有依赖数据（因子、基准值），如有依赖则提示警告但允许归档
- 所有操作直接生效，无需审核流程（但会记录操作日志）

## 文件清单

### 新增文件

1. `cloudfunctions/region-config-manage/index.js` - 区域配置管理云函数
2. `cloudfunctions/region-config-manage/package.json` - 云函数依赖
3. `cloudfunctions/database/init-region-configs.js` - 初始化脚本
4. `admin-web/src/pages/platform/RegionConfig.tsx` - 区域配置管理页面
5. `admin-web/src/services/regionConfig.ts` - 区域配置API服务（可选）

### 修改文件

1. `cloudfunctions/carbon/index.js` - 更新因子匹配逻辑
2. `cloudfunctions/carbon-baseline-query/index.js` - 更新查询逻辑
3. `cloudfunctions/carbon-baseline-manage/index.js` - 更新管理逻辑
4. `cloudfunctions/database/index.js` - 添加集合初始化
5. `cloudfunctions/database/init-collections.js` - 添加集合创建
6. `cloudfunctions/database/indexes-config.json` - 添加索引配置
7. `admin-web/src/App.tsx` - 添加路由
8. `admin-web/src/layouts/MainLayout.tsx` - 更新菜单（如果菜单配置在此文件）

## 实施步骤