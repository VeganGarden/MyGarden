---
name: 代码清理和优化
overview: 全面检查今天开发的代码，消除错误、简化逻辑、避免冗余、清除测试和临时代码
todos: []
---

# 代码清理和优化计划

## 一、删除临时文件

### 1.1 删除测试和临时JSON文件

- 删除 `temp-ingredients.json`
- 删除 `temp-recipes.json`
- 删除 `temp-import-params.json`
- 删除 `temp-recipes-params.json`

这些文件是导入测试时生成的临时文件，不应提交到代码库。

## 二、修复Hook依赖问题

### 2.1 修复useIngredientCategories Hook的useEffect依赖

**文件**: `admin-web/src/hooks/useIngredientCategories.ts`**问题**: useEffect缺少fetchCategories依赖，可能导致闭包问题**修复**: 使用useCallback包装fetchCategories，或添加正确的依赖项

```typescript
// 当前代码（第60-62行）
useEffect(() => {
  fetchCategories(options?.refresh)
}, [options?.status, options?.refresh])

// 需要修复为
const fetchCategories = useCallback(async (forceRefresh = false) => {
  // ... 现有逻辑
}, [options?.status])

useEffect(() => {
  fetchCategories(options?.refresh)
}, [fetchCategories, options?.refresh])
```



## 三、统一类别工具模块

### 3.1 检查category-utils.js的一致性

**文件位置**:

- `cloudfunctions/carbon/category-utils.js`
- `cloudfunctions/database/category-utils.js`
- `cloudfunctions/restaurant-menu-carbon/category-utils.js`
- `cloudfunctions/ingredient-standard-manage/category-utils.js`

**问题**: 4个文件内容完全相同，存在代码重复**解决方案**:

- 由于云函数部署时每个函数是独立的，无法共享common目录
- 但可以将硬编码的categoryMap提取到category-utils.js中作为fallback函数
- 确保所有文件中的硬编码映射逻辑一致

### 3.2 提取硬编码映射到category-utils.js

**问题**: 多个文件中有重复的硬编码categoryMap（约10行相同代码）**涉及文件**:

- `cloudfunctions/database/migrate-factors-integration.js` (第79-90行)
- `cloudfunctions/database/init-factors-from-existing-ingredients.js` (第67-78行)
- `cloudfunctions/restaurant-menu-carbon/index.js` (第1497-1508行)
- `cloudfunctions/database/verify-factors-migration.js` (第72-83行)

**解决方案**:在每个category-utils.js中添加`getFallbackCategoryMap()`函数，然后在各个文件中调用：

```javascript
// 在category-utils.js中添加
function getFallbackCategoryMap() {
  return {
    vegetables: 'vegetable',
    beans: 'bean_product',
    grains: 'grain',
    fruits: 'fruit',
    nuts: 'nut',
    mushrooms: 'mushroom',
    seafood: 'seafood',
    dairy: 'dairy',
    spices: 'spice',
    others: 'other'
  };
}

// 在各个文件中替换硬编码
const categoryMap = categoryUtils?.getFallbackCategoryMap() || {
  // ... 保留作为最后fallback
}
```



## 四、清理调试代码

### 4.1 移除或优化console.log语句

**文件**: `cloudfunctions/ingredient-standard-manage/index.js`**问题**: 第27-29行有调试用的console.log**解决方案**:

- 保留关键操作的日志（如错误日志）
- 移除详细的调试日志，或改为仅在开发环境输出
- 考虑使用日志级别控制

### 4.2 检查其他console语句

大部分console.error是合理的错误日志，应保留。但需要确认是否有调试用的console.log需要移除。

## 五、简化逻辑

### 5.1 简化categoryUtils的引入逻辑

**问题**: 多个文件中有相同的try-catch引入逻辑（约5行）**涉及文件**:

- `cloudfunctions/database/init-factors-from-existing-ingredients.js` (第46-51行)
- `cloudfunctions/database/migrate-factors-integration.js` (第60-65行)
- `cloudfunctions/database/verify-factors-migration.js` (第53-58行)
- `cloudfunctions/restaurant-menu-carbon/index.js` (第1475-1481行)

**解决方案**:由于每个云函数目录结构不同，无法完全统一，但可以：

- 确保错误处理逻辑一致
- 统一错误消息格式

### 5.2 优化useCategoryOptions的includeAll逻辑

**文件**: `admin-web/src/hooks/useIngredientCategories.ts`**问题**: 第86-88行使用unshift修改数组，可能不是最佳实践**解决方案**:

```typescript
// 当前
if (options?.includeAll) {
  categoryOptions.unshift({ label: '全部', value: 'all' })
}

// 优化为
const categoryOptions = options?.includeAll 
  ? [{ label: '全部', value: 'all' }, ...categories.map(...)]
  : categories.map(...)
```



## 六、验证业务代码

### 6.1 确认testimony字段

**文件**:

- `admin-web/src/pages/base/IngredientEdit.tsx` (第358行)
- `admin-web/src/pages/base/RecipeEdit.tsx` (第683行)

**问题**: 这些字段看起来是业务功能（认证证言），需要确认是否应该保留**解决方案**: 如果是业务功能则保留，如果是测试代码则删除

## 七、代码质量检查

### 7.1 检查未使用的导入

检查所有修改的文件是否有未使用的import语句

### 7.2 检查类型定义

确保所有TypeScript类型定义完整且正确

### 7.3 检查错误处理

确保所有异步操作都有适当的错误处理

## 实施顺序

1. 删除临时文件（最简单，无风险）
2. 修复Hook依赖问题（重要，可能影响功能）
3. 提取硬编码映射到category-utils.js（减少重复）
4. 清理调试代码（代码整洁）
5. 简化逻辑（代码优化）
6. 验证业务代码（确认功能）
7. 最终代码质量检查（全面验证）

## 注意事项

1. **云函数独立性**: 由于云函数部署时每个函数是独立的包，无法真正共享common目录，所以category-utils.js需要在每个函数中复制。但应确保它们保持一致。
2. **向后兼容**: 所有修改都要确保向后兼容，不能破坏现有功能。
3. **测试验证**: 修改后需要验证：

- 前端页面类别显示和选择功能