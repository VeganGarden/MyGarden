---
name: 食材规范库建设方案最终修订
overview: 对食材规范库建设方案进行全面检查和修订，修复阶段编号重复、更新前端集成状态、明确action路由机制，确保方案完整性和准确性。
todos: []
---

# 食材规范库建设方

案 - 最终修订版

## 检查发现的问题

### 1. 阶段编号错误

- 问题：存在两个"阶段七"（更新查询和匹配逻辑、管理工具）
- 修复：将第二个"阶段七"改为"阶段八"

### 2. 前端集成状态更新

- 问题：前端管理页面已实现，但plan中仍标记为"可选"
- 修复：更新为"已完成"，并添加前端实现说明

### 3. Action路由机制说明

- 问题：需要明确说明action在database/index.js中的路由方式
- 修复：在阶段六和阶段八中添加详细的action路由说明

### 4. 缺少前端实现细节

- 问题：plan中没有详细说明前端已实现的功能
- 修复：在阶段九中补充前端实现细节

## 修订内容

### 修订1：修复阶段编号

将"阶段七：管理工具"改为"阶段八：管理工具"

### 修订2：明确Action路由机制

在`cloudfunctions/database/index.js`中需要添加以下路由：

```javascript
case 'manageIngredientStandards':
  const { main: manageIngredientStandards } = require('./manage-ingredient-standards');
  return await manageIngredientStandards(event);

case 'syncStandardAliasesToFactors':
  const { main: syncStandardAliasesToFactors } = require('./sync-standard-aliases-to-factors');
  return await syncStandardAliasesToFactors(event);

case 'syncStandardNameToIngredients':
  const { main: syncStandardNameToIngredients } = require('./sync-standard-name-to-ingredients');
  return await syncStandardNameToIngredients(event);
```

在`manage-ingredient-standards.js`中，需要根据`event.subAction`来路由到具体的操作：

```javascript
exports.main = async (event) => {
  const { subAction } = event;
  
  switch (subAction) {
    case 'listStandards':
      return await listStandards(event);
    case 'getStandard':
      return await getStandard(event);
    case 'addStandard':
      return await addStandard(event);
    case 'updateStandard':
      return await updateStandard(event);
    case 'deprecateStandard':
      return await deprecateStandard(event);
    case 'mergeStandards':
      return await mergeStandards(event);
    case 'listAliases':
      return await listAliases(event);
    case 'addAlias':
      return await addAlias(event);
    case 'removeAlias':
      return await removeAlias(event);
    case 'batchAddAliases':
      return await batchAddAliases(event);
    default:
      return { code: 400, message: 'Unknown subAction' };
  }
};
```



### 修订3：更新阶段九内容

阶段九应更新为"前端管理界面（已完成）"，并说明：**已实现的前端功能**：

1. **标准名称管理页面** (`admin-web/src/pages/base/StandardList.tsx`)

- 列表展示：支持搜索、分类筛选、状态筛选
- 批量操作：同步到因子库、同步到ingredients库
- CRUD操作：新建、编辑、废弃标准名称

2. **标准名称详情/编辑页面** (`admin-web/src/pages/base/StandardDetail.tsx`)

- 基本信息编辑：标准名称、英文名称、分类、单位、碳系数等
- 标签页设计：基本信息、别名管理

3. **别名管理组件** (`admin-web/src/pages/base/components/AliasManagement.tsx`)

- 别名列表展示
- 添加别名（单个/批量）
- 删除别名

4. **Service API** (`admin-web/src/services/ingredientStandard.ts`)

- 完整的API封装，调用database云函数
- 使用action: `manageIngredientStandards`和subAction进行路由

5. **路由和权限** (`admin-web/src/App.tsx`, `admin-web/src/layouts/MainLayout.tsx`)

- 路由配置：使用RouteGuard限制只有platform_operator可访问
- 菜单集成：在"基础数据管理"菜单下添加"食材标准库"菜单项

### 修订4：添加索引设计说明

在阶段一中需要明确说明需要在数据库控制台手动创建的索引：**ingredient_standards集合索引**：

- `standardName_unique`: standardName (唯一索引)
- `category_index`: category
- `status_index`: status

**ingredient_aliases集合索引**：

- `alias_standardName_index`: alias, standardName (复合索引)
- `standardName_index`: standardName
- `alias_index`: alias (用于反向查找)

**ingredients集合新增索引**：

- `standardName_index`: standardName (用于按标准名称查询)
- `isStandardized_index`: isStandardized (用于筛选已标准化数据)

### 修订5：完善依赖关系

更新todos中的依赖关系，确保实施顺序正确：

```yaml
todos:
    - id: init-collections
    content: 创建ingredient_standards和ingredient_aliases集合，包括索引定义
    status: pending
  
    - id: migrate-fields
    content: 为ingredients集合添加standardName, alias, isStandardized等字段
    status: pending
    dependencies:
            - init-collections
  
    - id: standardizer-module
    content: 创建ingredient-standardizer.js标准化服务模块
    status: pending
    dependencies:
            - init-collections
  
    - id: init-standards-data
    content: 初始化规范库数据
    status: pending
    dependencies:
            - standardizer-module
            - migrate-fields
  
    - id: update-import-flow
    content: 更新import-ingredients-from-list.js
    status: pending
    dependencies:
            - standardizer-module
  
    - id: batch-standardize
    content: 批量标准化现有ingredients数据
    status: pending
    dependencies:
            - migrate-fields
            - standardizer-module
            - init-standards-data
  
    - id: sync-to-factors
    content: 创建同步机制到因子库
    status: pending
    dependencies:
            - standardizer-module
            - init-standards-data
  
    - id: sync-to-ingredients
    content: 创建同步机制到ingredients库
    status: pending
    dependencies:
            - standardizer-module
            - init-standards-data
  
    - id: update-carbon-matching
    content: 更新carbon/index.js中的matchFactor函数
    status: pending
    dependencies:
            - standardizer-module
            - sync-to-factors
  
    - id: management-tools
    content: 创建manage-ingredient-standards.js管理工具
    status: pending
    dependencies:
            - init-standards-data
            - sync-to-factors
            - sync-to-ingredients
  
    - id: frontend-integration
    content: 前端管理界面（已完成）
    status: completed
```



## 实施检查清单

### 阶段一：数据结构准备

- [ ] 创建ingredient_standards集合
- [ ] 创建ingredient_aliases集合
- [ ] 在控制台创建所有索引
- [ ] 为ingredients集合添加新字段

### 阶段二：标准化服务模块

- [ ] 创建ingredient-standardizer.js
- [ ] 实现standardizeIngredientName函数
- [ ] 实现findStandardName和findAliases函数
- [ ] 实现matchIngredient函数

### 阶段三：初始化规范库数据

- [ ] 创建init-ingredient-standards-data.js
- [ ] 从现有ingredients提取标准名称
- [ ] 生成初始别名映射

### 阶段四：更新导入流程

- [ ] 修改import-ingredients-from-list.js
- [ ] 集成标准化服务
- [ ] 测试导入功能

### 阶段五：批量标准化

- [ ] 创建migrate-standardize-existing-ingredients.js
- [ ] 批量标准化现有数据
- [ ] 验证数据一致性

### 阶段六：同步机制

- [ ] 实现syncAliasesToFactors函数
- [ ] 实现syncStandardNameToIngredients函数
- [ ] 创建sync-standard-aliases-to-factors.js
- [ ] 创建sync-standard-name-to-ingredients.js
- [ ] 在manage-ingredient-standards.js中集成同步调用

### 阶段七：更新匹配逻辑

- [ ] 修改carbon/index.js的matchFactor函数
- [ ] 添加标准化名称匹配逻辑
- [ ] 保持向后兼容

### 阶段八：管理工具

- [ ] 创建manage-ingredient-standards.js
- [ ] 实现所有CRUD操作
- [ ] 在database/index.js中添加路由
- [ ] 测试所有功能

### 阶段九：前端集成

- [x] 标准名称列表页面（已完成）
- [x] 标准名称详情/编辑页面（已完成）
- [x] 别名管理组件（已完成）
- [x] Service API（已完成）
- [x] 路由和权限配置（已完成）

## 注意事项

1. **索引创建**：腾讯云开发MongoDB不支持代码创建索引，需要在控制台手动创建
2. **向后兼容**：所有新功能必须保持向后兼容，不能影响现有功能