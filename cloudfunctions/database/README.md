# æ•°æ®åº“åˆå§‹åŒ–äº‘å‡½æ•°

## âš ï¸ é‡è¦æ›´æ–°ï¼ˆv1.1ï¼‰

**ä¿®å¤è¯´æ˜**: è…¾è®¯äº‘å¼€å‘çš„ MongoDB ä¸æ”¯æŒé€šè¿‡ä»£ç åˆ›å»ºç´¢å¼•ï¼Œå› æ­¤ï¼š

- âœ… äº‘å‡½æ•°åªåˆ›å»º 12 ä¸ªé›†åˆ
- âŒ ç´¢å¼•éœ€è¦åœ¨æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºï¼ˆå…± 28 ä¸ªï¼‰
- ğŸ“– è¯·å‚è€ƒ [æ•°æ®åº“ç´¢å¼•åˆ›å»ºæ‰‹å†Œ.md](../../Docs/æ•°æ®åº“ç´¢å¼•åˆ›å»ºæ‰‹å†Œ.md)

## åŠŸèƒ½è¯´æ˜

è¿™ä¸ªäº‘å‡½æ•°ç”¨äºåˆå§‹åŒ–"æˆ‘çš„èŠ±å›­"é¡¹ç›®çš„æ•°æ®åº“ï¼Œåˆ›å»º 12 ä¸ªæ ¸å¿ƒé›†åˆã€‚

## é›†åˆåˆ—è¡¨

| åºå·     | é›†åˆå           | è¯´æ˜       | ç´¢å¼•æ•°        |
| -------- | ---------------- | ---------- | ------------- |
| 1        | users            | ç”¨æˆ·ä¸»è¡¨   | 3             |
| 2        | user_sessions    | ä¼šè¯è¡¨     | 3             |
| 3        | meals            | é¤é£Ÿè®°å½•è¡¨ | 4             |
| 4        | daily_stats      | æ¯æ—¥ç»Ÿè®¡è¡¨ | 3             |
| 5        | gardens          | èŠ±å›­è¡¨     | 1             |
| 6        | ingredients      | é£Ÿæåº“     | 3             |
| 7        | recipes          | é£Ÿè°±åº“     | 2             |
| 8        | sync_tasks       | åŒæ­¥ä»»åŠ¡è¡¨ | 4             |
| 9        | platform_configs | å¹³å°é…ç½®è¡¨ | 1             |
| 10       | friends          | å¥½å‹å…³ç³»è¡¨ | 2             |
| 11       | posts            | åŠ¨æ€è¡¨     | 2             |
| 12       | orders           | è®¢å•è¡¨     | 2             |
| **æ€»è®¡** | **12 ä¸ªé›†åˆ**    |            | **28 ä¸ªç´¢å¼•** |

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: äº‘å¼€å‘æ§åˆ¶å°éƒ¨ç½²

1. éƒ¨ç½²äº‘å‡½æ•°åˆ°è…¾è®¯äº‘ï¼š

```bash
cd cloudfunctions/database
tcb fn deploy database --env your-env-id
```

2. åœ¨äº‘å¼€å‘æ§åˆ¶å°è°ƒç”¨ï¼š
   - æ‰“å¼€è…¾è®¯äº‘å¼€å‘æ§åˆ¶å°
   - è¿›å…¥äº‘å‡½æ•°ç®¡ç†
   - æ‰¾åˆ°`database`å‡½æ•°
   - ç‚¹å‡»"æµ‹è¯•"ï¼Œè¾“å…¥ç©ºå¯¹è±¡ `{}`
   - ç‚¹å‡»"è¿è¡Œæµ‹è¯•"

### æ–¹æ³• 2: å‘½ä»¤è¡Œç›´æ¥è°ƒç”¨

```bash
# å®‰è£…ä¾èµ–
npm install

# è°ƒç”¨äº‘å‡½æ•°
tcb fn invoke database -e your-env-id
```

### æ–¹æ³• 3: ä½¿ç”¨å°ç¨‹åºç«¯è°ƒç”¨

```javascript
// åœ¨å°ç¨‹åºä¸­è°ƒç”¨
wx.cloud
  .callFunction({
    name: "database",
    data: {},
  })
  .then((res) => {
    console.log("æ•°æ®åº“åˆå§‹åŒ–ç»“æœ:", res.result);
  })
  .catch((err) => {
    console.error("åˆå§‹åŒ–å¤±è´¥:", err);
  });
```

## è¿”å›æ ¼å¼

### æˆåŠŸå“åº”

```json
{
  "code": 0,
  "message": "æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ",
  "summary": {
    "totalCollections": 12,
    "totalIndexes": 28,
    "collections": [
      { "collection": "users", "status": "success" },
      { "collection": "user_sessions", "status": "success" },
      ...
    ]
  }
}
```

### å¤±è´¥å“åº”

```json
{
  "code": 500,
  "message": "æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥",
  "error": "é”™è¯¯è¯¦æƒ…",
  "results": [...]
}
```

## æ³¨æ„äº‹é¡¹

1. **å¹‚ç­‰æ€§**: è„šæœ¬å¯ä»¥é‡å¤æ‰§è¡Œï¼Œå¦‚æœé›†åˆå·²å­˜åœ¨ä¼šè‡ªåŠ¨è·³è¿‡
2. **ç´¢å¼•å†²çª**: å¦‚æœç´¢å¼•å·²å­˜åœ¨ï¼Œå¯èƒ½ä¼šæŠ¥é”™ä½†ä¸å½±å“å…¶ä»–ç´¢å¼•åˆ›å»º
3. **æƒé™è¦æ±‚**: éœ€è¦æ•°æ®åº“ç®¡ç†æƒé™
4. **æ‰§è¡Œæ—¶é—´**: é¦–æ¬¡æ‰§è¡Œçº¦éœ€è¦ 10-30 ç§’
5. **æ•°æ®ä¿æŠ¤**: ä¸ä¼šåˆ é™¤å·²å­˜åœ¨çš„æ•°æ®

## ç´¢å¼•è¯¦æƒ…

### é«˜é¢‘æŸ¥è¯¢ç´¢å¼•ï¼ˆé‡ç‚¹ä¼˜åŒ–ï¼‰

- `meals.userId_mealDate_index`: ä¸ªäººé¤é£Ÿè®°å½•æŸ¥è¯¢ï¼ˆæœ€é«˜é¢‘ï¼‰
- `users.openId_unique`: ç”¨æˆ·ç™»å½•æŸ¥è¯¢
- `gardens.userId_unique`: ä¸ªäººèŠ±å›­æŸ¥è¯¢

### é˜²é‡å¤ç´¢å¼•

- `meals.userId_source_orderId_unique`: é˜²æ­¢ç¬¬ä¸‰æ–¹è®¢å•é‡å¤åŒæ­¥
- `sync_tasks.platform_orderId_unique`: é˜²æ­¢åŒæ­¥ä»»åŠ¡é‡å¤
- `friends.userId_friendId_unique`: é˜²æ­¢å¥½å‹å…³ç³»é‡å¤

### TTL è‡ªåŠ¨æ¸…ç†ç´¢å¼•

- `user_sessions.expiresAt_ttl`: è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- `sync_tasks.createdAt_ttl`: 30 å¤©åè‡ªåŠ¨æ¸…ç†åŒæ­¥ä»»åŠ¡

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é›†åˆå·²å­˜åœ¨é”™è¯¯

**åŸå› **: é›†åˆä¹‹å‰å·²ç»åˆ›å»ºè¿‡
**è§£å†³**: æ­£å¸¸æƒ…å†µï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡å¹¶ç»§ç»­åˆ›å»ºç´¢å¼•

### é—®é¢˜ 2: ç´¢å¼•åˆ›å»ºå¤±è´¥

**åŸå› **: å¯èƒ½æ•°æ®æ ¼å¼ä¸ç¬¦åˆç´¢å¼•è¦æ±‚
**è§£å†³**:

1. æ£€æŸ¥ç°æœ‰æ•°æ®æ˜¯å¦ç¬¦åˆç´¢å¼•çº¦æŸ
2. æ‰‹åŠ¨åˆ é™¤å†²çªæ•°æ®æˆ–ç´¢å¼•
3. é‡æ–°è¿è¡Œè„šæœ¬

### é—®é¢˜ 3: æƒé™ä¸è¶³

**åŸå› **: äº‘å‡½æ•°æ²¡æœ‰æ•°æ®åº“ç®¡ç†æƒé™
**è§£å†³**: åœ¨äº‘å¼€å‘æ§åˆ¶å°æ£€æŸ¥å‡½æ•°æƒé™é…ç½®

## éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥é›†åˆæ˜¯å¦åˆ›å»ºæˆåŠŸ

```javascript
// åœ¨äº‘å‡½æ•°æˆ–å°ç¨‹åºä¸­æ‰§è¡Œ
const db = cloud.database();
const collections = await db.listCollections();
console.log("å·²åˆ›å»ºçš„é›†åˆ:", collections);
```

### 2. æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»ºæˆåŠŸ

```javascript
// åœ¨MongoDB shellæˆ–äº‘å¼€å‘æ§åˆ¶å°æ‰§è¡Œ
db.users.getIndexes();
db.meals.getIndexes();
// ... æ£€æŸ¥å…¶ä»–é›†åˆ
```

### 3. æµ‹è¯•æŸ¥è¯¢æ€§èƒ½

```javascript
// æµ‹è¯•é«˜é¢‘æŸ¥è¯¢
const startTime = Date.now();
const meals = await db
  .collection("meals")
  .where({ userId: "test-user-id" })
  .orderBy("mealDate", "desc")
  .limit(10)
  .get();
const duration = Date.now() - startTime;
console.log("æŸ¥è¯¢è€—æ—¶:", duration, "ms"); // åº”è¯¥ <50ms
```

## ä¸‹ä¸€æ­¥

æ•°æ®åº“åˆå§‹åŒ–å®Œæˆåï¼Œæ‚¨å¯ä»¥ï¼š

1. âœ… éƒ¨ç½²å…¶ä»–äº‘å‡½æ•°ï¼ˆlogin, user, garden, carbon ç­‰ï¼‰
2. âœ… å¯¼å…¥åˆå§‹é£Ÿææ•°æ®åˆ° ingredients é›†åˆ
3. âœ… é…ç½®ç¬¬ä¸‰æ–¹å¹³å°æ˜ å°„ï¼ˆplatform_configsï¼‰
4. âœ… å¼€å§‹å‰ç«¯å¼€å‘å’Œæµ‹è¯•

## ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“æ¶æ„è®¾è®¡æ–‡æ¡£](../../Docs/æ•°æ®åº“æ¶æ„è®¾è®¡æ–‡æ¡£-ç®€åŒ–ç‰ˆ.md)
- [è…¾è®¯äº‘å¼€å‘ç¯å¢ƒé…ç½®æŒ‡å—](../../Docs/è…¾è®¯äº‘å¼€å‘ç¯å¢ƒé…ç½®æŒ‡å—.md)

## ç»´æŠ¤è®°å½•

- **v1.0.0** (2025-01-11): åˆå§‹ç‰ˆæœ¬ï¼Œ12 ä¸ªé›†åˆï¼Œ28 ä¸ªç´¢å¼•
