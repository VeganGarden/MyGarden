# 中文字体打包说明

## 重要说明

### 1. 字体文件需要打包到云函数中

**是的，中文字体文件需要打包到云函数部署包中。**

原因：

- PDF 证书是在**服务器端（云函数）**生成的
- 字体文件必须在云函数运行时环境中可用
- 字体文件会随云函数代码一起部署到云端

### 2. 用户不需要下载字体

**用户完全不需要下载或安装任何字体文件。**

原因：

- PDF 生成过程在服务器端完成
- 用户只是下载已经生成好的 PDF 文件
- PDF 文件中已经嵌入了字体信息（如果使用了自定义字体）

## 当前状态

### 字体文件位置

```
cloudfunctions/restaurant-certification/fonts/
├── SourceHanSansCN-Regular.otf  (1.1MB) - 当前只有OTF格式
├── README.md
└── download-font.sh
```

### 问题

- 当前只有 `.otf` 格式的字体文件
- PDFKit 不支持 `.otf` 格式（会报错 "Not a CFF Font"）
- 需要 `.ttf` 格式的字体文件

### 解决方案

#### 方案 1：下载 TTF 格式字体（推荐）

1. **从 GitHub 下载 TTF 格式字体**

   - 访问：https://github.com/adobe-fonts/source-han-sans/releases
   - 下载 `SourceHanSansCN-Regular.ttf` 文件
   - 放置到 `cloudfunctions/restaurant-certification/fonts/` 目录

2. **或者使用其他中文字体**
   - 文泉驿正黑体（WenQuanYi Zen Hei）
   - 思源黑体的 TTF 版本
   - 其他支持中文的 TTF 字体

#### 方案 2：转换 OTF 为 TTF

使用字体转换工具将 `.otf` 转换为 `.ttf`：

```bash
# 使用 fonttools (需要安装)
pip install fonttools
ttx -o SourceHanSansCN-Regular.ttf SourceHanSansCN-Regular.otf
```

#### 方案 3：暂时使用默认字体

- 当前代码已支持字体加载失败时使用默认字体
- 证书可以正常生成，但中文会显示为乱码
- 可以后续再添加 TTF 字体文件

## 部署说明

### 字体文件会被自动打包

使用 `tcb fn deploy` 命令部署时：

- 云函数目录下的所有文件（除了 `node_modules`）都会被打包
- `fonts/` 目录和其中的字体文件会被包含在部署包中
- 字体文件会随云函数一起上传到云端

### 验证字体是否已打包

部署后，查看云函数日志：

- 如果看到 "中文字体加载成功"，说明字体已正确打包
- 如果看到 "中文字体文件未找到"，说明字体文件未找到或路径不正确

## 文件大小考虑

- 当前 OTF 字体文件：约 1.1MB
- TTF 字体文件通常更小：约 500KB-1MB
- 云函数部署包大小限制：通常为 50MB
- 字体文件大小在可接受范围内

## 下一步

1. ✅ 证书生成功能已实现（使用新模板）
2. ⏳ 需要添加 TTF 格式的中文字体文件
3. ⏳ 重新部署云函数
4. ⏳ 测试证书生成，确认中文正常显示
