# SPA 路由 403/404 错误修复指南

## 问题现象

首次访问网站时出现 403 Forbidden 错误，Key 显示为 "index.htmllogin"（路径拼接错误）。重新输入地址后可以正常访问。

## 问题原因

这是一个典型的 SPA (Single Page Application) 路由配置问题。当用户直接访问路由路径（如 `/login`）时：

1. 服务器上不存在 `/login` 这个物理文件
2. 如果腾讯云静态网站托管没有正确配置错误页面重定向，会返回 404/403 错误
3. 404.html 的重定向逻辑可能导致路径拼接错误

## 解决方案

### 方法一：在腾讯云控制台配置错误页面重定向（推荐，必须配置）

这是**必须**的配置步骤，否则 SPA 路由无法正常工作。

#### 配置步骤：

1. 登录 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 选择环境：`my-garden-app-env-4e0h762923be2f`
3. 点击左侧菜单「静态网站托管」
4. 点击「基础配置」标签
5. 找到「错误页面」配置区域
6. 点击「添加规则」或「配置错误页面」
7. 配置如下：
   - **错误码**：`404`
   - **响应码**：`200`（重要：返回200而不是404，这样浏览器URL保持不变）
   - **响应页面**：`/index.html`
8. 点击「保存」
9. 等待几分钟让配置生效

#### 配置原理：

配置后，当用户访问 `/login` 时：
- 服务器检测到该路径不存在（404错误）
- 服务器返回 `index.html` 的内容，但HTTP状态码是200（不是404）
- 浏览器中的URL仍然是 `/login`（保持不变）
- React Router 读取浏览器URL，正确路由到登录页面

### 方法二：使用 CloudBase CLI 配置（如果支持）

```bash
# 尝试使用 CLI 配置（需要 CloudBase CLI 2.x+）
tcb hosting:config set -e my-garden-app-env-4e0h762923be2f \
  --error-page 404:200:/index.html
```

注意：不是所有版本的 CLI 都支持此命令，建议优先使用控制台配置。

### 方法三：检查部署配置

确保部署时包含了 `404.html` 文件：

```bash
# 部署脚本中应该包含：
cp public/404.html dist/404.html
```

## 验证配置

配置完成后，测试以下场景：

1. ✅ **访问根路径**：`https://my-garden-app-env-4e0h762923be2f.tcloudbaseapp.com/`
   - 应该正常显示首页

2. ✅ **直接访问路由**：`https://my-garden-app-env-4e0h762923be2f.tcloudbaseapp.com/login`
   - 应该正常显示登录页面，而不是 404/403 错误

3. ✅ **刷新页面**：在 `/dashboard` 等路由页面刷新
   - 应该正常显示当前页面，而不是跳转到首页

4. ✅ **静态资源**：访问 `/assets/*` 或 `/static/*`
   - 应该正常加载资源文件

## 注意事项

1. **配置生效时间**：控制台配置后，可能需要等待 2-5 分钟才能生效

2. **清除浏览器缓存**：配置生效后，建议清除浏览器缓存再测试

3. **404.html 的作用**：404.html 只是一个**备选方案**，主要依赖控制台配置。如果控制台已正确配置，404.html 可能不会被使用

4. **静态资源**：确保静态资源路径（如 `/assets/`）不会被重定向到 index.html，否则会导致资源加载失败

## 当前状态检查

如果仍然遇到 403/404 错误：

1. ✅ 检查控制台是否已配置错误页面重定向
2. ✅ 等待配置生效（2-5分钟）
3. ✅ 清除浏览器缓存
4. ✅ 检查网络请求，查看实际返回的状态码和内容

## 常见问题

### Q: 为什么会出现 "index.htmllogin" 这样的路径拼接错误？

A: 这是因为 404.html 中的重定向逻辑在某些情况下会将路径错误拼接。现在已经优化了 404.html 的逻辑，但更重要的是要在控制台正确配置错误页面重定向。

### Q: 配置后仍然出现 403 错误？

A: 403 错误通常表示权限问题。检查：
- 静态网站托管是否已启用
- 文件的访问权限是否正确
- 是否配置了访问控制策略

### Q: 配置后首次访问仍然有问题？

A: 可能是 CDN 缓存问题。尝试：
- 等待更长时间（5-10分钟）
- 使用无痕模式访问
- 清除 CDN 缓存（如果有权限）

## 总结

**关键步骤**：必须在腾讯云控制台配置错误页面重定向（404 → 200 → /index.html），这是解决 SPA 路由问题的核心配置。

