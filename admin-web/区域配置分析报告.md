# 因子库与基准值区域配置分析报告

## 当前配置对比

### 因子库管理中的"区域"（Region）

**用途**：用于食材碳排放因子的精确区域匹配

**可选值**：

- `CN` - 中国 (CN)
- `CN-East` - 华东 (CN-East)
- `CN-North` - 华北 (CN-North)
- `CN-South` - 华南 (CN-South)
- `CN-West` - 西部 (CN-West)
- `Global` - 全球 (Global)

**特点**：

- 更通用，支持国际标准
- 格式：国家代码 + 方向（如 CN-East）
- 用于因子库查询时的精确匹配

### 基准值管理中的"地区"（Region）

**用途**：用于定义餐厅碳足迹基准值

**可选值**：

- `north_china` - 华北区域
- `northeast` - 东北区域
- `east_china` - 华东区域
- `central_china` - 华中区域
- `northwest` - 西北区域
- `south_china` - 南方区域
- `national_average` - 全国平均

**特点**：

- 更细分，只针对中国地区
- 格式：下划线命名（如 north_china）
- 用于基准值查询和餐厅配置

## 问题分析

### 1. 格式不一致

- 因子库：`CN-East`, `CN-North` 等
- 基准值：`east_china`, `north_china` 等

### 2. 使用场景不同

- **因子库区域**：用于食材级别的精确匹配，支持多级匹配（精确区域 -> 国家级 -> 别名 -> 类别）
- **基准值地区**：用于餐厅级别的基准定义，与餐食类型、用能方式组合

### 3. 潜在问题

在 `restaurant-menu-carbon` 云函数中：

- `restaurantRegion` 可能来自餐厅配置（基准值格式：`north_china`）
- 但 `matchFactor` 函数期望因子库格式（`CN-East`）
- **这会导致区域匹配失败，只能降级到国家级匹配（CN）**

## 建议方案

### 方案一：统一配置（推荐）⭐

**优点**：

- 消除格式不一致问题
- 简化系统复杂度
- 提高匹配准确性
- 便于维护和理解

**实施步骤**：

1. 统一使用基准值的地区格式（`north_china`, `east_china` 等）
2. 在因子库中添加区域映射逻辑，将因子库的 `CN-East` 等映射到 `east_china`
3. 更新因子库管理界面，使用统一的地区选项
4. 建立数据迁移脚本，将现有因子库数据中的区域值转换

**影响范围**：

- 因子库管理界面
- 因子库数据迁移
- 因子匹配逻辑（需要添加映射）

### 方案二：建立映射关系（保守）

**优点**：

- 不需要修改现有数据
- 向后兼容
- 实施成本低

**实施步骤**：

1. 在 `matchFactor` 函数中添加区域映射逻辑
2. 将基准值格式（`north_china`）映射到因子库格式（`CN-East`）
3. 保持两个配置独立，但建立映射关系

**影响范围**：

- 因子匹配逻辑（添加映射函数）

### 方案三：保持现状（不推荐）

**缺点**：

- 区域匹配可能失败
- 系统复杂度高
- 维护困难
- 用户体验差

## 推荐方案：方案一（统一配置）

### 理由

1. **业务逻辑一致性**：因子库和基准值都是用于碳足迹计算，应该使用统一的区域划分
2. **匹配准确性**：统一后可以确保区域匹配的准确性
3. **用户体验**：用户不需要理解两套不同的区域体系
4. **长期维护**：统一的配置更易于维护和扩展

### 实施建议

1. 统一使用基准值的地区格式（更细分，更适合中国场景）
2. 因子库中的 `CN-East` 等格式映射到 `east_china` 等
3. 保留 `CN` 作为国家级匹配的兜底
4. 保留 `Global` 用于国际因子（可选）

## 区域映射关系

| 因子库格式 | 基准值格式       | 说明                     |
| ---------- | ---------------- | ------------------------ |
| CN         | national_average | 全国/国家级              |
| CN-East    | east_china       | 华东区域                 |
| CN-North   | north_china      | 华北区域                 |
| CN-South   | south_china      | 华南区域                 |
| CN-West    | northwest        | 西部区域（需确认）       |
| -          | northeast        | 东北区域（因子库无对应） |
| -          | central_china    | 华中区域（因子库无对应） |
| Global     | -                | 全球（仅因子库）         |

## 结论

**建议统一配置**，使用基准值的地区格式作为标准，原因：

1. 更符合中国业务场景
2. 区域划分更细致
3. 与餐厅配置保持一致
4. 提高匹配准确性
